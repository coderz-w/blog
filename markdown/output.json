{
  "postDataMap": {
    "first": {
      "authors": [
        "zhw"
      ],
      "title": "å»ºç«™",
      "tag": "ç”Ÿæ´»",
      "path": "first",
      "rawFilePath": "./first.md",
      "coverImage": "https://upload-bbs.miyoushe.com/upload/2024/07/27/75276539/98580c852764d70e5a9597aa7678f131_2245446554692880272.jpg",
      "text": "è®°å½•ä¸€ä¸‹å»ºç«™çš„ç¬¬ä¸€å¤©,ä¹Ÿè®¸å¼€å¿ƒåˆ°çˆ†ç‚¸.\r\n![å»ºç«™å›¾ç‰‡](https://upload-bbs.miyoushe.com/upload/2024/07/27/75276539/98580c852764d70e5a9597aa7678f131_2245446554692880272.jpg)\r\n![å»ºç«™å›¾ç‰‡](https://upload-bbs.miyoushe.com/upload/2024/03/20/285532152/757fa74f8b38fdfab0bd1b653a69af4d_6553329811603610700.gif)\r\n",
      "count": "268",
      "readingTime": "1 ",
      "imageUrls": [
        "https://upload-bbs.miyoushe.com/upload/2024/07/27/75276539/98580c852764d70e5a9597aa7678f131_2245446554692880272.jpg",
        "https://upload-bbs.miyoushe.com/upload/2024/03/20/285532152/757fa74f8b38fdfab0bd1b653a69af4d_6553329811603610700.gif"
      ],
      "createdAt": "2024-11-13T12:48:31.000Z",
      "updatedAt": "2024-11-14T08:12:55.000Z",
      "modified": true
    },
    "react-scan": {
      "authors": [
        "zhw"
      ],
      "title": "èŠèŠreact-scan",
      "tag": "react",
      "path": "react-scan",
      "rawFilePath": "./react-scan.md",
      "coverImage": "https://raw.githubusercontent.com/aidenybai/react-scan/ca7746e2808408c04bcfbfc15486368e67d72bba/.github/assets/logo.svg",
      "text": "# react - scan æ ¸å¿ƒåŸç†å‰–æ\r\n\r\nreact - scan æ˜¯ä¸€ä¸ªç”¨äºç›‘å¬reacté‡æ¸²æŸ“çš„å·¥å…·ï¼Œå…¶æ ¸å¿ƒåŸç†æ˜¯å·§å¦™ä¼ªè£…æˆ React DevToolsï¼Œå€Ÿæ­¤æˆåŠŸæ¥å…¥ React çš„å†…éƒ¨è¿è¡Œæœºåˆ¶ï¼Œä»è€Œç²¾å‡†è·å– Fiber èŠ‚ç‚¹å…³é”®ä¿¡æ¯ï¼Œå®ç°å¯¹ç»„ä»¶æ›´æ–°çŠ¶å†µçš„å®æ—¶ç›‘æ§ã€‚\r\n\r\nReact DevTools åœ¨ç½‘é¡µçš„ window å¯¹è±¡ä¸Šä¼šæŒ‚è½½ä¸€ä¸ªç‰¹æ®Šçš„å…¨å±€å¯¹è±¡ï¼š`__REACT_DEVTOOLS_GLOBAL_HOOK__`ã€‚React åœ¨è‡ªèº«è¿è¡ŒæœŸé—´ï¼ŒäºæŸäº›å…³é”®ç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹ï¼Œä¼šè°ƒç”¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„æŒ‡å®šæ–¹æ³•ï¼Œåƒåœ¨ commit é˜¶æ®µå°±ä¼šè°ƒç”¨ `onCommitFiberRoot` æ–¹æ³•ï¼Œå¹¶å‘å…¶ä¼ å…¥å½“å‰æ›´æ–°çš„ FiberRoot èŠ‚ç‚¹ä½œä¸ºå‚æ•°ã€‚\r\n\r\nreact - scan åˆ™åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œé€šè¿‡åŠ«æŒè¯¥ hook ä¸Šçš„å‡½æ•°ï¼Œä¾‹å¦‚å¯¹ `onCommitFiberRoot` è¿›è¡Œé‡å†™æ“ä½œï¼Œä»è€Œé¡ºåˆ©è·å–æ•´ä¸ª React åº”ç”¨çš„ Fiber æ ‘æ ¹èŠ‚ç‚¹ã€‚è·å–æ ¹èŠ‚ç‚¹åï¼Œå€ŸåŠ© Fiber èŠ‚ç‚¹çš„ child å±æ€§æŒ‡å‘ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ã€sibling å±æ€§æŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼Œå°±èƒ½é€’å½’éå†æ•´æ£µ Fiber æ ‘ï¼Œè¿›è€Œæ‹¿åˆ°æ¯ä¸€ä¸ªç»„ä»¶å¯¹åº”çš„ Fiber èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯ã€‚\r\n\r\n**å¦‚ä½•åˆ¤æ–­ç»„ä»¶æ˜¯å¦å‘ç”Ÿæ›´æ–°ï¼Ÿ**\r\n\r\n  * å¯¹äºé Host ç»„ä»¶ï¼ˆå³éåŸç”Ÿ DOM èŠ‚ç‚¹ï¼‰ï¼šé€šè¿‡ä½è¿ç®—åˆ¤æ–­å…¶ flags ä¸ PerformedWork ç›¸ä¸çš„ç»“æœæ˜¯å¦ä¸º PerformedWorkï¼Œä»¥æ­¤ç¡®å®šè¯¥ Fiber èŠ‚ç‚¹æ˜¯å¦å‘ç”Ÿæ›´æ–°ã€‚\r\n  * å¯¹äº Host ç»„ä»¶ï¼ˆå¯¹åº”å®é™… DOM èŠ‚ç‚¹ï¼‰ï¼š\r\n    * è‹¥ä¸å­˜åœ¨ alternate èŠ‚ç‚¹ï¼Œè¡¨æ˜æ˜¯ç»„ä»¶çš„é¦–æ¬¡æ¸²æŸ“ï¼ˆå› ä¸º Fiber é‡‡ç”¨åŒç¼“å†²æœºåˆ¶ï¼Œå­˜åœ¨å½“å‰æ ‘ä¸ä¸Šä¸€æ¬¡æ ‘ä¹‹åˆ†ï¼‰ã€‚\r\n    * è‹¥å­˜åœ¨ alternate èŠ‚ç‚¹ï¼Œåˆ™å¯¹æ¯”å½“å‰ä¸ä¸Šä¸€æ¬¡çš„ memoizedPropsï¼ˆç»„ä»¶å±æ€§ï¼‰ã€memoizedStateï¼ˆç»„ä»¶çŠ¶æ€ï¼‰ã€refï¼Œåˆ¤æ–­ç»„ä»¶æ˜¯å¦æ›´æ–°ã€‚\r\n\r\n**å¦‚ä½•å®šä½æ›´æ–°ç»„ä»¶çš„ DOM å…ƒç´ ï¼Ÿ**\r\n\r\nä¸€æ—¦ç¡®å®šç»„ä»¶å‘ç”Ÿæ›´æ–°ï¼Œå¯ä»¥ä»å¯¹åº”çš„ Fiber èŠ‚ç‚¹å‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„ Host èŠ‚ç‚¹ï¼ˆå³ Host Fiberï¼‰ï¼Œè·å–å…¶å…³è”çš„ DOM å…ƒç´ ï¼Œè¿›è€Œå¯¹ DOM å…ƒç´ è¿›è¡Œé«˜äº®æˆ–æ ‡è®°æ“ä½œï¼Œæ–¹ä¾¿è¿›è¡Œè°ƒè¯•æˆ–å¯è§†åŒ–å±•ç¤ºã€‚\r\n\r\n**ä¸€äº›å…¶ä»–åŠŸèƒ½ï¼š**\r\n\r\n  * å¯¹æ¯”ä¸¤æ£µ Fiber æ ‘çš„ memoizedPropsï¼Œèƒ½å¤Ÿç²¾ç¡®çŸ¥æ™“å…·ä½“å“ªä¸ª prop å‘ç”Ÿäº†å˜åŒ–ã€‚\r\n  * åˆ¤æ–­æ˜¯å¦å›  Context å˜åŒ–å¼•å‘çš„ç»„ä»¶æ›´æ–°ï¼šå¯é€šè¿‡ fiber.firstContext è·å–ç»„ä»¶è®¢é˜…çš„ç¬¬ä¸€ä¸ª Contextï¼Œç„¶åå‡­å€Ÿå…¶ next å±æ€§ä¾æ¬¡éå†æ‰€æœ‰è®¢é˜…çš„ Context èŠ‚ç‚¹ï¼ŒæŸ¥æ‰¾æ›´æ–°æºå¤´ã€‚\r\n  * åˆ¤æ–­æ˜¯å¦å› ä¸º Hook æ›´æ–°å¯¼è‡´ç»„ä»¶æ›´æ–°ï¼šé‰´äº Fiber ä¸Šçš„ memoizedState å­˜å‚¨ç€ hooks é“¾è¡¨ï¼Œå¯æ®æ­¤åˆ†ææ˜¯å“ªä¸ª state å‘ç”Ÿäº†å˜åŒ–ã€‚",
      "count": "1.1k",
      "readingTime": "5 ",
      "imageUrls": [],
      "createdAt": "2025-05-09T10:11:35.000Z",
      "updatedAt": "2025-05-09T10:11:35.000Z",
      "modified": false
    },
    "rc-field-form": {
      "authors": [
        "zhw"
      ],
      "title": "rc-field-formæºç åˆ†æ",
      "tag": "react",
      "path": "rc-field-form",
      "rawFilePath": "./rc-field-form.md",
      "coverImage": "https://avatars.githubusercontent.com/u/9441414?s=48&v=4",
      "text": "æœ¬ç¯‡æ–‡ç« å°†ç®€å•åˆ†ærc-field-formçš„æºç ï¼Œrc-field-formæ˜¯ä¸€ä¸ªreactè¡¨å•ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œantdçš„formå°±æ˜¯åŸºäºä»–è¿›è¡Œçš„å°è£…ï¼Œå¦‚æœå¤§å®¶æƒ³è¦äº†è§£reactè¡¨å•çš„ä¸»æµè§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥é˜…è¯»[ğŸ“ä¸­å°è¡¨å•æŠ€æœ¯é€‰å‹å®è·µ(è¡¨å•å®è·µ) - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7316723621292638246#heading-13)\r\n## ç”¨æ³•\r\né¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹rc-field-formçš„ç”¨æ³•\r\n\r\n```js\r\nimport Form, { useForm, Field } from \"../rc-form\";\r\n\r\nexport default () => {\r\n  const [form] = useForm();\r\n\r\n  return (\r\n    <Form\r\n      onFinish={(e) => {\r\n        console.log(e);\r\n      }}\r\n      onFinishFailed={(e) => {\r\n        console.log(e);\r\n      }}\r\n      form={form}\r\n    >\r\n      <Field name=\"name\" rules={[{ required: true, max: 4 }]}>\r\n        <input placeholder=\"Username\" />\r\n      </Field>\r\n      <Field name=\"password\" rules={[{ required: true, max: 1 }]}>\r\n        <input placeholder=\"Username1\" />\r\n      </Field>\r\n      <button>Submit</button>\r\n    </Form>\r\n  );\r\n};\r\n\r\n```\r\nåœ¨è¿™æ®µä»£ç ä¸­ï¼Œä½¿æˆ‘ä»¬ä½¿ç”¨ Form ç»„ä»¶æ¥æ–°å»ºä¸€ä¸ª Form è¡¨å•ï¼Œç„¶ååœ¨Fieldç»„ä»¶é‡ŒåŒ…è£¹äº†æˆ‘ä»¬çš„æ¯ä¸€ä¸ªè¡¨å•é¡¹ï¼Œå¹¶ä¸”é€šè¿‡Fieldçš„nameå­—æ®µåˆ›å»ºè¡¨å•çš„keyï¼Œrulesæ¥é…ç½®æ ¡éªŒã€‚å½“æˆ‘ä»¬ç‚¹å‡»buttonåï¼Œä¼šæ ¹æ®æ˜¯å¦é€šè¿‡æ ¡éªŒæ¥è§¦å‘onFinshæˆ–è€…onFinishFailedã€‚\r\n\r\nç”±æ­¤æˆ‘ä»¬å¯ä»¥å¼•å‡ºä¸€äº›é—®é¢˜ï¼š\r\n- Formç»„ä»¶æ˜¯å¦‚ä½•ç®¡ç†æˆ‘ä»¬çš„è¡¨å•æ•°æ®\r\n- æˆ‘ä»¬å¹¶æ²¡æœ‰ç»™æ¯ä¸ªinputç»‘å®šäº‹ä»¶ï¼Œè¡¨å•çš„å€¼æ˜¯å¦‚ä½•æ›´æ–°çš„\r\n- Formç»„ä»¶å¦‚ä½•å¯¹æˆ‘ä»¬çš„æ•°æ®è¿›è¡Œæ ¡éªŒ\r\nä¸‹é¢å°±è®©æˆ‘ä»¬ä»æºç å…¥æ‰‹æ¥è§£å†³è¿™äº›é—®é¢˜\r\n# **ä¸€**Â·å¦‚ä½•å®ç°æ•°æ®çš„æ›´æ–°\r\n### Formç»„ä»¶å¦‚ä½•ç®¡ç†æ•°æ®\r\næ ¹æ®ä¸Šé¢çš„ä»£ç ï¼Œå½“æˆ‘ä»¬åˆ›å»ºFormç»„ä»¶æ—¶ï¼Œå¿…é¡»è¦ç»™Formç»„ä»¶ä¼ å…¥ä¸€ä¸ªé€šè¿‡useFormè¿™ä¸ªhookå¾—åˆ°çš„formï¼Œé‚£ä¹ˆè¿™ä¸ªformæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢æ˜¯useFormçš„æºç \r\n\r\n```js\r\nfunction useForm(form) {\r\n  const formRef = React.useRef();\r\n  const [, forceUpdate] = React.useState({});\r\n\r\n  if (!formRef.current) {\r\n    if (form) {\r\n      formRef.current = form;\r\n    } else {\r\n      // Create a new FormStore if not provided\r\n      const forceReRender = () => {\r\n        forceUpdate({});\r\n      };\r\n\r\n      const formStore: FormStore = new FormStore(forceReRender);\r\n\r\n      formRef.current = formStore.getForm();\r\n    }\r\n  }\r\n\r\n  return [formRef.current];\r\n}\r\n\r\n```\r\nå½“æˆ‘ä»¬åœ¨ä½¿ç”¨useFormçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šä¼ å…¥formå‚æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªhookå°±ä¼šå¸®æˆ‘ä»¬newä¸€ä¸ªFormStoreï¼ŒFormStoreæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç±»ï¼Œæ•´ä¸ªè¡¨å•æ•°æ®çš„å­˜å‚¨å’Œæ“ä½œæ–¹æ³•éƒ½æ˜¯ç”±ä»–æä¾›ï¼Œç„¶åè¿”å›Formstoreçš„getFormæ–¹æ³•ï¼Œå…¶å®è¿™é‡Œå°±æ˜¯é€šè¿‡getFormå°†Formstoreé‡Œçš„ä¸€äº›å±æ€§å’Œæ–¹æ³•æš´éœ²äº†å‡ºæ¥ã€‚\r\næˆ‘ä»¬å…ˆæ¥ç®€å•çœ‹ä¸‹FormStoreé‡Œéƒ½æœ‰å•¥(åªå±•ç¤ºéƒ¨åˆ†å±æ€§å’Œæ–¹æ³•)\r\n\r\n```js\r\nexport class FormStore {\r\n  //new FormStoreæ—¶ä¼ å…¥çš„setStateæ–¹æ³•\r\n  private forceRootUpdate\r\n\r\n  private subscribabl = true;\r\n//æ•´ä¸ªè¡¨å•çš„æ•°æ®\r\n  private store: Store = {};\r\n//æ¯ä¸ªFieldç»„ä»¶éƒ½ä¼šè¢«æ³¨å†Œåˆ°è¿™ä¸ªæ•°ç»„é‡Œ\r\n  private fieldEntities = [];\r\n//åˆå§‹å€¼\r\n  private initialValues = {};\r\n//å­˜æ”¾Formä¸Šçš„onFinishç­‰æ–¹æ³•\r\n  private callbacks: Callbacks = {};\r\n  \r\n  constructor(forceRootUpdate: () => void) {\r\n    this.forceRootUpdate = forceRootUpdate;\r\n  }\r\n  //æš´éœ²å‡ºå»ç»™å¼€å‘è€…çš„ä¸€äº›æ–¹æ³•\r\n   public getForm = (): InternalFormInstance => ({\r\n    getFieldValue: this.getFieldValue,\r\n    getFieldsValue: this.getFieldsValue,\r\n    getFieldWarning: this.getFieldWarning,\r\n    resetFields: this.resetFields,\r\n    setFields: this.setFields,\r\n    setFieldValue: this.setFieldValue,\r\n    setFieldsValue: this.setFieldsValue,\r\n    validateFields: this.validateFields,\r\n    submit: this.submit,\r\n    getInternalHooks: this.getInternalHooks,\r\n    ......\r\n  });\r\n    private getInternalHooks = (key: string): InternalHooks | null => {\r\n    //åªæä¾›ç»™å†…éƒ¨ç»„ä»¶çš„æ–¹æ³•ï¼Œå¼€å‘è€…åœ¨å…¶ä»–ç»„ä»¶æ— æ³•è°ƒç”¨ï¼Œè¿™é‡Œçš„HOOK_MARæ˜¯Fieldç»„ä»¶é€šè¿‡contextè·å¾—çš„\r\n    if (key === HOOK_MARK) {\r\n      this.formHooked = true;\r\n\r\n      return {\r\n        dispatch: this.dispatch,\r\n        initEntityValue: this.initEntityValue,\r\n        registerField: this.registerField,\r\n        useSubscribe: this.useSubscribe,\r\n        setInitialValues: this.setInitialValues,\r\n        destroyForm: this.destroyForm,\r\n        setCallbacks: this.setCallbacks,\r\n        setValidateMessages: this.setValidateMessages,\r\n        getFields: this.getFields,\r\n        setPreserve: this.setPreserve,\r\n        getInitialValue: this.getInitialValue,\r\n        registerWatch: this.registerWatch,\r\n      };\r\n    }\r\n\r\n    warning(false, '`getInternalHooks` is internal usage. Should not call directly.');\r\n    return null;\r\n  };\r\n```\r\nè¿˜æœ‰å¾ˆå¤šæ–¹æ³•æ„Ÿè§‰å¤ªå¤šäº†è¿™é‡Œæ²¡æœ‰åˆ—ä¸¾ï¼Œæˆ‘ä»¬ç›´æ¥æŒ‰æµç¨‹è¿›è¡Œåˆ†æç†è§£ï¼Œä¸Šé¢æˆ‘ä»¬è®²åˆ°äº†Formç»„ä»¶éœ€è¦ä¼ å…¥formï¼Œè€Œformæ˜¯FormStoreé€šè¿‡getFormæš´éœ²å‡ºçš„ä¸€äº›å±æ€§å’Œæ–¹æ³•æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹Formç»„ä»¶æ˜¯å¦‚ä½•æ¶ˆè´¹formçš„\r\n\r\n\r\n```js\r\n//formcontextæ˜¯ç”¨äºå…¨å±€formç®¡ç†çš„æš‚ä¸åˆ†æ\r\nconst formContext: FormContextProps = React.useContext(FormContext);\r\n//æ‹¿åˆ°FormStoreæš´éœ²çš„å±æ€§ï¼Œæ–¹æ³•\r\n  const [formInstance] = useForm(form);\r\n  const {\r\n    useSubscribe,\r\n    setInitialValues,\r\n    setCallbacks,\r\n    setValidateMessages,\r\n    setPreserve,\r\n    destroyForm,\r\n  } = (formInstance as InternalFormInstance).getInternalHooks(HOOK_MARK);\r\n\r\n  // è½¬å‘refè®©å¤–éƒ¨å¯ä»¥é€šè¿‡refè°ƒç”¨\r\n  React.useImperativeHandle(ref, () => formInstance);\r\n\r\n  //å…¨å±€ç®¡ç†æœ‰å…³\r\n  React.useEffect(() => {\r\n    formContext.registerForm(name, formInstance);\r\n    return () => {\r\n      formContext.unregisterForm(name);\r\n    };\r\n  }, [formContext, formInstance, name]);\r\n\r\n  //è®¾ç½®validateMessage\r\n  setValidateMessages({\r\n    ...formContext.validateMessages,\r\n    ...validateMessages,\r\n  });\r\n  //æ³¨å†Œformè¡¨å•ä¸Šä¼ å…¥çš„æ–¹æ³•\r\n  setCallbacks({\r\n    onValuesChange,\r\n    onFieldsChange: (changedFields: FieldData[], ...rest) => {\r\n      formContext.triggerFormChange(name, changedFields);\r\n\r\n      if (onFieldsChange) {\r\n        onFieldsChange(changedFields, ...rest);\r\n      }\r\n    },\r\n    onFinish: (values: Store) => {\r\n      formContext.triggerFormFinish(name, values);\r\n\r\n      if (onFinish) {\r\n        onFinish(values);\r\n      }\r\n    },\r\n    onFinishFailed,\r\n  });\r\n  setPreserve(preserve);\r\n```\r\nå¤§æ¦‚å°±æ˜¯ä¸ºFormStoreåˆå§‹åŒ–ä¸€äº›ä¸œè¥¿ï¼Œå¯¹ä¸»æµç¨‹å½±å“ä¸å¤§ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ï¼Œä¸‹é¢æ¥åˆ°äº†åˆ›å»ºåˆå§‹å€¼\r\n\r\n```js\r\n//åˆ¤æ–­æ˜¯å¦ä¸ºé¦–æ¬¡æ¸²æŸ“ï¼Œé¦–æ¬¡æ¸²æŸ“å°±åˆ›å»ºåˆå§‹å€¼\r\n  const mountRef = React.useRef(null);\r\n  setInitialValues(initialValues, !mountRef.current);\r\n  if (!mountRef.current) {\r\n    mountRef.current = true;\r\n  }\r\n//æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶é‡ç½®Form\r\n  React.useEffect(\r\n    () => destroyForm,\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    [],\r\n  );\r\n\r\n```\r\næˆ‘ä»¬å…ˆæ¥çœ‹setInitialValuesè¿™ä¸ªæ–¹æ³•\r\n\r\n```js\r\n  private setInitialValues = (initialValues: Store, init: boolean) => {\r\n    this.initialValues = initialValues || {};\r\n    if (init) {\r\n    //mergeæ–¹æ³•æ˜¯rc-utilæä¾›çš„å·¥å…·å‡½æ•°ï¼Œrc-field-formé‡Œçš„å¾ˆå¤šæ“ä½œéƒ½ç”¨åˆ°äº†é‡Œé¢çš„å‡½æ•°ï¼Œè¿™é‡Œä¸åšåˆ†æ\r\n      let nextStore = merge(initialValues, this.store);\r\n    //éä¸»è¦æµç¨‹è·³è¿‡\r\n      this.prevWithoutPreserves?.map(({ key: namePath }) => {\r\n        nextStore = setValue(nextStore, namePath, getValue(initialValues, namePath));\r\n      });\r\n      this.prevWithoutPreserves = null;\r\n\r\n      this.updateStore(nextStore);\r\n    }\r\n  };\r\n```\r\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°setinitalValuesæ–¹æ³•æœ€åè°ƒç”¨äº†updateStoreï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆç®€å•\r\n\r\n```js\r\n  private updateStore = (nextStore: Store) => {\r\n    this.store = nextStore;\r\n  };\r\n```\r\nç›´æ¥ä¿®æ”¹äº†storeï¼Œæ¥ä¸‹æ¥æ˜¯å¯¹childä¸åŒtypeçš„ä¸€äº›å¤„ç†\r\n\r\n```js\r\n  let childrenNode: React.ReactNode;\r\n  const childrenRenderProps = typeof children === 'function';\r\n  if (childrenRenderProps) {\r\n    const values = formInstance.getFieldsValue(true);\r\n    childrenNode = (children as RenderProps)(values, formInstance);\r\n  } else {\r\n    childrenNode = children;\r\n  }\r\n```\r\nå¦‚æœchildæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™ä¼ å…¥childNodeä¸ºå‡½æ•°è¿”å›å€¼,è¿™é‡Œçš„getFieldsValueæ–¹æ³•å‚æ•°ä¸ºtrueæ—¶è¿”å›çš„å°±æ˜¯æ•´ä¸ªstoreï¼Œä¹Ÿå¯ä»¥ä¼ å…¥Fieldçš„nameæ•°ç»„è·å–æŒ‡å®šçš„valueï¼Œå…·ä½“å®ç°ä¸åšåˆ†æã€‚ç»§ç»­ç»§ç»­ğŸ˜Š\r\n\r\n```js\r\nconst formContextValue = React.useMemo(\r\n    () => ({\r\n      ...(formInstance as InternalFormInstance),\r\n      validateTrigger,\r\n    }),\r\n    [formInstance, validateTrigger],\r\n  );\r\n```\r\nç„¶åæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªcontextï¼Œä¼ å…¥formInstance(FormStoreæš´éœ²çš„æ–¹æ³•å’Œæ•°æ®)ï¼Œè¿˜æœ‰ä¸€ä¸ªvalidateTriggerï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹‹å‰æ²¡æœ‰æåˆ°ï¼Œè¿™ä¸ªå±æ€§æ˜¯ç”¨æˆ·ä¼ ç»™Formç»„ä»¶çš„ï¼Œä»–çš„é»˜è®¤å€¼æ˜¯onChange,ä¹Ÿå°±æ˜¯è¯´åœ¨onChangeçš„æ—¶å€™ä¼šè§¦å‘Fieldç»„ä»¶çš„validateã€‚é©¬ä¸Šå°±åˆ°å°¾å£°äº†(å…¶å®æ˜¯Formçš„å°¾å£°ï¼Œåé¢è¿˜æœ‰ä¸€å †)\r\n\r\n```js\r\n  const wrapperNode = (\r\n    <ListContext.Provider value={null}>\r\n      <FieldContext.Provider value={formContextValue}>{childrenNode}</FieldContext.Provider>\r\n    </ListContext.Provider>\r\n  );\r\n```\r\næ¥ä¸‹åˆ›å»ºä¸€ä¸ªwrapperNodeï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªcontextProviderï¼ŒListContext.Providerè¿™ä¸ªåº”è¯¥æ˜¯ä¸ºListç»„ä»¶æœåŠ¡çš„æˆ‘ä»¬æš‚ä¸å…³å¿ƒï¼Œç„¶åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°FieldContext.Providerå°±æ˜¯æä¾›äº†formInstanceå’ŒvalidateTriggerï¼Œè¿™æ ·æˆ‘ä»¬çš„Fieldç»„ä»¶ä¹Ÿå¯ä»¥è®¿é—®å’Œæ“ä½œformInstanceå•¦ã€‚\r\nç„¶åå°±æ˜¯æˆ‘ä»¬æœ€åçš„ä»£ç \r\n\r\n```js\r\n  if (Component === false) {\r\n    return wrapperNode;\r\n  }\r\n\r\n  return (\r\n    <Component\r\n      {...restProps}\r\n      onSubmit={(event: React.FormEvent<HTMLFormElement>) => {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n\r\n        formInstance.submit();\r\n      }}\r\n      onReset={(event: React.FormEvent<HTMLFormElement>) => {\r\n        event.preventDefault();\r\n\r\n        formInstance.resetFields();\r\n        restProps.onReset?.(event);\r\n      }}\r\n    >\r\n      {wrapperNode}\r\n    </Component>\r\n  );\r\n};\r\n```\r\nè¿™é‡Œçš„Componentä¹Ÿæ˜¯ç”±ç”¨æˆ·ä¼ å…¥çš„ï¼Œé»˜è®¤å€¼ä¸º'form'ï¼Œæ‰€ä»¥æœ€åçš„æ•ˆæœå…¶å®æ˜¯\r\n```js    \r\n    <form\r\n      {...restProps}\r\n      onSubmit={(event: React.FormEvent<HTMLFormElement>) => {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n\r\n        formInstance.submit();\r\n      }}\r\n      onReset={(event: React.FormEvent<HTMLFormElement>) => {\r\n        event.preventDefault();\r\n\r\n        formInstance.resetFields();\r\n        restProps.onReset?.(event);\r\n      }}\r\n    >\r\n      {wrapperNode}\r\n    </form>\r\n```\r\nè¿™é‡Œé˜»æ­¢äº†ä¸€ä¸‹formçš„é»˜è®¤è¡Œä¸ºï¼Œç„¶åä¼šåœ¨submitå’Œresetæ—¶æ‰§è¡ŒformInstanceçš„æ–¹æ³•ã€‚\r\n\r\nåˆ°è¿™é‡Œæˆ‘ä»¬å…ˆæ€»ç»“ä¸€ä¸‹ï¼ŒFormç»„ä»¶éƒ½å¹²äº†ä»€ä¹ˆ\r\n- é¦–å…ˆä»–æ‹¿åˆ°äº†formç„¶åsetCallbacksï¼ŒsetInitialValueså¯¹forminstanceçš„callbackå’Œstoreè¿›è¡Œäº†åˆå§‹åŒ–\r\n- ç„¶åå¯¹childrenè¿›è¡Œäº†å¤„ç†ï¼Œç”¨FieldContextå°†å®ƒåŒ…è£¹ï¼Œè®©Fieldç»„ä»¶å¯ä»¥æ‹¿åˆ°formInstanceç­‰ä¸€äº›ä¸œè¥¿\r\n- æœ€åç”¨formæ ‡ç­¾å°†å¤„ç†åçš„childåŒ…è£¹èµ·æ¥ï¼Œå°†äº‹ä»¶è¿›è¡Œç»‘å®š\r\n### Fieldå¦‚ä½•æ¶ˆè´¹æ•°æ®\r\næ¥ä¸‹æ¥è®©æˆ‘ä»¬ç»§ç»­çœ‹çœ‹Feldç»„ä»¶ï¼ŒFieldç»„ä»¶æœ‰ä¸€ç‚¹ç‰¹æ®Šï¼Œä»–æ˜¯ä¸€ä¸ªclassç»„ä»¶ğŸ¤”ï¼Œæºç ä¸­æ³¨é‡Šæ˜¯\r\n` We use Class instead of Hooks here since it will cost much code by using Hooks.`å¤§æ¦‚æ„æ€æ˜¯é€šè¿‡classç»„ä»¶çš„æ–¹å¼å®ç°å¯ä»¥å‡å°‘ä»£ç é‡ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹Fieldç»„ä»¶å¤§è‡´çš„ä»£ç ç»“æ„ã€‚\r\n```js\r\nclass Field extends React.Component<InternalFieldProps, FieldState> implements FieldEntity {\r\n    //ä¼ å…¥çš„formInstance\r\n    public static contextType = FieldContext;\r\n    //ç»„ä»¶é»˜è®¤å‚æ•°\r\n    public static defaultProps\r\n    //å®šä¹‰ä¸€ä¸ªstateç”¨äºè§¦å‘rerender\r\n    public state \r\n    //ç”¨äºç»„ä»¶å¸è½½æ—¶æ¸…é™¤formInstanceé‡Œæ•°æ®\r\n    private cancelRegisterFunc\r\n    //æ˜¯å¦å·²æŒ‚è½½\r\n    private mounted = false;\r\n    //è¡¨å•æ ¡éªŒç»“æœçš„Promise\r\n    private validatePromise\r\n    //æ ¡éªŒç»“æœerror\r\n    private errors\r\n    //æ ¡éªŒç»“æœ warning\r\n    private warnings\r\n  \r\n    constructor(props) {\r\n        super()\r\n        ..........\r\n    }\r\n  \r\n    public componentDidMount\r\n  \r\n    public componentWillUnmount() {\r\n    }\r\n    //ä¼šè°ƒç”¨å¹¶é”€æ¯cancelRegisterFunc\r\n    public cancelRegister\r\n    //è·å–Fieldçš„name\r\n    public getNamePath\r\n    //è·å–ä¼ å…¥çš„rules\r\n    public getRules\r\n    //ç”¨äºæ›´æ–°ç»„ä»¶\r\n    public reRender\r\n    public refresh\r\n    // ========================= è¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œè·Ÿç»„ä»¶æ›´æ–°ç›¸å…³ ==============================\r\n    public onStoreChange\r\n    //æ ¡éªŒruluesçš„æ–¹æ³•\r\n    public validateRules\r\n    public isFieldValidating = () => !!this.validatePromise;\r\n   //è·å–æ ¡éªŒåçš„ç»“æœ\r\n    public getErrors\r\n    public getWarnings\r\n   //å¯¹ä¼ å…¥çš„childçš„ä¸€äº›å¤„ç†\r\n    public getOnlyChild\r\n    //è¿”å›å½“å‰Fieldå­—æ®µçš„å€¼\r\n    public getValue\r\n    // ======== å°±æ˜¯è¿™ä¸ªæ–¹æ³•è®©æˆ‘ä»¬ä¼ å…¥çš„ç»„ä»¶å—æ§ï¼ŒåŠ«æŒäº†ç»„ä»¶çš„onChangeè¿™ç±»äº‹ä»¶ ====================\r\n    public getControlled\r\n    //è¿”å›å¤„ç†åçš„å­ç»„ä»¶\r\n    public render() {\r\n    \r\n    }\r\n  }\r\n```\r\näº†è§£äº†å¤§ä½“ç»“æ„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å…ˆä»constructorå…¥æ‰‹ï¼Œçœ‹çœ‹Fieldç»„ä»¶çš„æ¸²æŸ“æµç¨‹ã€‚\r\n\r\n```js\r\n  constructor(props: InternalFieldProps) {\r\n    super(props);\r\n\r\n    // Register on init\r\n    if (props.fieldContext) {\r\n      const { getInternalHooks }: InternalFormInstance = props.fieldContext;\r\n      const { initEntityValue } = getInternalHooks(HOOK_MARK);\r\n      initEntityValue(this);\r\n    }\r\n  }\r\n\r\n```\r\nè¿™é‡Œå…¶å®å°±æ˜¯è°ƒç”¨äº†initEntityValueè¿™ä¸ªå‡½æ•°ï¼Œä¼ å…¥Fieldç»„ä»¶\r\n\r\n```js\r\n private initEntityValue = (entity: FieldEntity) => {\r\n    const { initialValue } = entity.props;\r\n\r\n    if (initialValue !== undefined) {\r\n      const namePath = entity.getNamePath();\r\n      const prevValue = getValue(this.store, namePath);\r\n\r\n      if (prevValue === undefined) {\r\n        this.updateStore(setValue(this.store, namePath, initialValue));\r\n      }\r\n    }\r\n  };\r\n```\r\nè¿™é‡Œå°±æ˜¯ç®€å•è®¾ç½®äº†ä¸€ä¸‹åˆå§‹å€¼å¹¶ä¸ä¼šå¼•èµ·Fieldçš„rerenderï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹Fieldç»„ä»¶éƒ½åšäº†å“ªäº›åˆå§‹åŒ–\r\n\r\n```js\r\n  public componentDidMount() {\r\n    const {  fieldContext } = this.props;\r\n     //æ ‡è®°ä¸ºå·²æŒ‚è½½\r\n    this.mounted = true;\r\n\r\n    if (fieldContext) {\r\n      const { getInternalHooks }: InternalFormInstance = fieldContext;\r\n      const { registerField } = getInternalHooks(HOOK_MARK);\r\n      //\r\n      this.cancelRegisterFunc = registerField(this);\r\n    }\r\n  }\r\n```\r\nè¿™é‡Œçš„æ ¸å¿ƒå°±æ˜¯registerFieldï¼Œè¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡formStoreçš„fieldEntitiesæ•°ç»„é‡Œå­˜å‚¨äº†Fieldå—ï¼Œè¿™ä¸ªå‡½æ•°å…¶å®æ ¸å¿ƒå°±æ˜¯fieldEntities.push(field)ï¼Œç„¶åç»™æˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªå‡½æ•°ç”¨äºåœ¨fieldEntitiesé‡Œdeleteè¿™ä¸ªFieldï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡formInstanceè°ƒç”¨Fieldé‡Œæš´éœ²çš„ä¸€äº›æ–¹æ³•ç”¨äºæ›´æ–°æˆ–è€…æ ¡éªŒã€‚ \r\n\r\nç„¶åå°±æ˜¯renderå‡½æ•°\r\n\r\n```js\r\n public render() {\r\n    const { resetCount } = this.state;\r\n    const { children } = this.props;\r\n\r\n    const { child, isFunction } = this.getOnlyChild(children);\r\n\r\n    // Not need to `cloneElement` since user can handle this in render function self\r\n    let returnChildNode: React.ReactNode;\r\n    if (isFunction) {\r\n      returnChildNode = child;\r\n    } else if (React.isValidElement(child)) {\r\n      returnChildNode = React.cloneElement(\r\n        child as React.ReactElement,\r\n        this.getControlled((child as React.ReactElement).props),\r\n      );\r\n    } else {\r\n      warning(!child, '`children` of Field is not validate ReactElement.');\r\n      returnChildNode = child;\r\n    }\r\n\r\n    return <React.Fragment key={resetCount}>{returnChildNode}</React.Fragment>;\r\n  }\r\n}\r\n```\r\ngetonlychildè¿”å›ç¬¬ä¸€ä¸ªchildå’Œä»–çš„ç±»å‹ï¼Œå½“childæ˜¯åˆæ³•çš„reactElementæ—¶ï¼Œè°ƒç”¨[cloneElementæ–¹æ³•](https://react.dev/reference/react/cloneElement)ï¼Œç„¶åè¿”å›FragmentåŒ…è£¹çš„cloneElementï¼Œæ‰€ä»¥è¿™é‡Œçš„å…³é”®å°±æ˜¯è¿™ä¸ªcloneElementçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¿™é‡Œåˆ°åº•ä¼ å…¥äº†ä»€ä¹ˆä¸œè¥¿ğŸ¤¨ã€‚  \r\nç®€å•åœ°è¯´ï¼ŒcloneElementçš„ç¬¬äºŒä¸ªå‚æ•°å…¶å®æ˜¯`props`ï¼Œå®ƒå¯ä»¥è¦†ç›–é»˜è®¤çš„propsï¼Œfc-field-formå°±æ˜¯åœ¨è¿™é‡Œæ¥ç®¡äº†Fieldçš„onChangeç­‰ä¸€ç³»åˆ—äº‹ä»¶ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹getControlledçš„æºç \r\n\r\n```js\r\n  public getControlled = (childProps: ChildProps = {}) => {\r\n  //è·å–Fieldçš„ä¸€äº›æ–¹æ³•å’Œæ•°æ®\r\n    const {\r\n      name,\r\n      trigger,\r\n      validateTrigger,\r\n      getValueFromEvent,\r\n      normalize,\r\n      valuePropName,\r\n      getValueProps,\r\n      fieldContext,\r\n    } = this.props;\r\n   //æ ¡éªŒæœ‰å…³,å…¶å®å°±æ˜¯ä¸€äº›äº‹ä»¶çš„nameï¼Œå¦‚'onChange'\r\n    const mergedValidateTrigger =\r\n      validateTrigger !== undefined ? validateTrigger : fieldContext.validateTrigger;\r\n    //å½“å‰field name\r\n    const namePath = this.getNamePath();\r\n    const { getInternalHooks, getFieldsValue }: InternalFormInstance = fieldContext;\r\n    //---------- dispatchä¼ å…¥ä¸åŒçš„å‚æ•°å¯ä»¥åˆ†å‘ä¸åŒæ“ä½œå¦‚æ ¡éªŒï¼Œæ›´æ–° ----------------\r\n    const { dispatch } = getInternalHooks(HOOK_MARK);\r\n    const value = this.getValue();\r\n    //ä¸å¤ªé‡è¦ï¼Œç»™å­å…ƒç´ æä¾›ä¸€ä¸ªå¯ä»¥è·å–valueçš„æ–¹æ³•\r\n    const mergedGetValueProps = getValueProps || ((val: StoreValue) => ({ [valuePropName]: val }));\r\n    //åŒä¸Š\r\n    const valueProps = name !== undefined ? mergedGetValueProps(value) : {};\r\n        //triggerçš„é»˜è®¤å€¼æ˜¯onChangeï¼Œå¦‚æœæˆ‘ä»¬åœ¨æŸä¸ªFieldçš„inputé‡Œç»‘å®šäº†onChangeäº‹ä»¶ï¼Œè¿™é‡Œå°±å¯ä»¥æ‹¿åˆ°\r\n    const originTriggerFunc = childProps[trigger];\r\n    // warning when prop value is function\r\n    if (process.env.NODE_ENV !== 'production' && valueProps) {\r\n      Object.keys(valueProps).forEach(key => {\r\n        warning(\r\n          typeof valueProps[key] !== 'function',\r\n          `It's not recommended to generate dynamic function prop by \\`getValueProps\\`. Please pass it to child component directly (prop: ${key})`,\r\n        );\r\n      });\r\n    }\r\n    //è¿™ä¸ªcontrolå°±æ˜¯æˆ‘ä»¬è¦è¿”å›çš„propsï¼Œç°åœ¨è¿˜å‡ ä¹æ²¡æœ‰å•¥çœŸæ­£æœ‰ç”¨çš„å˜åŒ–\r\n    const control = {\r\n      ...childProps,\r\n      ...valueProps,\r\n    };\r\n    //------------------------------- åŠ«æŒäº‹ä»¶äº† ------------------------------------\r\n    control[trigger] = (...args: EventArgs) => {\r\n      //ä¿®æ”¹ä¸€äº›çŠ¶æ€\r\n      this.touched = true;\r\n      this.dirty = true;\r\n\r\n      this.triggerMetaEvent();\r\n\r\n      let newValue: StoreValue;\r\n      //é»˜è®¤ä¸ºç©ºï¼Œç”¨æˆ·å¯ä»¥ä¼ å…¥ï¼Œå°±æ˜¯è·å–äº‹ä»¶è¿”å›å€¼\r\n      if (getValueFromEvent) {\r\n        newValue = getValueFromEvent(...args);\r\n      } else {\r\n      //ç”¨æˆ·ä¸ä¼ å…¥ä½¿ç”¨é»˜è®¤æ–¹æ³•\r\n        newValue = defaultGetValueFromEvent(valuePropName, ...args);\r\n      }\r\n      //å¯¹æ•°æ®è¿›è¡Œä¸€äº›æ ¼å¼åŒ–å¤„ç†\r\n      if (normalize) {\r\n        newValue = normalize(newValue, value, getFieldsValue(true));\r\n      }\r\n       //åˆ†å‘æ›´æ–°äº‹ä»¶\r\n      dispatch({\r\n        type: 'updateValue',\r\n        namePath,\r\n        value: newValue,\r\n      });\r\n       //å¦‚æœç”¨æˆ·è¿˜ç»‘å®šäº†äº‹ä»¶ï¼Œè°ƒç”¨ç”¨æˆ·åŸæ¥ç»‘å®šçš„äº‹ä»¶\r\n      if (originTriggerFunc) {\r\n        originTriggerFunc(...args);\r\n      }\r\n    };\r\n    \r\n    //è§¦å‘æ ¡éªŒçš„æ•°ç»„ï¼Œå¦‚['onChange'],åé¢çš„å…ˆä¸çœ‹å±äºæ ¡éªŒçš„å†…å®¹\r\n     const validateTriggerList: string[] = toArray(mergedValidateTrigger || []);\r\n\r\n    validateTriggerList.forEach((triggerName: string) => {\r\n      // Wrap additional function of component, so that we can get latest value from store\r\n      const originTrigger = control[triggerName];\r\n      control[triggerName] = (...args: EventArgs) => {\r\n        if (originTrigger) {\r\n          originTrigger(...args);\r\n        }\r\n\r\n        // Always use latest rules\r\n        const { rules } = this.props;\r\n        if (rules && rules.length) {\r\n          // We dispatch validate to root,\r\n          // since it will update related data with other field with same name\r\n          dispatch({\r\n            type: 'validateField',\r\n            namePath,\r\n            triggerName,\r\n          });\r\n        }\r\n      };\r\n    });\r\n\r\n    return control;\r\n  };\r\n```\r\nåˆ°äº†è¿™é‡Œå…¶å®æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†rc-field-formåœ¨è¡¨å•è§¦å‘äº‹ä»¶æ—¶ï¼Œè™½ç„¶æˆ‘ä»¬å¹¶æ²¡æœ‰ç»‘å®šäº‹ä»¶ï¼Œä½†æ˜¯å®ƒå·²ç»å°†å…¶åŠ«æŒï¼Œå¹¶ä¸”é€šè¿‡dispatchè¿™ä¸ªå‡½æ•°é€šçŸ¥formStoreè¿›è¡Œæ•°æ®ä¸Šçš„æ›´æ–°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·æ¥æ¢ç´¢dataå’Œuiæ˜¯å¦‚ä½•æ›´æ–°ã€‚\r\n\r\ndispatchè¿™ä¸ªå‡½æ•°çš„ä»£ç å¾ˆå°‘ï¼Œå¦‚ä¸‹\r\n```js\r\n  private dispatch = (action: ReducerAction) => {\r\n    switch (action.type) {\r\n      case 'updateValue': {\r\n        const { namePath, value } = action;\r\n        this.updateValue(namePath, value);\r\n        break;\r\n      }\r\n      case 'validateField': {\r\n        const { namePath, triggerName } = action;\r\n        this.validateFields([namePath], { triggerName });\r\n        break;\r\n      }\r\n      default:\r\n      // Currently we don't have other action. Do nothing.\r\n    }\r\n  };\r\n```\r\nå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è§¦å‘updateVlueè¿›å…¥äº†updateValueè¿™ä¸ªå‡½æ•°\r\n\r\n```js\r\n  private updateValue = (name: NamePath, value: StoreValue) => {\r\n    const namePath = getNamePath(name);\r\n    const prevStore = this.store;\r\n    this.updateStore(setValue(this.store, namePath, value));\r\n\r\n    this.notifyObservers(prevStore, [namePath], {\r\n      type: 'valueUpdate',\r\n      source: 'internal',\r\n    });\r\n    ......\r\n  };\r\n```\r\n ç®€ç•¥åçš„ä»£ç å¦‚ä¸Šï¼ŒupdateStoreæ›´æ–°äº†ä¸€ä¸‹storeï¼Œå…¶å®åˆ°è¿™é‡Œæˆ‘ä»¬å°±å·²ç»å°†formInstanceçš„storeæ›´æ–°äº†ï¼Œæ¥ä¸‹æ¥æ€è€ƒçš„æ˜¯å¦‚ä½•æ›´æ–°uiï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹è¿™ä¸ªnotifyObserverså‡½æ•°\r\n \r\n```js\r\n private notifyObservers = (\r\n    prevStore: Store,\r\n    namePathList: InternalNamePath[] | null,\r\n    info: NotifyInfo,\r\n  ) => {\r\n    if (this.subscribable) {\r\n    //åˆå¹¶infoå’Œstore\r\n      const mergedInfo: ValuedNotifyInfo = {\r\n        ...info,\r\n        store: this.getFieldsValue(true),\r\n      };\r\n      //è·å–æ‰€æœ‰Fieldï¼Œæ‰§è¡Œæ¯ä¸ªFieldçš„onStoreChangeæ–¹æ³•\r\n      this.getFieldEntities().forEach(({ onStoreChange }) => {\r\n        onStoreChange(prevStore, namePathList, mergedInfo);\r\n      });\r\n    } else {\r\n      this.forceRootUpdate();\r\n    }\r\n  };\r\n```\r\nè¿˜è®°å¾—æˆ‘ä»¬æåˆ°è¿‡Fieldé‡Œçš„onStoreChangeä¸æ›´æ–°æœ‰å…³å—ï¼Œæ²¡é”™ç°åœ¨è¿™ä¸€åˆ‡éƒ½è¿äº†èµ·æ¥ã€‚\r\n\r\n```js\r\npublic onStoreChange: FieldEntity['onStoreChange'] = (prevStore, namePathList, info) => {\r\n  const { shouldUpdate, dependencies = [], onReset } = this.props;\r\n  const { store } = info;\r\n  const namePath = this.getNamePath();\r\n  const prevValue = this.getValue(prevStore);\r\n  const curValue = this.getValue(store);\r\n  //åŒ¹é…æ˜¯å¦åŒ…å«å½“å‰name\r\n  const namePathMatch = namePathList && containsNamePath(namePathList, namePath);\r\n\r\n  // ä¸ºsetFieldValueè¿™æ ·çš„apiæœåŠ¡çš„\r\n  if (\r\n    info.type === 'valueUpdate' &&\r\n    info.source === 'external' &&\r\n    !isEqual(prevValue, curValue)\r\n  ) {\r\n    this.touched = true;\r\n    this.dirty = true;\r\n    this.validatePromise = null;\r\n    this.errors = EMPTY_ERRORS;\r\n    this.warnings = EMPTY_ERRORS;\r\n    this.triggerMetaEvent();\r\n  }\r\n  //å…¶ä»–ä»£ç çœç•¥ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯default\r\n  switch (info.type) {\r\n    case 'reset':\r\n    case 'remove':\r\n    case 'setField':\r\n    case 'dependenciesUpdate'\r\n    default:\r\n    //ä¸€äº›æ˜¯å¦éœ€è¦æ›´æ–°çš„åˆ¤æ–­\r\n      if (\r\n        namePathMatch ||\r\n        ((!dependencies.length || namePath.length || shouldUpdate) &&\r\n          requireUpdate(shouldUpdate, prevStore, store, prevValue, curValue, info))\r\n      ) {\r\n      //è°ƒç”¨æ–¹æ³•æ›´æ–°\r\n        this.reRender();\r\n        return;\r\n      }\r\n      break;\r\n  }\r\n\r\n  if (shouldUpdate === true) {\r\n    this.reRender();\r\n  }\r\n  };\r\n```\r\nrerenderæ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ä½¿ç”¨äº†ç±»ç»„ä»¶çš„forceUpdateå¼ºåˆ¶æ›´æ–°\r\n```js\r\n  public reRender() {\r\n    if (!this.mounted) return;\r\n    this.forceUpdate();\r\n  }\r\n```\r\nåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†è¡¨å•å¦‚ä½•è¿›è¡Œæœ€åŸºæœ¬çš„æ›´æ–°ï¼Œè¿™é‡Œæ”¾ä¸€å¼ å­—èŠ‚å¤§ä½¬çš„å›¾\r\n\r\n![64652037b3ee4d1184d79e8e105e2429~tplv-k3u1fbpfcp-jj-mark_3024_0_0_0_q75[1].awebp](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a88f033593474fd58c47fa0bc79d781c~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1588&h=778&s=46900&e=webp&b=fffefe)\r\nå†ç†ä¸€ä¸‹æ€è·¯\r\n1. é¦–å…ˆæˆ‘ä»¬åœ¨Formç»„ä»¶ä¸­åˆ›å»ºäº†formInstance,å°†åˆå§‹å€¼å’Œä¸€äº›callbackç»‘å®šåˆ°äº†formä¸Šï¼Œç„¶åé€šè¿‡FieldContextå°†formInstanceä¸‹æ”¾åˆ°æ¯ä¸ªFieldç»„ä»¶é‡Œå®ç°äº†æ–¹æ³•å’Œæ•°æ®çš„å…±äº«\r\n2. åœ¨Fieldç»„ä»¶ä¸­ï¼Œå®ƒä¼šåœ¨componentDidMounté˜¶æ®µè¢«æ³¨å†Œåˆ°formInstanceä¸­ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡cloneElementè¿™ä¸ªapiå¯¹ä¼ å…¥Fieldçš„å­ç»„ä»¶çš„äº‹ä»¶è¿›è¡Œäº†åŠ«æŒï¼Œå½“è§¦å‘æŸç”Ÿäº‹ä»¶æ—¶Fieldç»„ä»¶è°ƒç”¨formInstanceçš„dispathæ–¹æ³•å¼€å§‹è§¦å‘æ›´æ–°\r\n3. dispathæ ¹æ®ä¸åŒçš„action typeä¼šæ´¾å‘ä¸åŒçš„äº‹ä»¶ï¼Œåœ¨updateVlueçš„æƒ…å†µä¸‹è°ƒç”¨äº†updateValueæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­é¦–å…ˆé€šè¿‡updateStoreæ–¹æ³•å¯¹Storeä¸­çš„æ•°æ®è¿›è¡Œäº†æ›´æ–°ï¼Œç„¶åè°ƒç”¨notifyObserveræ–¹æ³•ï¼ŒnotifyObserverä¼šéå†æ‰€æœ‰Fieldç»„ä»¶ï¼Œè°ƒç”¨ä»–ä»¬çš„onStorechangeæ–¹æ³•ï¼Œæ¯ä¸ªFieldç»„ä»¶ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°å’Œæ›´æ–°çš„ç±»å‹(å¦‚reset,setField),ç„¶åæ®æ­¤è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œæœ€åæ›´æ–°çš„æ–¹æ³•æ˜¯refresh()ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨äº†ç±»ç»„ä»¶çš„forceUpdateæ–¹æ³•  \r\n\r\nä¸Šé¢è¿™ç§æ›´æ–°æ–¹å¼æ˜¯é€šè¿‡ç”¨æˆ·çš„ä¸€äº›è¡Œä¸ºï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡forminstanceæš´éœ²çš„ä¸€äº›æ–¹æ³•å¦‚setFieldsValueå¯¹è¡¨å•è¿›è¡Œæ›´æ–°ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™æ˜¯å¦‚ä½•åšåˆ°çš„\r\n\r\n```js\r\nprivate setFieldsValue = (store: Store) => {\r\n  //é˜²æ­¢ç”¨æˆ·åœ¨formç»„ä»¶å¤–ä½¿ç”¨\r\n  this.warningUnhooked();\r\n\r\n  const prevStore = this.store;\r\n  //æ›´æ–°storeæ•°æ®\r\n  if (store) {\r\n    const nextStore = merge(this.store, store);\r\n    this.updateStore(nextStore);\r\n  }\r\n//è¿˜æ˜¯é€šè¿‡notifyObserversè§¦å‘æ‰€æœ‰Fieldçš„onStorechange\r\n  this.notifyObservers(prevStore, null, {\r\n    type: 'valueUpdate',\r\n    source: 'external',\r\n  });\r\n  ......\r\n};\r\n```\r\næœ€åèµ°åˆ°onStorechangeçš„ä»£ç \r\n\r\n```js\r\ncase 'setField': {\r\n  const { data } = info;\r\n  if (namePathMatch) {\r\n    if ('touched' in data) {\r\n      this.touched = data.touched;\r\n    }\r\n    if ('validating' in data && !('originRCField' in data)) {\r\n      this.validatePromise = data.validating ? Promise.resolve([]) : null;\r\n    }\r\n    if ('errors' in data) {\r\n      this.errors = data.errors || EMPTY_ERRORS;\r\n    }\r\n    if ('warnings' in data) {\r\n      this.warnings = data.warnings || EMPTY_ERRORS;\r\n    }\r\n    this.dirty = true;\r\n\r\n    this.triggerMetaEvent();\r\n\r\n    this.reRender();\r\n    return;\r\n  } else if ('value' in data && containsNamePath(namePathList, namePath, true)) {\r\n          // Contains path with value should also check\r\n    this.reRender();\r\n    return;\r\n  }\r\n```\r\nåªæ˜¯å¤šäº†ä¸€äº›æ•°æ®çš„å¤„ç†ï¼Œå…¶ä»–ä»£ç éƒ½å·®ä¸å¤šï¼Œåˆ°è¿™é‡Œformçš„æ›´æ–°å¤§æ¦‚å°±èŠå®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥è¯´è¯´è¡¨å•æ ¡éªŒæ˜¯å¦‚ä½•å®ç°çš„ã€‚\r\n# äºŒÂ·å¦‚ä½•å®ç°æ ¡éªŒ\r\n### å¦‚ä½•è§¦å‘æ ¡éªŒ\r\næƒ³è¦çŸ¥é“æ ¡éªŒçš„å®ç°ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—å…ˆçœ‹çœ‹æœ‰å“ªäº›æ–¹æ³•å¯ä»¥è§¦å‘formè¡¨å•çš„æ ¡éªŒï¼Œé¦–å…ˆæ˜¯formInstanceçš„submit\r\n\r\n```js\r\nprivate submit = () => {\r\n  this.warningUnhooked();\r\n//è¿™ä¸ªå°±æ˜¯æ ¡éªŒç›¸å…³çš„å‡½æ•°\r\n  this.validateFields()\r\n    .then(values => {\r\n      const { onFinish } = this.callbacks;\r\n      if (onFinish) {\r\n        try {\r\n          onFinish(values);\r\n        } catch (err) {\r\n          // Should print error if user `onFinish` callback failed\r\n          console.error(err);\r\n        }\r\n      }\r\n    })\r\n    .catch(e => {\r\n      const { onFinishFailed } = this.callbacks;\r\n      if (onFinishFailed) {\r\n        onFinishFailed(e);\r\n      }\r\n    });\r\n};\r\n}\r\n```\r\nè¿˜æœ‰å½“ä¸€äº›ç”¨æˆ·è¡Œä¸ºè§¦å‘çš„äº‹ä»¶å¦‚onChangeï¼Œå…¶å®è¿™ä¹Ÿæ˜¯åœ¨getControlledé‡Œå¸®æˆ‘ä»¬åŠ«æŒäº†\r\n\r\n```js\r\n\r\n  ...\r\n  //è§¦å‘æ ¡éªŒçš„event nameæ•°ç»„\r\n const validateTriggerList: string[] = toArray(mergedValidateTrigger || []);\r\n\r\n validateTriggerList.forEach((triggerName: string) => {\r\n   // Wrap additional function of component, so that we can get latest value from store\r\n   const originTrigger = control[triggerName];\r\n   //åŠ«æŒå¹¶æ·»åŠ æ ¡éªŒé€»è¾‘\r\n   control[triggerName] = (...args: EventArgs) => {\r\n     if (originTrigger) {\r\n       originTrigger(...args);\r\n     }\r\n\r\n     // å¦‚æœå­˜åœ¨ruleså°±dispatchæ´¾å‘æ ¡éªŒ\r\n     const { rules } = this.props;\r\n     if (rules && rules.length) {\r\n       // We dispatch validate to root,\r\n       // since it will update related data with other field with same name\r\n       dispatch({\r\n         type: 'validateField',\r\n         namePath,\r\n         triggerName,\r\n       });\r\n     }\r\n```\r\nè¿™é‡Œçš„dispatchä¹Ÿä¼šè§¦å‘formInstanceçš„validateFieldsæ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬å°±æŠŠæ³¨æ„åŠ›æ”¾åˆ°è¿™ä¸ªå‡½æ•°ä¸­\r\n### æ ¡éªŒçš„å®ç°\r\n\r\n```js\r\nprivate validateFields: InternalValidateFields = (arg1?: any, arg2?: any) => {\r\n  this.warningUnhooked();\r\n\r\n  let nameList: NamePath[];\r\n  let options: InternalValidateOptions;\r\n  //å¯¹ä¸åŒå½¢å¼ä¼ å…¥å‚æ•°çš„ä¸€äº›å¤„ç†\r\n  if (Array.isArray(arg1) || typeof arg1 === 'string' || typeof arg2 === 'string') {\r\n    nameList = arg1;\r\n    options = arg2;\r\n  } else {\r\n    options = arg1;\r\n  }\r\n  //è·å–ä¼ å…¥çš„Field name\r\n  const provideNameList = !!nameList;\r\n  const namePathList: InternalNamePath[] | undefined = provideNameList\r\n    ? nameList.map(getNamePath)\r\n    : [];\r\n\r\n  // ç”¨æ¥æ”¶é›†åç»­çš„æ ¡éªŒ\r\n  const promiseList: Promise<FieldError>[] = [];\r\n\r\n  //éå†æ¯ä¸ªFieldåˆ¤æ–­æ˜¯å¦éœ€è¦æ ¡éªŒ\r\n  this.getFieldEntities(true).forEach((field: FieldEntity) => {\r\n    // å¦‚æœæ²¡æœ‰ä¼ å…¥namelistå°±æŠŠæ‰€æœ‰FieldåŠ å…¥namePathListä¸­\r\n    if (!provideNameList) {\r\n      namePathList.push(field.getNamePath());\r\n    }\r\n\r\n    // å¦‚æœæ²¡æœ‰é…ç½®ruleå°±ä¸éœ€è¦åç»­æ“ä½œ\r\n    if (!field.props.rules || !field.props.rules.length) {\r\n      return;\r\n    }\r\n\r\n    const fieldNamePath = field.getNamePath();\r\n \r\n\r\n    //è°ƒç”¨Fieldçš„æ ¡éªŒæ–¹æ³•ï¼Œä¿å­˜è¯¥æ–¹æ³•çš„Promise\r\n    if (!provideNameList || containsNamePath(namePathList, fieldNamePath, recursive)) {\r\n      const promise = field.validateRules({\r\n        validateMessages: {\r\n          ...defaultValidateMessages,\r\n          ...this.validateMessages,\r\n        },\r\n        ...options,\r\n      });\r\n\r\n      // å°†ä¿å­˜çš„Promiseæ¨å…¥ä¹‹å‰åˆ›å»ºçš„promiseListä¸­\r\n      promiseList.push(\r\n        promise\r\n          .then<any, RuleError>(() => ({ name: fieldNamePath, errors: [], warnings: [] }))\r\n          .catch((ruleErrors: RuleError[]) => {\r\n          //ä¿ç•™é”™è¯¯å’Œwarnings\r\n            const mergedErrors: string[] = [];\r\n            const mergedWarnings: string[] = [];\r\n            //æ ¹æ®ä¼ å…¥çš„ä¸åŒé…ç½®å¯¹é”™è¯¯è¿›è¡Œä¸åŒå¤„ç†         \r\n            ruleErrors.forEach?.(({ rule: { warningOnly }, errors }) => {\r\n              if (warningOnly) {\r\n                mergedWarnings.push(...errors);\r\n              } else {\r\n                mergedErrors.push(...errors);\r\n              }\r\n            });\r\n             //æ ¹æ®æ˜¯å¦æœ‰é”™è¯¯è¿”å›ä¸åŒç»“æœ\r\n            if (mergedErrors.length) {\r\n              return Promise.reject({\r\n                name: fieldNamePath,\r\n                errors: mergedErrors,\r\n                warnings: mergedWarnings,\r\n              });\r\n            }\r\n\r\n            return {\r\n              name: fieldNamePath,\r\n              errors: mergedErrors,\r\n              warnings: mergedWarnings,\r\n            };\r\n          }),\r\n      );\r\n      }\r\n  });\r\n   //æ”¶é›†æ‰€æœ‰æ£€éªŒé¡¹çš„ç»“æœ\r\n  const summaryPromise = allPromiseFinish(promiseList);\r\n    //å°†è¿™æ¬¡æ ¡éªŒçš„ç»“æœä¿å­˜åœ¨formInstanceä¸­\r\n  this.lastValidatePromise = summaryPromise;\r\n\r\n  // Notify fields with rule that validate has finished and need update\r\n  summaryPromise\r\n    .catch(results => results)\r\n    .then((results: FieldError[]) => {\r\n      const resultNamePathList: InternalNamePath[] = results.map(({ name }) => name);\r\n      //é€šçŸ¥Fieldè¿›è¡Œæ›´æ–°\r\n      this.notifyObservers(this.store, resultNamePathList, {\r\n        type: 'validateFinish',\r\n      });\r\n      this.triggerOnFieldsChange(resultNamePathList, results);\r\n    });\r\n    //è¿™ä¸ªPromiseå°†ä¼šè¢«ä½œä¸ºè¿”å›å€¼ï¼Œåœ¨submitçš„æ—¶å€™ä¼šèµ·åˆ°ä½œç”¨\r\n  const returnPromise: Promise<Store | ValidateErrorEntity | string[]> = summaryPromise\r\n    .then((): Promise<Store | string[]> => {\r\n    //å¦‚æœæ²¡æœ‰è§„åˆ™é”™è¯¯å°±ç›´æ¥è¿”å›æ‰€æœ‰æ ¡éªŒé¡¹çš„å€¼\r\n      if (this.lastValidatePromise === summaryPromise) {\r\n        return Promise.resolve(this.getFieldsValue(namePathList));\r\n      }\r\n      return Promise.reject<string[]>([]);\r\n    })\r\n    .catch((results: { name: InternalNamePath; errors: string[] }[]) => {\r\n    //å­˜åœ¨é”™è¯¯å°†é”™è¯¯æ•´ç†è¿”å›\r\n      const errorList = results.filter(result => result && result.errors.length);\r\n      return Promise.reject({\r\n        values: this.getFieldsValue(namePathList),\r\n        errorFields: errorList,\r\n        outOfDate: this.lastValidatePromise !== summaryPromise,\r\n      });\r\n    });\r\n\r\n  // Do not throw in console\r\n  returnPromise.catch<ValidateErrorEntity>(e => e);\r\n\r\n  return returnPromise as Promise<Store>;\r\n  };\r\n```\r\nè¿™é‡Œçš„ä»£ç æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬æ¥æ•´ç†ä¸€ä¸‹å…³é”®çš„åœ°æ–¹ï¼šå¦‚æœä¼ å…¥äº†nameListé‚£ä¹ˆä¼šå¯¹nameListå¯¹åº”çš„Fieldè¿›è¡Œæ ¡éªŒï¼Œå¦åˆ™å°±ä¼šå…¨éƒ¨æ ¡éªŒï¼Œå½“ç„¶ä»–ä»¬éœ€è¦ä¼ å…¥äº†rulesï¼Œè€Œè¿™é‡Œçš„æ ¡éªŒæ–¹æ³•å…¶å®æ˜¯è°ƒç”¨çš„Fieldç»„ä»¶çš„validateRulesæ–¹æ³•ï¼Œè¿™ä¸ªå‡½æ•°æˆ‘ä»¬åç»­ä¼šåˆ†æï¼Œç„¶åæˆ‘ä»¬ä¼šæŠŠvalidateRulesè¿”å›çš„promiseæ”¶é›†åˆ°promiseListä¸­ï¼Œé€šè¿‡allPromiseFinishå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°æ ¡éªŒç»“æœçš„æ•°ç»„äº†ï¼Œæ¥ä¸‹æ¥ä¸»è¦å°±æ˜¯2ä»¶äº‹ï¼Œä¸€æ˜¯é€šçŸ¥å¯¹åº”çš„Fieldè¿›è¡Œæ›´æ–°ï¼ŒäºŒæ˜¯æ ¹æ®æ ¡éªŒç»“æœè¿”å›Promiseä½œä¸º onFinishFailedå’ŒonFinishçš„è§¦å‘ä¾æ®ï¼Œè¿™é‡Œçš„é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ã€‚æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹Fieldç»„ä»¶ä¸­çš„validateRulesæ–¹æ³•\r\n\r\n```js\r\npublic validateRules = (options?: InternalValidateOptions): Promise<RuleError[]> => {\r\n\r\n  const namePath = this.getNamePath();\r\n  const currentValue = this.getValue();\r\n\r\n  const { triggerName, validateOnly = false } = options || {};\r\n  \r\n  const rootPromise = Promise.resolve().then(async (): Promise<any[]> => {\r\n    if (!this.mounted) {\r\n      return [];\r\n    }\r\n\r\n    const { validateFirst = false, messageVariables, validateDebounce } = this.props;\r\n\r\n    // å¯¹ruleçš„ä¸€äº›è¿‡æ»¤ï¼Œè¿™é‡Œä¸»è¦æ˜¯æ’é™¤ç©ºæ ¡éªŒå’Œè§¦å‘æ—¶æœºä¸æ»¡è¶³çš„\r\n    let filteredRules = this.getRules();\r\n    if (triggerName) {\r\n      filteredRules = filteredRules\r\n        .filter(rule => rule)\r\n        .filter((rule: RuleObject) => {\r\n          const { validateTrigger } = rule;\r\n          if (!validateTrigger) {\r\n            return true;\r\n          }\r\n          const triggerList = toArray(validateTrigger);\r\n          return triggerList.includes(triggerName);\r\n        });\r\n    }\r\n    \r\n     ......\r\n     \r\n    //å…¶å®è¿™ä¸ªpromiseå°±æ˜¯åŒ…å«äº†å½“å‰æ£€éªŒç»“æœçš„promise\r\n    const promise = validateRules(\r\n      namePath,\r\n      currentValue,\r\n      filteredRules,\r\n      options,\r\n      validateFirst,\r\n      messageVariables,\r\n    );\r\n\r\n    promise\r\n      .catch(e => e)\r\n      .then((ruleErrors: RuleError[] = EMPTY_ERRORS) => {\r\n        if (this.validatePromise === rootPromise) {\r\n          this.validatePromise = null;\r\n\r\n          //æ ¹æ®optionå¤„ç†æ•°æ®è·Ÿå‰é¢ç›¸ä¼¼\r\n          const nextErrors: string[] = [];\r\n          const nextWarnings: string[] = [];\r\n          ruleErrors.forEach?.(({ rule: { warningOnly }, errors = EMPTY_ERRORS }) => {\r\n            if (warningOnly) {\r\n              nextWarnings.push(...errors);\r\n            } else {\r\n              nextErrors.push(...errors);\r\n            }\r\n          });\r\n           æŠŠç»“æœå­˜å‚¨åœ¨å½“å‰Fieldä¸Š\r\n          this.errors = nextErrors;\r\n          this.warnings = nextWarnings;\r\n          this.triggerMetaEvent();\r\n          this.reRender();\r\n        }\r\n      });\r\n\r\n    return promise;\r\n  });\r\n\r\n  if (validateOnly) {\r\n    return rootPromise;\r\n  }\r\n  //ä¸€äº›æ•°æ®çš„æ›´æ–°\r\n  this.validatePromise = rootPromise;\r\n  this.dirty = true;\r\n  this.errors = EMPTY_ERRORS;\r\n  this.warnings = EMPTY_ERRORS;\r\n  this.triggerMetaEvent();\r\n\r\n  // Force trigger re-render since we need sync renderProps with new meta\r\n  this.reRender();\r\n  //å¯ä»¥çœ‹åˆ°æ­£å¸¸æµç¨‹ä¸‹å…¶å®å°±æ˜¯è¿”å›çš„validateRules(...args)çš„promiseç»“æœ\r\n  return rootPromise;\r\n  };\r\n```\r\næ‰€ä»¥è¿™é‡Œçš„å¤§éƒ¨åˆ†ä»£ç è¿˜æ˜¯åœ¨è¿›è¡Œæµç¨‹çš„ä¸²è”å’ŒFieldå†…éƒ¨çŠ¶æ€çš„ä¸€äº›å¤„ç†ï¼Œæ ¡éªŒç›¸å…³çš„è¿˜æ˜¯ä¹Ÿå¹¶éåœ¨è¿™é‡Œå®ç°ï¼Œå…¶å®rc-field-formçš„è¡¨å•æ ¡éªŒä¾èµ–äº†rc-component/async-validatorï¼Œç„¶åå¯¹å…¶è¿›è¡Œäº†ä¸€äº›å°è£…ï¼Œè¿™é‡Œä¹Ÿä¸åšè¿‡å¤šä»‹ç»äº†ã€‚\r\n# ä¸‰ ä¸€äº›å…¶ä»–åŠŸèƒ½\r\nä¸Šé¢èŠå®Œäº†formçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ä¸€çœ‹ä¸€äº›æ¯”è¾ƒå¥½ç”¨çš„ç‰¹æ€§.\r\né¦–å…ˆæ˜¯listç»„ä»¶ï¼Œè¿™é‡Œæˆ‘æ”¾ä¸€ä¸ª[antdçš„ä¾‹å­](https://ant.design/components/form-cn#components-form-demo-dynamic-form-item)ï¼Œä¸ç†Ÿæ‚‰çš„å¯ä»¥å»äº†è§£ä¸€ä¸‹æ•ˆæœã€‚\r\n### List\r\n\r\n```js\r\n <List name='xxx'>\r\n {(fields, { add, remove }, { errors }) => (\r\n          <>\r\n            {fields.map((field, index) => (\r\n                <Field\r\n                  {...field}\r\n                >\r\n                  <Input placeholder=\"passenger name\"/>\r\n                </Field>\r\n            ))}\r\n          </>\r\n        )}\r\n      </List>\r\n```\r\nå¤§æ¦‚çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸Šï¼Œæˆ‘ä»¬éœ€è¦ç»™Listç»„ä»¶ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œç„¶ååœ¨è¿™ä¸ªå‡½æ•°é‡Œé€šè¿‡ç»„ä»¶ç»™æˆ‘ä»¬çš„fieldså‚æ•°è¿›è¡Œéå†æ¸²æŸ“å‡ºæ¯ä¸ªFieldï¼ŒåŒæ—¶ä»–ä¹Ÿç»™æˆ‘ä»¬æä¾›äº†ä¸€äº›æ–¹æ³•å¯¹æ•°æ®è¿›è¡Œæ“æ§ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹å¦‚ä½•å®ç°ã€‚å…ˆè´´å‡ºè¿™ä¸ªç»„ä»¶çš„ä»£ç ï¼Œç„¶åæˆ‘ä»¬æ¥æ…¢æ…¢åˆ†æã€‚\r\n\r\n```js\r\nfunction List<Values = any>({\r\n  name,\r\n  initialValue,\r\n  children,\r\n  rules,\r\n  validateTrigger,\r\n  isListField,\r\n}: ListProps<Values>) {\r\n//å­˜æ”¾äº†formInstanceå’ŒvalidateTrigger\r\n  const context = React.useContext(FieldContext);\r\n  //ç°åœ¨è¿™é‡Œè¿˜æ²¡æœ‰ä¸œè¥¿\r\n  const wrapperListContext = React.useContext(ListContext);\r\n  const keyRef = React.useRef({\r\n    keys: [],\r\n    id: 0,\r\n  });\r\n  const keyManager = keyRef.current;\r\n  //è·å–å½“å‰çš„Fieldname\r\n  const prefixName: InternalNamePath = React.useMemo(() => {\r\n    const parentPrefixName = getNamePath(context.prefixName) || [];\r\n    return [...parentPrefixName, ...getNamePath(name)];\r\n  }, [context.prefixName, name]);\r\n  //åˆ›å»ºcontextä¼ é€’firminstanceå’Œname\r\n  const fieldContext = React.useMemo(() => ({ ...context, prefixName }), [context, prefixName]);\r\n\r\n  // åˆ›å»ºlistçš„context\r\n  const listContext = React.useMemo<ListContextProps>(\r\n    () => ({\r\n      getKey: (namePath: InternalNamePath) => {\r\n        const len = prefixName.length;\r\n        const pathName = namePath[len];\r\n        return [keyManager.keys[pathName], namePath.slice(len + 1)];\r\n      },\r\n    }),\r\n    [prefixName],\r\n  );\r\n  // listç»„ä»¶çš„childrenåªèƒ½ä¼ å…¥å‡½æ•°\r\n  if (typeof children !== 'function') {\r\n    warning(false, 'Form.List only accepts function as children.');\r\n    return null;\r\n  }\r\n //è¾…åŠ©æ›´æ–°\r\n  const shouldUpdate = (prevValue: StoreValue, nextValue: StoreValue, { source }) => {\r\n    if (source === 'internal') {\r\n      return false;\r\n    }\r\n    return prevValue !== nextValue;\r\n  };\r\n \r\n  return (\r\n    <ListContext.Provider value={listContext}>\r\n      <FieldContext.Provider value={fieldContext}>\r\n        <Field\r\n          name={[]}\r\n          shouldUpdate={shouldUpdate}\r\n          rules={rules}\r\n          validateTrigger={validateTrigger}\r\n          initialValue={initialValue}\r\n          isList\r\n          isListField={isListField ?? !!wrapperListContext}\r\n        >\r\n         .........\r\n         \r\n        </Field>\r\n      </FieldContext.Provider>\r\n    </ListContext.Provider>\r\n  );\r\n}\r\n```\r\nçœ‹åˆ°è¿™é‡Œå…¶å®æˆ‘ä»¬èƒ½å¤Ÿå‘ç°ï¼Œlistç»„ä»¶å…¶å®è¿˜æ˜¯æ ¹æ®Fieldç»„ä»¶è¿›è¡Œçš„å°è£…ï¼Œç°åœ¨æˆ‘ä»¬å†æ¥çœ‹çœ‹Fieldç»„ä»¶é‡Œéƒ½æœ‰ä»€ä¹ˆä¸œè¥¿\r\n\r\n```js\r\n{({ value = [], onChange }, meta) => {\r\n  const { getFieldValue } = context;\r\n  //è·å–å½“å‰Filedç»´æŠ¤çš„å€¼\r\n  const getNewValue = () => {\r\n      const values = getFieldValue(prefixName || []) as StoreValue[];\r\n      return values || [];\r\n };\r\n    const operations: ListOperations = {\r\n      add: (defaultValue, index?: number) => {\r\n         // Mapping keys\r\n        const newValue = getNewValue();\r\n        console.log(newValue,defaultValue)\r\n         if (index >= 0 && index <= newValue.length) {\r\n          keyManager.keys = [\r\n             ...keyManager.keys.slice(0, index),\r\n            keyManager.id,\r\n             ...keyManager.keys.slice(index),\r\n          ];\r\n          onChange([...newValue.slice(0, index), defaultValue, ...newValue.slice(index)]);\r\n         } else {\r\n          if (\r\n             process.env.NODE_ENV !== 'production' &&\r\n            (index < 0 || index > newValue.length)\r\n           ) {\r\n             warning(\r\n                false,\r\n               'The second parameter of the add function should be a valid positivenumber.',\r\n             );\r\n           }\r\n           keyManager.keys = [...keyManager.keys, keyManager.id];\r\n           console.log(keyManager)\r\n           onChange([...newValue, defaultValue]);\r\n        }\r\n         keyManager.id += 1;\r\n      }ï¼Œ\r\n\r\n     let listValue = value || [];\r\n     if (!Array.isArray(listValue)) {\r\n      listValue = [];\r\n\r\n       if (process.env.NODE_ENV !== 'production') {\r\n         warning(\r\n           false,\r\n           `Current value of '${prefixName.join(' > ')}' is not an array type.`,\r\n         );\r\n       }\r\n     }\r\n\r\n    return children(\r\n      (listValue as StoreValue[]).map((__, index): ListField => {\r\n        let key = keyManager.keys[index];\r\n        if (key === undefined) {\r\n         keyManager.keys[index] = keyManager.id;\r\n            key = keyManager.keys[index];\r\n            keyManager.id += 1;\r\n          }\r\n\r\n         return {\r\n           name: index,\r\n           key,\r\n           isListField: true,\r\n         };\r\n       }),\r\n       operations,\r\n       meta,\r\n     );\r\n    }}\r\n```\r\n é¦–å…ˆæˆ‘ä»¬æ³¨æ„åˆ°ï¼ŒFieldç»„ä»¶é‡Œæˆ‘ä»¬ä¼ å…¥çš„ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™é‡Œéœ€è¦å…ˆå¸¦å¤§å®¶å¤ä¹ ä¸€ä¸‹ï¼Œåœ¨Fieldç»„ä»¶ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä¼ å…¥çš„childæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆä¼šä¼ å…¥getControlled(), meta,fieldContextè¿™3ä¸ªå‚æ•°(ç›¸å…³å‡½æ•°getOnlyChild )ï¼Œå¹¶å°†å‡½æ•°çš„è¿”å›å€¼ä½œä¸ºæœ€ç»ˆçš„child,metaå…¶å®å°±æ˜¯Fieldçš„ä¸€äº›çŠ¶æ€ï¼Œæ¥ä¸‹æ¥æ¥çœ‹çœ‹operations\r\n\r\n```js\r\n   const operations: ListOperations = {\r\n      add: (defaultValue, index?: number) => {\r\n         // å…¶å®è¿™é‡Œè·å–çš„å°±æ˜¯å½“å‰çš„å€¼\r\n        const newValue = getNewValue();\r\n        å¦‚æœä¼ å…¥äº†indexå¹¶ä¸”indexæ²¡æœ‰è¶…å‡ºå½“å‰indexå°±æ’å…¥\r\n         if (index >= 0 && index <= newValue.length) {\r\n          keyManager.keys = [\r\n             ...keyManager.keys.slice(0, index),\r\n            keyManager.id,\r\n             ...keyManager.keys.slice(index),\r\n          ];\r\n          //ä¸€ä¸ªonChangeæ–¹æ³•ï¼Œä¼ å…¥äº†æ–°å€¼\r\n          onChange([...newValue.slice(0, index), defaultValue, ...newValue.slice(index)]);\r\n         } else {\r\n          if (\r\n             process.env.NODE_ENV !== 'production' &&\r\n            (index < 0 || index > newValue.length)\r\n           ) {\r\n           //ä¸€äº›é”™è¯¯å¤„ç†\r\n             warning(\r\n                false,\r\n               'The second parameter of the add function should be a valid positivenumber.',\r\n             );\r\n           }\r\n           //å¦è€…é»˜è®¤å°†å€¼æ›´æ–°åˆ°æœ€å\r\n           keyManager.keys = [...keyManager.keys, keyManager.id];\r\n           onChange([...newValue, defaultValue]);\r\n        }\r\n         keyManager.id += 1;\r\n      }ï¼Œ\r\n```\r\nå…¶å®è¿™ä¸€éƒ¨åˆ†å°±æ˜¯ç»´æŠ¤äº†ä¸€ä¸ªå¯¹è±¡ï¼Œæä¾›äº†ä¹‹å‰addç­‰ä¸€äº›ä¿®æ”¹æ•°æ®çš„æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•è¿™é‡Œçœç•¥äº†ã€‚\r\n\r\n```js\r\n let listValue = value || [];\r\n if (!Array.isArray(listValue)) {\r\n   listValue = [];\r\n\r\n   if (process.env.NODE_ENV !== 'production') {\r\n      warning(false,`Current value of '${prefixName.join(' > ')}' is not an array type.`);\r\n    }\r\n }\r\n```\r\nè¿™é‡Œä¹Ÿå¾ˆç®€å•ï¼Œå¯¹listvalueè¿›è¡Œäº†ä¸€äº›åˆ¤æ–­ï¼Œæ¥ä¸‹æ¥æ˜¯æœ€åçš„ä¸€éƒ¨åˆ†\r\n\r\n```js\r\n     return children(\r\n       (listValue as StoreValue[]).map((__, index): ListField => {\r\n         let key = keyManager.keys[index];\r\n         if (key === undefined) {\r\n           keyManager.keys[index] = keyManager.id;\r\n           key = keyManager.keys[index];\r\n           keyManager.id += 1;\r\n         }\r\n\r\n         return {\r\n           name: index,\r\n           key,\r\n           isListField: true,\r\n         };\r\n       }),\r\n       operations,\r\n       meta,\r\n     );\r\n```\r\nè¿™é‡Œçš„childrenæ˜¯ä»€ä¹ˆå‘¢ï¼Œå…¶å®è¿™é‡Œçš„childrenå°±æ˜¯æˆ‘ä»¬åœ¨Listç»„ä»¶é‡Œä¼ å…¥çš„å‡½æ•°ï¼Œè¿™æ ·çš„è¯å°±å¾ˆæ˜æ˜¾äº†Listç»„ä»¶å¸®å…¶å®å°±æ˜¯å¸®æˆ‘ä»¬è¿›è¡Œäº†æ•°æ®ç®¡ç†ï¼Œå¹¶å°†æ“ä½œæ•°æ®çš„æ–¹æ³•æš´éœ²ç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹æœ€å¼€å§‹æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨Listç»„ä»¶çš„\r\n\r\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d444717d4fbd4ef093f83dd6caf141e9~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1018&h=362&s=28328&e=png&b=f8f8f8)\r\nè¿™é‡Œä¼ é€’çš„filedå±æ€§å…¶å®å°±æŠŠè¿™æ ·çš„å±æ€§ä¼ é€’ç»™äº†Fieldã€‚\r\n\r\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7a829367ec294c9b95363a2581ac74f6~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=340&h=87&s=18232&e=png&b=202021)  \r\næ¥ç€æˆ‘ä»¬å†æ¥çœ‹çœ‹Listç»„ä»¶ä¸ºä»€ä¹ˆèƒ½å¤Ÿåšåˆ°å¯¹å­æ•°æ®çš„ç»Ÿä¸€ç®¡ç†å‘¢ã€‚  \r\n ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¯”å¦‚æˆ‘ä»¬ç»´æŠ¤äº†ä¸€ä¸ªusersçš„Fieldæ•°ç»„ï¼Œé‚£ä¹ˆä»–çš„æ•°æ®ç»“æ„å¤§æ¦‚æ˜¯ *users:['xiaomin','xiaozhang']*,å½“æˆ‘ä»¬é€šè¿‡listç»„ä»¶æš´éœ²å‡ºæ¥çš„æ–¹æ³•å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶å› ä¸ºlistç»„ä»¶æ˜¯åŸºäºFieldçš„å°è£…ï¼Œæ‰€ä»¥è¿™äº›ä¿®æ”¹ä¼šè§¦å‘onStoreChangeè®©listç»„ä»¶rerenderï¼Œè€Œå…¶ä¸­çš„å­Fieldè‡ªç„¶ä¹Ÿä¼šé‡æ–°æ¸²æŸ“ï¼Œé‚£ä¹ˆå­Fieldæ˜¯å¦‚ä½•è·å–æ­£ç¡®çš„å€¼å‘¢ï¼Œçœ‹ä¸Šé¢é‚£å¼ å›¾ï¼Œæˆ‘ä»¬ç»™å­ç»„ä»¶ä¼ é€’äº†ä¸€ä¸ªkeyï¼Œåœ¨getControlledçš„æ—¶å€™ï¼ŒFieldä¼šè°ƒç”¨getValueæ–¹æ³•è·å–å€¼ï¼Œå…¶å®è¿™ä¸ªgetValueå‡½æ•°å°±ç±»ä¼¼ä¸lodashä¸­çš„getæ–¹æ³•ï¼Œè€Œå¦‚æœä¸€ä¸ªFieldæ˜¯listFieldçš„è¯ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬è·å–namePathæ—¶å…¶å®ä¸€ç§ [parentName,key] çš„å½¢å¼\r\n\r\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/98f7336c717643948c80631320734068~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=143&h=42&s=1501&e=png&b=fffefe)\r\næ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®è¿™ä¸ªè·å–æ–°å€¼è¾¾åˆ°æ›´æ–°çš„æ•ˆæœï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ç‚¹ï¼ŒæŸä¸ªå­Fieldçš„æ›´æ–°å…¶å®æ˜¯ä¸ä¼šå½±å“åˆ°Listç»„ä»¶çš„ã€‚\r\n### dependence\r\næœ€åæˆ‘ä»¬å†æ¥èŠä¸€èŠå¦ä¸€ä¸ªåŠŸèƒ½ï¼Œdependence.è¿™é‡Œè¿˜æ˜¯ç»™å‡ºä¸€ä¸ª[antdçš„ä¾‹å­](https://ant.design/components/form-cn#components-form-demo-form-dependencies)ï¼Œç®€å•çš„è¯´ï¼Œå°±æ˜¯æˆ‘ä»¬å¯ä»¥ç»™æŸä¸ªFliedé…ç½®dependenceå­—æ®µï¼Œå½“dependenceæ•°ç»„ä¸­åŒ…å«çš„Fieldè§¦å‘äº†æ›´æ–°ï¼Œè¿™ä¸ªFieldä¹Ÿä¼šåŒæ­¥è§¦å‘æ›´æ–°ã€‚ ä¸‹é¢æ˜¯rc-field-formå®˜æ–¹demoï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•ä¸€ä¸‹ã€‚å½“nameä¸º1æ—¶å¯ä»¥çœ‹åˆ°passwordæ¸²æŸ“ï¼Œç„¶åpasswordå¦‚æœä¸ä¸ºç©ºåˆ™password2æ¸²æŸ“ ï¼Œ**åæ¥åœ¨å†™æ–‡ç« çš„æ—¶å€™æ„Ÿè§‰è¿™ä¸ªä¾‹å­æ˜¯æœ‰é—®é¢˜çš„ï¼Œæˆ‘ä»¬ä¸€ä¼šå†åˆ†æ**\r\n\r\n```js\r\nimport Form, { Field } from 'rc-field-form';\r\nimport React from 'react';\r\nimport Input from './components/Input';\r\n\r\ntype FormData = {\r\n  name?: string;\r\n  password?: string;\r\n  password2?: string;\r\n};\r\n\r\nexport default () => {\r\n  const [form] = Form.useForm();\r\n\r\n  return (\r\n    <Form\r\n      form={form}\r\n      preserve={false}\r\n      onFieldsChange={fields => {\r\n        console.error('fields:', fields);\r\n      }}\r\n    >\r\n      <Field<FormData> name=\"name\">\r\n        <Input placeholder=\"Username\" />\r\n      </Field>\r\n\r\n      <Field<FormData> dependencies={['name']}>\r\n        {() => {\r\n          return form.getFieldValue('name') === '1' ? (\r\n            <Field name=\"password\">\r\n              <Input placeholder=\"Password\" />\r\n            </Field>\r\n          ) : null;\r\n        }}\r\n      </Field>\r\n\r\n      <Field dependencies={['password']}>\r\n        {() => {\r\n          const password = form.getFieldValue('password');\r\n          console.log('>>>', password);\r\n          return password ? (\r\n            <Field<FormData> name={['password2']}>\r\n              <Input placeholder=\"Password 2\" />\r\n            </Field>\r\n          ) : null;\r\n        }}\r\n      </Field>\r\n\r\n      <button onClick={()=} type=\"submit\">Submit</button>\r\n    </Form>\r\n  );\r\n};\r\n```\r\nè¿™é‡Œæˆ‘ä»¬ç›´æ¥æ¥è®²ä»–æ˜¯å¦‚ä½•å®ç°çš„,æˆ‘çœ‹äº†ä¸€ä¸‹æºç ç„¶åå†™demoæµ‹è¯•åå‘ç°åœ¨rc-field-formé‡Œå¦‚æœæˆ‘ä»¬é€šè¿‡å¦‚setFieldValueè¿™æ ·çš„apiæ˜¯æ— æ³•è§¦å‘dependenceæ›´æ–°çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å°±åªèŠé€šè¿‡onChangeç­‰è¡Œä¸ºè§¦å‘çš„æ›´æ–°ã€‚\r\n\r\n```js\r\n  private updateValue = (name: NamePath, value: StoreValue) => {\r\n  \r\n   ......\r\n\r\n    const childrenFields = this.triggerDependenciesUpdate(prevStore, namePath);\r\n   ......\r\n  };\r\n```\r\nå¯ä»¥çœ‹åˆ°å…·ä½“çš„é€»è¾‘æ˜¯ç”±**updateValue**å¼€å§‹çš„ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹**triggerDependenciesUpdate**å¹²äº†å•¥\r\n\r\n```js\r\n  private triggerDependenciesUpdate = (prevStore: Store, namePath: InternalNamePath) => {\r\n  //è¿™ä¸ªå‡½æ•°ç­‰ä¼šè®²ï¼Œå…¶å®å°±æ˜¯æ‹¿åˆ°ä¾èµ–äºå½“å‰å­—æ®µçš„Field\r\n    const childrenFields = this.getDependencyChildrenFields(namePath);\r\n    //å¯¹ä¾èµ–äºå½“å‰å­—æ®µçš„Fieldè¿›è¡Œæ ¡éªŒ\r\n    if (childrenFields.length) {\r\n      this.validateFields(childrenFields);\r\n    }\r\n    //é€šçŸ¥æ›´æ–°\r\n    this.notifyObservers(prevStore, childrenFields, {\r\n      type: 'dependenciesUpdate',\r\n      relatedFields: [namePath, ...childrenFields],\r\n    });\r\n\r\n    return childrenFields;\r\n  };\r\n\r\n```\r\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹**getDependencyChildrenFields**è¿™ä¸ªæ–¹æ³•ï¼Œ\r\n\r\n```js\r\n  private getDependencyChildrenFields = (rootNamePath: InternalNamePath): InternalNamePath[] => {   \r\n    const children: Set<FieldEntity> = new Set();\r\n    //è¿”å›å€¼ï¼Œè¿™ä¸ªæ˜¯è¢«æ‰“å¹³çš„denpendence\r\n    const childrenFields: InternalNamePath[] = [];\r\n    //ç”¨äºå­˜å‚¨ä¾èµ–çš„map\r\n    const dependencies2fields: NameMap<Set<FieldEntity>> = new NameMap();\r\n    \r\n    ........\r\n    \r\n    return childrenFields;\r\n  };\r\n```\r\næ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“çš„å¤„ç†ï¼Œé¦–å…ˆæ˜¯æ„å»ºä¾èµ–map\r\n\r\n```js\r\n    this.getFieldEntities().forEach(field => {\r\n      console.log(field.props.dependencies)\r\n      const { dependencies } = field.props;\r\n      (dependencies || []).forEach(dependency => {\r\n        const dependencyNamePath = getNamePath(dependency);\r\n        dependencies2fields.update(dependencyNamePath, (fields = new Set()) => {\r\n          fields.add(field);\r\n          return fields;\r\n        });\r\n      });\r\n    });\r\n```\r\nä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœCå’ŒDä¾èµ–Bï¼ŒBä¾èµ–Aï¼Œè¿™æ ·å°±ä¼šåˆ›å»ºå‡ºè¿™æ ·çš„mapæ¥ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·çš„æ“ä½œå‘¢ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥æƒ³ä¸€ä¸‹ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè™½ç„¶Cï¼ŒDçš„dependenceæ˜¯Bï¼Œä½†æ˜¯BåŒæ—¶ä¹Ÿä¾èµ–äºAï¼Œé‚£ä¹ˆå¦‚æœAè§¦å‘äº†æ›´æ–°ï¼ŒCå’ŒDä¹Ÿåº”è¯¥æ›´æ–°ï¼Œæ‰€ä»¥**getDependencyChildrenFields**å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§å¾ªç¯ä¾èµ–ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†dependenceMapï¼Œæ¥ä¸‹æ¥å°±éœ€è¦é€šè¿‡è¿™ä¸ªmapè·å–æ‰€æœ‰çš„ä¾èµ–\r\n\r\n```js\r\n{\r\n    A: [FieldB],\r\n    B: [FieldCï¼ŒFieldD]\r\n}\r\n\r\n```\r\n\r\n```js\r\n    const fillChildren = (namePath: InternalNamePath) => {\r\n      //è·å–ç›´æ¥ä¾èµ–äºå®ƒçš„Field\r\n      const fields = dependencies2fields.get(namePath) || new Set();\r\n      //æŸ¥çœ‹æ˜¯å¦æœ‰Fieldé—´æ¥ä¾èµ–\r\n      fields.forEach(field => {\r\n      //åªåˆ¤æ–­æœªåˆ¤æ–­è¿‡çš„\r\n        if (!children.has(field)) {\r\n          children.add(field);\r\n\r\n          const fieldNamePath = field.getNamePath();\r\n          if (fieldNamePath.length) {\r\n            childrenFields.push(fieldNamePath);\r\n            fillChildren(fieldNamePath);\r\n          }\r\n        }\r\n      });\r\n    };\r\n\r\n    fillChildren(rootNamePath);\r\n```\r\nè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°æ‰€æœ‰ä¾èµ–çš„Fieldäº†ï¼Œæˆ‘ä»¬ç»§ç»­å›åˆ°æ›´æ–°çš„æµç¨‹ã€‚\r\n\r\n```js\r\n    this.notifyObservers(prevStore, childrenFields, {\r\n      type: 'dependenciesUpdate',\r\n      relatedFields: [namePath, ...childrenFields],\r\n    });\r\n```\r\nè¿™é‡Œå·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œé€šè¿‡notifyObserverè°ƒç”¨æ‰€æœ‰Fieldçš„onStoreChangeï¼Œæˆ‘ä»¬ç›´æ¥çœ‹åœ¨onStoreChangeé‡Œè¿›è¡Œäº†å“ªäº›æ“ä½œ\r\n\r\n```js\r\n\r\n      case 'dependenciesUpdate': {\r\n        //è·å–å½“å‰Fieldçš„dependence\r\n        const dependencyList = dependencies.map(getNamePath);\r\n        //å¦‚æœæŸä¸ªä¾èµ–è¢«åŒ…å«åœ¨relatedFieldsä¸­å°±è§¦å‘æ›´æ–°\r\n        if (dependencyList.some(dependency => containsNamePath(info.relatedFields, dependency))) {\r\n          this.reRender();\r\n          return;\r\n        }\r\n        break;\r\n      }\r\n```\r\nå…¶å®è¿™é‡Œä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥dependenceçš„æµç¨‹æˆ‘ä»¬ä¹Ÿåˆ†æå®Œäº†ã€‚  \r\næœ€åå°±æ˜¯è¯´è¯´åˆšæ‰æˆ‘æåˆ°äº†å®˜æ–¹çš„demoæœ‰é—®é¢˜ï¼Œä¸‹é¢å°±æ¥è°ˆè°ˆä¸ºä»€ä¹ˆæœ‰é—®é¢˜ã€‚è¿˜æ˜¯å…ˆæ”¾ä¸€ä¸‹ä»£ç \r\n\r\n```js\r\n```js\r\nimport Form, { Field } from 'rc-field-form';\r\nimport React from 'react';\r\nimport Input from './components/Input';\r\n\r\ntype FormData = {\r\n  name?: string;\r\n  password?: string;\r\n  password2?: string;\r\n};\r\n\r\nexport default () => {\r\n  const [form] = Form.useForm();\r\n\r\n  return (\r\n    <Form\r\n      form={form}\r\n      preserve={false}\r\n      onFieldsChange={fields => {\r\n        console.error('fields:', fields);\r\n      }}\r\n    >\r\n      <Field<FormData> name=\"name\">\r\n        <Input placeholder=\"Username\" />\r\n      </Field>\r\n\r\n      <Field<FormData> dependencies={['name']}>\r\n        {() => {\r\n          return form.getFieldValue('name') === '1' ? (\r\n            <Field name=\"password\">\r\n              <Input placeholder=\"Password\" />\r\n            </Field>\r\n          ) : null;\r\n        }}\r\n      </Field>\r\n\r\n      <Field dependencies={['password']}>\r\n        {() => {\r\n          const password = form.getFieldValue('password');\r\n          console.log('>>>', password);\r\n          return password ? (\r\n            <Field<FormData> name={['password2']}>\r\n              <Input placeholder=\"Password 2\" />\r\n            </Field>\r\n          ) : null;\r\n        }}\r\n      </Field>\r\n\r\n      <button onClick={()=} type=\"submit\">Submit</button>\r\n    </Form>\r\n  );\r\n};\r\n```\r\né¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨å®˜æ–¹demoä¸­æ¯ä¸ªé…ç½®äº†dependenceçš„Filedå­—æ®µå…¶å®æ˜¯æ²¡æœ‰é…ç½®nameçš„ï¼Œä½†æ˜¯å½“æˆ‘ä»¬æ„å»ºchildrenFieldsæ—¶æ˜¯éœ€è¦è·å–Fieldçš„nameçš„ï¼Œè¿™å°±å¯¼è‡´äº†è·å–childrenFieldså…¶å®æ˜¯è·å–äº†ä¸€ä¸ªç©ºæ•°ç»„ï¼Œè¿™æ ·çœ‹æ¥ï¼Œå¦‚æœå½“å‰name=1,passwordå­˜åœ¨valueï¼Œç„¶åæˆ‘ä»¬æ”¹å˜nameçš„å€¼ï¼Œpasswordå’Œpassword1éƒ½ä¸ä¼šéšè—ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å‘ç°è¿™ä¸ªdemoè¿è¡Œèµ·æ¥å…¶å®æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ã€‚  \r\nå…³é”®åœ¨è¿™é‡Œï¼š\r\n\r\n```js\r\n    this.notifyObservers(prevStore, childrenFields, {\r\n      type: 'dependenciesUpdate',\r\n      relatedFields: [namePath, ...childrenFields],\r\n    });\r\n```\r\næˆ‘ä»¬åœ¨è§¦å‘dependenceæ›´æ–°çš„æ—¶å€™åœ¨relatedFieldsä¸­è¿˜æŠŠè§¦å‘æ›´æ–°çš„Field nameä¼ é€’äº†è¿‡å»ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯'name',æ‰€ä»¥å½“æˆ‘ä»¬è§¦å‘æ‰€æœ‰ç»„ä»¶çš„onStoreChangeï¼Œpasswordæ˜¯èƒ½å¤Ÿæ›´æ–°çš„ï¼Œé‚£password1åˆæ˜¯å¦‚ä½•æ­£ç¡®æ›´æ–°çš„å‘¢ï¼Ÿ\r\n\r\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/81e16c73048f4503b22dc41a989bde02~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=828&h=262&s=141570&e=png&b=222023)\r\nè¿˜è®°å¾—è¿™ä¸ªæ–¹æ³•å—ï¼Œpasswordè¿™ä¸ªFieldåœ¨å¸è½½çš„æ—¶å€™ä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯registerFieldçš„è¿”å›å‡½æ•°ï¼Œè€Œè¿™ä¸ªè¿”å›å‡½æ•°é‡Œåˆè°ƒç”¨äº†`this.triggerDependenciesUpdate(prevStore, namePath);`ï¼Œåé¢çš„æµç¨‹å°±è·Ÿä¸Šé¢ç›¸ä¼¼äº†ã€‚  \r\n# å®Œç»“æ’’èŠ±\r\nå†™äº†è¿™ä¹ˆå¤šç»ˆäºæŠŠrc-field-formçš„ä¸€äº›ä¸»è¦æµç¨‹è®²å®Œäº†ğŸ§ï¼Œç¬¬ä¸€æ¬¡å†™æ–‡ç« å†™çš„çœŸæŒºçƒ‚çš„ï¼Œæœ€åè¿˜æ˜¯å¤§å®¶æ¨èä¸€äº›å…³äºrc-field-formçš„æ–‡ç« ï¼š \r\n- [ä¸€æ¬¡æ‰‹å†™Antd Formçš„ç»å†ï¼Œè®©æˆ‘å—ç›ŠåŒªæµ… - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7038099720400535582)\r\n- [æ‰‹å†™ä¸€ä¸ª Antd4 Form å§ï¼ˆä¸Šç¯‡ï¼‰ï¼šæºç åˆ†æ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7116390485710602254)\r\n- [ğŸ“ä¸­å°è¡¨å•æŠ€æœ¯é€‰å‹å®è·µ(è¡¨å•å®è·µ) - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7316723621292638246)",
      "count": "34k",
      "readingTime": "2:51",
      "imageUrls": [],
      "createdAt": null,
      "updatedAt": null,
      "modified": false
    }
  },
  "postDataList": [
    {
      "authors": [
        "zhw"
      ],
      "title": "èŠèŠreact-scan",
      "tag": "react",
      "path": "react-scan",
      "rawFilePath": "./react-scan.md",
      "coverImage": "https://raw.githubusercontent.com/aidenybai/react-scan/ca7746e2808408c04bcfbfc15486368e67d72bba/.github/assets/logo.svg",
      "text": "# react - scan æ ¸å¿ƒåŸç†å‰–æ\r\n\r\nreact - scan æ˜¯ä¸€ä¸ªç”¨äºç›‘å¬reacté‡æ¸²æŸ“çš„å·¥å…·ï¼Œå…¶æ ¸å¿ƒåŸç†æ˜¯å·§å¦™ä¼ªè£…æˆ React DevToolsï¼Œå€Ÿæ­¤æˆåŠŸæ¥å…¥ React çš„å†…éƒ¨è¿è¡Œæœºåˆ¶ï¼Œä»è€Œç²¾å‡†è·å– Fiber èŠ‚ç‚¹å…³é”®ä¿¡æ¯ï¼Œå®ç°å¯¹ç»„ä»¶æ›´æ–°çŠ¶å†µçš„å®æ—¶ç›‘æ§ã€‚\r\n\r\nReact DevTools åœ¨ç½‘é¡µçš„ window å¯¹è±¡ä¸Šä¼šæŒ‚è½½ä¸€ä¸ªç‰¹æ®Šçš„å…¨å±€å¯¹è±¡ï¼š`__REACT_DEVTOOLS_GLOBAL_HOOK__`ã€‚React åœ¨è‡ªèº«è¿è¡ŒæœŸé—´ï¼ŒäºæŸäº›å…³é”®ç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹ï¼Œä¼šè°ƒç”¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„æŒ‡å®šæ–¹æ³•ï¼Œåƒåœ¨ commit é˜¶æ®µå°±ä¼šè°ƒç”¨ `onCommitFiberRoot` æ–¹æ³•ï¼Œå¹¶å‘å…¶ä¼ å…¥å½“å‰æ›´æ–°çš„ FiberRoot èŠ‚ç‚¹ä½œä¸ºå‚æ•°ã€‚\r\n\r\nreact - scan åˆ™åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œé€šè¿‡åŠ«æŒè¯¥ hook ä¸Šçš„å‡½æ•°ï¼Œä¾‹å¦‚å¯¹ `onCommitFiberRoot` è¿›è¡Œé‡å†™æ“ä½œï¼Œä»è€Œé¡ºåˆ©è·å–æ•´ä¸ª React åº”ç”¨çš„ Fiber æ ‘æ ¹èŠ‚ç‚¹ã€‚è·å–æ ¹èŠ‚ç‚¹åï¼Œå€ŸåŠ© Fiber èŠ‚ç‚¹çš„ child å±æ€§æŒ‡å‘ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ã€sibling å±æ€§æŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼Œå°±èƒ½é€’å½’éå†æ•´æ£µ Fiber æ ‘ï¼Œè¿›è€Œæ‹¿åˆ°æ¯ä¸€ä¸ªç»„ä»¶å¯¹åº”çš„ Fiber èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯ã€‚\r\n\r\n**å¦‚ä½•åˆ¤æ–­ç»„ä»¶æ˜¯å¦å‘ç”Ÿæ›´æ–°ï¼Ÿ**\r\n\r\n  * å¯¹äºé Host ç»„ä»¶ï¼ˆå³éåŸç”Ÿ DOM èŠ‚ç‚¹ï¼‰ï¼šé€šè¿‡ä½è¿ç®—åˆ¤æ–­å…¶ flags ä¸ PerformedWork ç›¸ä¸çš„ç»“æœæ˜¯å¦ä¸º PerformedWorkï¼Œä»¥æ­¤ç¡®å®šè¯¥ Fiber èŠ‚ç‚¹æ˜¯å¦å‘ç”Ÿæ›´æ–°ã€‚\r\n  * å¯¹äº Host ç»„ä»¶ï¼ˆå¯¹åº”å®é™… DOM èŠ‚ç‚¹ï¼‰ï¼š\r\n    * è‹¥ä¸å­˜åœ¨ alternate èŠ‚ç‚¹ï¼Œè¡¨æ˜æ˜¯ç»„ä»¶çš„é¦–æ¬¡æ¸²æŸ“ï¼ˆå› ä¸º Fiber é‡‡ç”¨åŒç¼“å†²æœºåˆ¶ï¼Œå­˜åœ¨å½“å‰æ ‘ä¸ä¸Šä¸€æ¬¡æ ‘ä¹‹åˆ†ï¼‰ã€‚\r\n    * è‹¥å­˜åœ¨ alternate èŠ‚ç‚¹ï¼Œåˆ™å¯¹æ¯”å½“å‰ä¸ä¸Šä¸€æ¬¡çš„ memoizedPropsï¼ˆç»„ä»¶å±æ€§ï¼‰ã€memoizedStateï¼ˆç»„ä»¶çŠ¶æ€ï¼‰ã€refï¼Œåˆ¤æ–­ç»„ä»¶æ˜¯å¦æ›´æ–°ã€‚\r\n\r\n**å¦‚ä½•å®šä½æ›´æ–°ç»„ä»¶çš„ DOM å…ƒç´ ï¼Ÿ**\r\n\r\nä¸€æ—¦ç¡®å®šç»„ä»¶å‘ç”Ÿæ›´æ–°ï¼Œå¯ä»¥ä»å¯¹åº”çš„ Fiber èŠ‚ç‚¹å‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„ Host èŠ‚ç‚¹ï¼ˆå³ Host Fiberï¼‰ï¼Œè·å–å…¶å…³è”çš„ DOM å…ƒç´ ï¼Œè¿›è€Œå¯¹ DOM å…ƒç´ è¿›è¡Œé«˜äº®æˆ–æ ‡è®°æ“ä½œï¼Œæ–¹ä¾¿è¿›è¡Œè°ƒè¯•æˆ–å¯è§†åŒ–å±•ç¤ºã€‚\r\n\r\n**ä¸€äº›å…¶ä»–åŠŸèƒ½ï¼š**\r\n\r\n  * å¯¹æ¯”ä¸¤æ£µ Fiber æ ‘çš„ memoizedPropsï¼Œèƒ½å¤Ÿç²¾ç¡®çŸ¥æ™“å…·ä½“å“ªä¸ª prop å‘ç”Ÿäº†å˜åŒ–ã€‚\r\n  * åˆ¤æ–­æ˜¯å¦å›  Context å˜åŒ–å¼•å‘çš„ç»„ä»¶æ›´æ–°ï¼šå¯é€šè¿‡ fiber.firstContext è·å–ç»„ä»¶è®¢é˜…çš„ç¬¬ä¸€ä¸ª Contextï¼Œç„¶åå‡­å€Ÿå…¶ next å±æ€§ä¾æ¬¡éå†æ‰€æœ‰è®¢é˜…çš„ Context èŠ‚ç‚¹ï¼ŒæŸ¥æ‰¾æ›´æ–°æºå¤´ã€‚\r\n  * åˆ¤æ–­æ˜¯å¦å› ä¸º Hook æ›´æ–°å¯¼è‡´ç»„ä»¶æ›´æ–°ï¼šé‰´äº Fiber ä¸Šçš„ memoizedState å­˜å‚¨ç€ hooks é“¾è¡¨ï¼Œå¯æ®æ­¤åˆ†ææ˜¯å“ªä¸ª state å‘ç”Ÿäº†å˜åŒ–ã€‚",
      "count": "1.1k",
      "readingTime": "5 ",
      "imageUrls": [],
      "createdAt": "2025-05-09T10:11:35.000Z",
      "updatedAt": "2025-05-09T10:11:35.000Z",
      "modified": false
    },
    {
      "authors": [
        "zhw"
      ],
      "title": "å»ºç«™",
      "tag": "ç”Ÿæ´»",
      "path": "first",
      "rawFilePath": "./first.md",
      "coverImage": "https://upload-bbs.miyoushe.com/upload/2024/07/27/75276539/98580c852764d70e5a9597aa7678f131_2245446554692880272.jpg",
      "text": "è®°å½•ä¸€ä¸‹å»ºç«™çš„ç¬¬ä¸€å¤©,ä¹Ÿè®¸å¼€å¿ƒåˆ°çˆ†ç‚¸.\r\n![å»ºç«™å›¾ç‰‡](https://upload-bbs.miyoushe.com/upload/2024/07/27/75276539/98580c852764d70e5a9597aa7678f131_2245446554692880272.jpg)\r\n![å»ºç«™å›¾ç‰‡](https://upload-bbs.miyoushe.com/upload/2024/03/20/285532152/757fa74f8b38fdfab0bd1b653a69af4d_6553329811603610700.gif)\r\n",
      "count": "268",
      "readingTime": "1 ",
      "imageUrls": [
        "https://upload-bbs.miyoushe.com/upload/2024/07/27/75276539/98580c852764d70e5a9597aa7678f131_2245446554692880272.jpg",
        "https://upload-bbs.miyoushe.com/upload/2024/03/20/285532152/757fa74f8b38fdfab0bd1b653a69af4d_6553329811603610700.gif"
      ],
      "createdAt": "2024-11-13T12:48:31.000Z",
      "updatedAt": "2024-11-14T08:12:55.000Z",
      "modified": true
    },
    {
      "authors": [
        "zhw"
      ],
      "title": "rc-field-formæºç åˆ†æ",
      "tag": "react",
      "path": "rc-field-form",
      "rawFilePath": "./rc-field-form.md",
      "coverImage": "https://avatars.githubusercontent.com/u/9441414?s=48&v=4",
      "text": "æœ¬ç¯‡æ–‡ç« å°†ç®€å•åˆ†ærc-field-formçš„æºç ï¼Œrc-field-formæ˜¯ä¸€ä¸ªreactè¡¨å•ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œantdçš„formå°±æ˜¯åŸºäºä»–è¿›è¡Œçš„å°è£…ï¼Œå¦‚æœå¤§å®¶æƒ³è¦äº†è§£reactè¡¨å•çš„ä¸»æµè§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥é˜…è¯»[ğŸ“ä¸­å°è¡¨å•æŠ€æœ¯é€‰å‹å®è·µ(è¡¨å•å®è·µ) - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7316723621292638246#heading-13)\r\n## ç”¨æ³•\r\né¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹rc-field-formçš„ç”¨æ³•\r\n\r\n```js\r\nimport Form, { useForm, Field } from \"../rc-form\";\r\n\r\nexport default () => {\r\n  const [form] = useForm();\r\n\r\n  return (\r\n    <Form\r\n      onFinish={(e) => {\r\n        console.log(e);\r\n      }}\r\n      onFinishFailed={(e) => {\r\n        console.log(e);\r\n      }}\r\n      form={form}\r\n    >\r\n      <Field name=\"name\" rules={[{ required: true, max: 4 }]}>\r\n        <input placeholder=\"Username\" />\r\n      </Field>\r\n      <Field name=\"password\" rules={[{ required: true, max: 1 }]}>\r\n        <input placeholder=\"Username1\" />\r\n      </Field>\r\n      <button>Submit</button>\r\n    </Form>\r\n  );\r\n};\r\n\r\n```\r\nåœ¨è¿™æ®µä»£ç ä¸­ï¼Œä½¿æˆ‘ä»¬ä½¿ç”¨ Form ç»„ä»¶æ¥æ–°å»ºä¸€ä¸ª Form è¡¨å•ï¼Œç„¶ååœ¨Fieldç»„ä»¶é‡ŒåŒ…è£¹äº†æˆ‘ä»¬çš„æ¯ä¸€ä¸ªè¡¨å•é¡¹ï¼Œå¹¶ä¸”é€šè¿‡Fieldçš„nameå­—æ®µåˆ›å»ºè¡¨å•çš„keyï¼Œrulesæ¥é…ç½®æ ¡éªŒã€‚å½“æˆ‘ä»¬ç‚¹å‡»buttonåï¼Œä¼šæ ¹æ®æ˜¯å¦é€šè¿‡æ ¡éªŒæ¥è§¦å‘onFinshæˆ–è€…onFinishFailedã€‚\r\n\r\nç”±æ­¤æˆ‘ä»¬å¯ä»¥å¼•å‡ºä¸€äº›é—®é¢˜ï¼š\r\n- Formç»„ä»¶æ˜¯å¦‚ä½•ç®¡ç†æˆ‘ä»¬çš„è¡¨å•æ•°æ®\r\n- æˆ‘ä»¬å¹¶æ²¡æœ‰ç»™æ¯ä¸ªinputç»‘å®šäº‹ä»¶ï¼Œè¡¨å•çš„å€¼æ˜¯å¦‚ä½•æ›´æ–°çš„\r\n- Formç»„ä»¶å¦‚ä½•å¯¹æˆ‘ä»¬çš„æ•°æ®è¿›è¡Œæ ¡éªŒ\r\nä¸‹é¢å°±è®©æˆ‘ä»¬ä»æºç å…¥æ‰‹æ¥è§£å†³è¿™äº›é—®é¢˜\r\n# **ä¸€**Â·å¦‚ä½•å®ç°æ•°æ®çš„æ›´æ–°\r\n### Formç»„ä»¶å¦‚ä½•ç®¡ç†æ•°æ®\r\næ ¹æ®ä¸Šé¢çš„ä»£ç ï¼Œå½“æˆ‘ä»¬åˆ›å»ºFormç»„ä»¶æ—¶ï¼Œå¿…é¡»è¦ç»™Formç»„ä»¶ä¼ å…¥ä¸€ä¸ªé€šè¿‡useFormè¿™ä¸ªhookå¾—åˆ°çš„formï¼Œé‚£ä¹ˆè¿™ä¸ªformæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢æ˜¯useFormçš„æºç \r\n\r\n```js\r\nfunction useForm(form) {\r\n  const formRef = React.useRef();\r\n  const [, forceUpdate] = React.useState({});\r\n\r\n  if (!formRef.current) {\r\n    if (form) {\r\n      formRef.current = form;\r\n    } else {\r\n      // Create a new FormStore if not provided\r\n      const forceReRender = () => {\r\n        forceUpdate({});\r\n      };\r\n\r\n      const formStore: FormStore = new FormStore(forceReRender);\r\n\r\n      formRef.current = formStore.getForm();\r\n    }\r\n  }\r\n\r\n  return [formRef.current];\r\n}\r\n\r\n```\r\nå½“æˆ‘ä»¬åœ¨ä½¿ç”¨useFormçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šä¼ å…¥formå‚æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªhookå°±ä¼šå¸®æˆ‘ä»¬newä¸€ä¸ªFormStoreï¼ŒFormStoreæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç±»ï¼Œæ•´ä¸ªè¡¨å•æ•°æ®çš„å­˜å‚¨å’Œæ“ä½œæ–¹æ³•éƒ½æ˜¯ç”±ä»–æä¾›ï¼Œç„¶åè¿”å›Formstoreçš„getFormæ–¹æ³•ï¼Œå…¶å®è¿™é‡Œå°±æ˜¯é€šè¿‡getFormå°†Formstoreé‡Œçš„ä¸€äº›å±æ€§å’Œæ–¹æ³•æš´éœ²äº†å‡ºæ¥ã€‚\r\næˆ‘ä»¬å…ˆæ¥ç®€å•çœ‹ä¸‹FormStoreé‡Œéƒ½æœ‰å•¥(åªå±•ç¤ºéƒ¨åˆ†å±æ€§å’Œæ–¹æ³•)\r\n\r\n```js\r\nexport class FormStore {\r\n  //new FormStoreæ—¶ä¼ å…¥çš„setStateæ–¹æ³•\r\n  private forceRootUpdate\r\n\r\n  private subscribabl = true;\r\n//æ•´ä¸ªè¡¨å•çš„æ•°æ®\r\n  private store: Store = {};\r\n//æ¯ä¸ªFieldç»„ä»¶éƒ½ä¼šè¢«æ³¨å†Œåˆ°è¿™ä¸ªæ•°ç»„é‡Œ\r\n  private fieldEntities = [];\r\n//åˆå§‹å€¼\r\n  private initialValues = {};\r\n//å­˜æ”¾Formä¸Šçš„onFinishç­‰æ–¹æ³•\r\n  private callbacks: Callbacks = {};\r\n  \r\n  constructor(forceRootUpdate: () => void) {\r\n    this.forceRootUpdate = forceRootUpdate;\r\n  }\r\n  //æš´éœ²å‡ºå»ç»™å¼€å‘è€…çš„ä¸€äº›æ–¹æ³•\r\n   public getForm = (): InternalFormInstance => ({\r\n    getFieldValue: this.getFieldValue,\r\n    getFieldsValue: this.getFieldsValue,\r\n    getFieldWarning: this.getFieldWarning,\r\n    resetFields: this.resetFields,\r\n    setFields: this.setFields,\r\n    setFieldValue: this.setFieldValue,\r\n    setFieldsValue: this.setFieldsValue,\r\n    validateFields: this.validateFields,\r\n    submit: this.submit,\r\n    getInternalHooks: this.getInternalHooks,\r\n    ......\r\n  });\r\n    private getInternalHooks = (key: string): InternalHooks | null => {\r\n    //åªæä¾›ç»™å†…éƒ¨ç»„ä»¶çš„æ–¹æ³•ï¼Œå¼€å‘è€…åœ¨å…¶ä»–ç»„ä»¶æ— æ³•è°ƒç”¨ï¼Œè¿™é‡Œçš„HOOK_MARæ˜¯Fieldç»„ä»¶é€šè¿‡contextè·å¾—çš„\r\n    if (key === HOOK_MARK) {\r\n      this.formHooked = true;\r\n\r\n      return {\r\n        dispatch: this.dispatch,\r\n        initEntityValue: this.initEntityValue,\r\n        registerField: this.registerField,\r\n        useSubscribe: this.useSubscribe,\r\n        setInitialValues: this.setInitialValues,\r\n        destroyForm: this.destroyForm,\r\n        setCallbacks: this.setCallbacks,\r\n        setValidateMessages: this.setValidateMessages,\r\n        getFields: this.getFields,\r\n        setPreserve: this.setPreserve,\r\n        getInitialValue: this.getInitialValue,\r\n        registerWatch: this.registerWatch,\r\n      };\r\n    }\r\n\r\n    warning(false, '`getInternalHooks` is internal usage. Should not call directly.');\r\n    return null;\r\n  };\r\n```\r\nè¿˜æœ‰å¾ˆå¤šæ–¹æ³•æ„Ÿè§‰å¤ªå¤šäº†è¿™é‡Œæ²¡æœ‰åˆ—ä¸¾ï¼Œæˆ‘ä»¬ç›´æ¥æŒ‰æµç¨‹è¿›è¡Œåˆ†æç†è§£ï¼Œä¸Šé¢æˆ‘ä»¬è®²åˆ°äº†Formç»„ä»¶éœ€è¦ä¼ å…¥formï¼Œè€Œformæ˜¯FormStoreé€šè¿‡getFormæš´éœ²å‡ºçš„ä¸€äº›å±æ€§å’Œæ–¹æ³•æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹Formç»„ä»¶æ˜¯å¦‚ä½•æ¶ˆè´¹formçš„\r\n\r\n\r\n```js\r\n//formcontextæ˜¯ç”¨äºå…¨å±€formç®¡ç†çš„æš‚ä¸åˆ†æ\r\nconst formContext: FormContextProps = React.useContext(FormContext);\r\n//æ‹¿åˆ°FormStoreæš´éœ²çš„å±æ€§ï¼Œæ–¹æ³•\r\n  const [formInstance] = useForm(form);\r\n  const {\r\n    useSubscribe,\r\n    setInitialValues,\r\n    setCallbacks,\r\n    setValidateMessages,\r\n    setPreserve,\r\n    destroyForm,\r\n  } = (formInstance as InternalFormInstance).getInternalHooks(HOOK_MARK);\r\n\r\n  // è½¬å‘refè®©å¤–éƒ¨å¯ä»¥é€šè¿‡refè°ƒç”¨\r\n  React.useImperativeHandle(ref, () => formInstance);\r\n\r\n  //å…¨å±€ç®¡ç†æœ‰å…³\r\n  React.useEffect(() => {\r\n    formContext.registerForm(name, formInstance);\r\n    return () => {\r\n      formContext.unregisterForm(name);\r\n    };\r\n  }, [formContext, formInstance, name]);\r\n\r\n  //è®¾ç½®validateMessage\r\n  setValidateMessages({\r\n    ...formContext.validateMessages,\r\n    ...validateMessages,\r\n  });\r\n  //æ³¨å†Œformè¡¨å•ä¸Šä¼ å…¥çš„æ–¹æ³•\r\n  setCallbacks({\r\n    onValuesChange,\r\n    onFieldsChange: (changedFields: FieldData[], ...rest) => {\r\n      formContext.triggerFormChange(name, changedFields);\r\n\r\n      if (onFieldsChange) {\r\n        onFieldsChange(changedFields, ...rest);\r\n      }\r\n    },\r\n    onFinish: (values: Store) => {\r\n      formContext.triggerFormFinish(name, values);\r\n\r\n      if (onFinish) {\r\n        onFinish(values);\r\n      }\r\n    },\r\n    onFinishFailed,\r\n  });\r\n  setPreserve(preserve);\r\n```\r\nå¤§æ¦‚å°±æ˜¯ä¸ºFormStoreåˆå§‹åŒ–ä¸€äº›ä¸œè¥¿ï¼Œå¯¹ä¸»æµç¨‹å½±å“ä¸å¤§ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ï¼Œä¸‹é¢æ¥åˆ°äº†åˆ›å»ºåˆå§‹å€¼\r\n\r\n```js\r\n//åˆ¤æ–­æ˜¯å¦ä¸ºé¦–æ¬¡æ¸²æŸ“ï¼Œé¦–æ¬¡æ¸²æŸ“å°±åˆ›å»ºåˆå§‹å€¼\r\n  const mountRef = React.useRef(null);\r\n  setInitialValues(initialValues, !mountRef.current);\r\n  if (!mountRef.current) {\r\n    mountRef.current = true;\r\n  }\r\n//æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶é‡ç½®Form\r\n  React.useEffect(\r\n    () => destroyForm,\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    [],\r\n  );\r\n\r\n```\r\næˆ‘ä»¬å…ˆæ¥çœ‹setInitialValuesè¿™ä¸ªæ–¹æ³•\r\n\r\n```js\r\n  private setInitialValues = (initialValues: Store, init: boolean) => {\r\n    this.initialValues = initialValues || {};\r\n    if (init) {\r\n    //mergeæ–¹æ³•æ˜¯rc-utilæä¾›çš„å·¥å…·å‡½æ•°ï¼Œrc-field-formé‡Œçš„å¾ˆå¤šæ“ä½œéƒ½ç”¨åˆ°äº†é‡Œé¢çš„å‡½æ•°ï¼Œè¿™é‡Œä¸åšåˆ†æ\r\n      let nextStore = merge(initialValues, this.store);\r\n    //éä¸»è¦æµç¨‹è·³è¿‡\r\n      this.prevWithoutPreserves?.map(({ key: namePath }) => {\r\n        nextStore = setValue(nextStore, namePath, getValue(initialValues, namePath));\r\n      });\r\n      this.prevWithoutPreserves = null;\r\n\r\n      this.updateStore(nextStore);\r\n    }\r\n  };\r\n```\r\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°setinitalValuesæ–¹æ³•æœ€åè°ƒç”¨äº†updateStoreï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆç®€å•\r\n\r\n```js\r\n  private updateStore = (nextStore: Store) => {\r\n    this.store = nextStore;\r\n  };\r\n```\r\nç›´æ¥ä¿®æ”¹äº†storeï¼Œæ¥ä¸‹æ¥æ˜¯å¯¹childä¸åŒtypeçš„ä¸€äº›å¤„ç†\r\n\r\n```js\r\n  let childrenNode: React.ReactNode;\r\n  const childrenRenderProps = typeof children === 'function';\r\n  if (childrenRenderProps) {\r\n    const values = formInstance.getFieldsValue(true);\r\n    childrenNode = (children as RenderProps)(values, formInstance);\r\n  } else {\r\n    childrenNode = children;\r\n  }\r\n```\r\nå¦‚æœchildæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™ä¼ å…¥childNodeä¸ºå‡½æ•°è¿”å›å€¼,è¿™é‡Œçš„getFieldsValueæ–¹æ³•å‚æ•°ä¸ºtrueæ—¶è¿”å›çš„å°±æ˜¯æ•´ä¸ªstoreï¼Œä¹Ÿå¯ä»¥ä¼ å…¥Fieldçš„nameæ•°ç»„è·å–æŒ‡å®šçš„valueï¼Œå…·ä½“å®ç°ä¸åšåˆ†æã€‚ç»§ç»­ç»§ç»­ğŸ˜Š\r\n\r\n```js\r\nconst formContextValue = React.useMemo(\r\n    () => ({\r\n      ...(formInstance as InternalFormInstance),\r\n      validateTrigger,\r\n    }),\r\n    [formInstance, validateTrigger],\r\n  );\r\n```\r\nç„¶åæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªcontextï¼Œä¼ å…¥formInstance(FormStoreæš´éœ²çš„æ–¹æ³•å’Œæ•°æ®)ï¼Œè¿˜æœ‰ä¸€ä¸ªvalidateTriggerï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹‹å‰æ²¡æœ‰æåˆ°ï¼Œè¿™ä¸ªå±æ€§æ˜¯ç”¨æˆ·ä¼ ç»™Formç»„ä»¶çš„ï¼Œä»–çš„é»˜è®¤å€¼æ˜¯onChange,ä¹Ÿå°±æ˜¯è¯´åœ¨onChangeçš„æ—¶å€™ä¼šè§¦å‘Fieldç»„ä»¶çš„validateã€‚é©¬ä¸Šå°±åˆ°å°¾å£°äº†(å…¶å®æ˜¯Formçš„å°¾å£°ï¼Œåé¢è¿˜æœ‰ä¸€å †)\r\n\r\n```js\r\n  const wrapperNode = (\r\n    <ListContext.Provider value={null}>\r\n      <FieldContext.Provider value={formContextValue}>{childrenNode}</FieldContext.Provider>\r\n    </ListContext.Provider>\r\n  );\r\n```\r\næ¥ä¸‹åˆ›å»ºä¸€ä¸ªwrapperNodeï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªcontextProviderï¼ŒListContext.Providerè¿™ä¸ªåº”è¯¥æ˜¯ä¸ºListç»„ä»¶æœåŠ¡çš„æˆ‘ä»¬æš‚ä¸å…³å¿ƒï¼Œç„¶åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°FieldContext.Providerå°±æ˜¯æä¾›äº†formInstanceå’ŒvalidateTriggerï¼Œè¿™æ ·æˆ‘ä»¬çš„Fieldç»„ä»¶ä¹Ÿå¯ä»¥è®¿é—®å’Œæ“ä½œformInstanceå•¦ã€‚\r\nç„¶åå°±æ˜¯æˆ‘ä»¬æœ€åçš„ä»£ç \r\n\r\n```js\r\n  if (Component === false) {\r\n    return wrapperNode;\r\n  }\r\n\r\n  return (\r\n    <Component\r\n      {...restProps}\r\n      onSubmit={(event: React.FormEvent<HTMLFormElement>) => {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n\r\n        formInstance.submit();\r\n      }}\r\n      onReset={(event: React.FormEvent<HTMLFormElement>) => {\r\n        event.preventDefault();\r\n\r\n        formInstance.resetFields();\r\n        restProps.onReset?.(event);\r\n      }}\r\n    >\r\n      {wrapperNode}\r\n    </Component>\r\n  );\r\n};\r\n```\r\nè¿™é‡Œçš„Componentä¹Ÿæ˜¯ç”±ç”¨æˆ·ä¼ å…¥çš„ï¼Œé»˜è®¤å€¼ä¸º'form'ï¼Œæ‰€ä»¥æœ€åçš„æ•ˆæœå…¶å®æ˜¯\r\n```js    \r\n    <form\r\n      {...restProps}\r\n      onSubmit={(event: React.FormEvent<HTMLFormElement>) => {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n\r\n        formInstance.submit();\r\n      }}\r\n      onReset={(event: React.FormEvent<HTMLFormElement>) => {\r\n        event.preventDefault();\r\n\r\n        formInstance.resetFields();\r\n        restProps.onReset?.(event);\r\n      }}\r\n    >\r\n      {wrapperNode}\r\n    </form>\r\n```\r\nè¿™é‡Œé˜»æ­¢äº†ä¸€ä¸‹formçš„é»˜è®¤è¡Œä¸ºï¼Œç„¶åä¼šåœ¨submitå’Œresetæ—¶æ‰§è¡ŒformInstanceçš„æ–¹æ³•ã€‚\r\n\r\nåˆ°è¿™é‡Œæˆ‘ä»¬å…ˆæ€»ç»“ä¸€ä¸‹ï¼ŒFormç»„ä»¶éƒ½å¹²äº†ä»€ä¹ˆ\r\n- é¦–å…ˆä»–æ‹¿åˆ°äº†formç„¶åsetCallbacksï¼ŒsetInitialValueså¯¹forminstanceçš„callbackå’Œstoreè¿›è¡Œäº†åˆå§‹åŒ–\r\n- ç„¶åå¯¹childrenè¿›è¡Œäº†å¤„ç†ï¼Œç”¨FieldContextå°†å®ƒåŒ…è£¹ï¼Œè®©Fieldç»„ä»¶å¯ä»¥æ‹¿åˆ°formInstanceç­‰ä¸€äº›ä¸œè¥¿\r\n- æœ€åç”¨formæ ‡ç­¾å°†å¤„ç†åçš„childåŒ…è£¹èµ·æ¥ï¼Œå°†äº‹ä»¶è¿›è¡Œç»‘å®š\r\n### Fieldå¦‚ä½•æ¶ˆè´¹æ•°æ®\r\næ¥ä¸‹æ¥è®©æˆ‘ä»¬ç»§ç»­çœ‹çœ‹Feldç»„ä»¶ï¼ŒFieldç»„ä»¶æœ‰ä¸€ç‚¹ç‰¹æ®Šï¼Œä»–æ˜¯ä¸€ä¸ªclassç»„ä»¶ğŸ¤”ï¼Œæºç ä¸­æ³¨é‡Šæ˜¯\r\n` We use Class instead of Hooks here since it will cost much code by using Hooks.`å¤§æ¦‚æ„æ€æ˜¯é€šè¿‡classç»„ä»¶çš„æ–¹å¼å®ç°å¯ä»¥å‡å°‘ä»£ç é‡ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹Fieldç»„ä»¶å¤§è‡´çš„ä»£ç ç»“æ„ã€‚\r\n```js\r\nclass Field extends React.Component<InternalFieldProps, FieldState> implements FieldEntity {\r\n    //ä¼ å…¥çš„formInstance\r\n    public static contextType = FieldContext;\r\n    //ç»„ä»¶é»˜è®¤å‚æ•°\r\n    public static defaultProps\r\n    //å®šä¹‰ä¸€ä¸ªstateç”¨äºè§¦å‘rerender\r\n    public state \r\n    //ç”¨äºç»„ä»¶å¸è½½æ—¶æ¸…é™¤formInstanceé‡Œæ•°æ®\r\n    private cancelRegisterFunc\r\n    //æ˜¯å¦å·²æŒ‚è½½\r\n    private mounted = false;\r\n    //è¡¨å•æ ¡éªŒç»“æœçš„Promise\r\n    private validatePromise\r\n    //æ ¡éªŒç»“æœerror\r\n    private errors\r\n    //æ ¡éªŒç»“æœ warning\r\n    private warnings\r\n  \r\n    constructor(props) {\r\n        super()\r\n        ..........\r\n    }\r\n  \r\n    public componentDidMount\r\n  \r\n    public componentWillUnmount() {\r\n    }\r\n    //ä¼šè°ƒç”¨å¹¶é”€æ¯cancelRegisterFunc\r\n    public cancelRegister\r\n    //è·å–Fieldçš„name\r\n    public getNamePath\r\n    //è·å–ä¼ å…¥çš„rules\r\n    public getRules\r\n    //ç”¨äºæ›´æ–°ç»„ä»¶\r\n    public reRender\r\n    public refresh\r\n    // ========================= è¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œè·Ÿç»„ä»¶æ›´æ–°ç›¸å…³ ==============================\r\n    public onStoreChange\r\n    //æ ¡éªŒruluesçš„æ–¹æ³•\r\n    public validateRules\r\n    public isFieldValidating = () => !!this.validatePromise;\r\n   //è·å–æ ¡éªŒåçš„ç»“æœ\r\n    public getErrors\r\n    public getWarnings\r\n   //å¯¹ä¼ å…¥çš„childçš„ä¸€äº›å¤„ç†\r\n    public getOnlyChild\r\n    //è¿”å›å½“å‰Fieldå­—æ®µçš„å€¼\r\n    public getValue\r\n    // ======== å°±æ˜¯è¿™ä¸ªæ–¹æ³•è®©æˆ‘ä»¬ä¼ å…¥çš„ç»„ä»¶å—æ§ï¼ŒåŠ«æŒäº†ç»„ä»¶çš„onChangeè¿™ç±»äº‹ä»¶ ====================\r\n    public getControlled\r\n    //è¿”å›å¤„ç†åçš„å­ç»„ä»¶\r\n    public render() {\r\n    \r\n    }\r\n  }\r\n```\r\näº†è§£äº†å¤§ä½“ç»“æ„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å…ˆä»constructorå…¥æ‰‹ï¼Œçœ‹çœ‹Fieldç»„ä»¶çš„æ¸²æŸ“æµç¨‹ã€‚\r\n\r\n```js\r\n  constructor(props: InternalFieldProps) {\r\n    super(props);\r\n\r\n    // Register on init\r\n    if (props.fieldContext) {\r\n      const { getInternalHooks }: InternalFormInstance = props.fieldContext;\r\n      const { initEntityValue } = getInternalHooks(HOOK_MARK);\r\n      initEntityValue(this);\r\n    }\r\n  }\r\n\r\n```\r\nè¿™é‡Œå…¶å®å°±æ˜¯è°ƒç”¨äº†initEntityValueè¿™ä¸ªå‡½æ•°ï¼Œä¼ å…¥Fieldç»„ä»¶\r\n\r\n```js\r\n private initEntityValue = (entity: FieldEntity) => {\r\n    const { initialValue } = entity.props;\r\n\r\n    if (initialValue !== undefined) {\r\n      const namePath = entity.getNamePath();\r\n      const prevValue = getValue(this.store, namePath);\r\n\r\n      if (prevValue === undefined) {\r\n        this.updateStore(setValue(this.store, namePath, initialValue));\r\n      }\r\n    }\r\n  };\r\n```\r\nè¿™é‡Œå°±æ˜¯ç®€å•è®¾ç½®äº†ä¸€ä¸‹åˆå§‹å€¼å¹¶ä¸ä¼šå¼•èµ·Fieldçš„rerenderï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­çœ‹Fieldç»„ä»¶éƒ½åšäº†å“ªäº›åˆå§‹åŒ–\r\n\r\n```js\r\n  public componentDidMount() {\r\n    const {  fieldContext } = this.props;\r\n     //æ ‡è®°ä¸ºå·²æŒ‚è½½\r\n    this.mounted = true;\r\n\r\n    if (fieldContext) {\r\n      const { getInternalHooks }: InternalFormInstance = fieldContext;\r\n      const { registerField } = getInternalHooks(HOOK_MARK);\r\n      //\r\n      this.cancelRegisterFunc = registerField(this);\r\n    }\r\n  }\r\n```\r\nè¿™é‡Œçš„æ ¸å¿ƒå°±æ˜¯registerFieldï¼Œè¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡formStoreçš„fieldEntitiesæ•°ç»„é‡Œå­˜å‚¨äº†Fieldå—ï¼Œè¿™ä¸ªå‡½æ•°å…¶å®æ ¸å¿ƒå°±æ˜¯fieldEntities.push(field)ï¼Œç„¶åç»™æˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªå‡½æ•°ç”¨äºåœ¨fieldEntitiesé‡Œdeleteè¿™ä¸ªFieldï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡formInstanceè°ƒç”¨Fieldé‡Œæš´éœ²çš„ä¸€äº›æ–¹æ³•ç”¨äºæ›´æ–°æˆ–è€…æ ¡éªŒã€‚ \r\n\r\nç„¶åå°±æ˜¯renderå‡½æ•°\r\n\r\n```js\r\n public render() {\r\n    const { resetCount } = this.state;\r\n    const { children } = this.props;\r\n\r\n    const { child, isFunction } = this.getOnlyChild(children);\r\n\r\n    // Not need to `cloneElement` since user can handle this in render function self\r\n    let returnChildNode: React.ReactNode;\r\n    if (isFunction) {\r\n      returnChildNode = child;\r\n    } else if (React.isValidElement(child)) {\r\n      returnChildNode = React.cloneElement(\r\n        child as React.ReactElement,\r\n        this.getControlled((child as React.ReactElement).props),\r\n      );\r\n    } else {\r\n      warning(!child, '`children` of Field is not validate ReactElement.');\r\n      returnChildNode = child;\r\n    }\r\n\r\n    return <React.Fragment key={resetCount}>{returnChildNode}</React.Fragment>;\r\n  }\r\n}\r\n```\r\ngetonlychildè¿”å›ç¬¬ä¸€ä¸ªchildå’Œä»–çš„ç±»å‹ï¼Œå½“childæ˜¯åˆæ³•çš„reactElementæ—¶ï¼Œè°ƒç”¨[cloneElementæ–¹æ³•](https://react.dev/reference/react/cloneElement)ï¼Œç„¶åè¿”å›FragmentåŒ…è£¹çš„cloneElementï¼Œæ‰€ä»¥è¿™é‡Œçš„å…³é”®å°±æ˜¯è¿™ä¸ªcloneElementçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¿™é‡Œåˆ°åº•ä¼ å…¥äº†ä»€ä¹ˆä¸œè¥¿ğŸ¤¨ã€‚  \r\nç®€å•åœ°è¯´ï¼ŒcloneElementçš„ç¬¬äºŒä¸ªå‚æ•°å…¶å®æ˜¯`props`ï¼Œå®ƒå¯ä»¥è¦†ç›–é»˜è®¤çš„propsï¼Œfc-field-formå°±æ˜¯åœ¨è¿™é‡Œæ¥ç®¡äº†Fieldçš„onChangeç­‰ä¸€ç³»åˆ—äº‹ä»¶ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹getControlledçš„æºç \r\n\r\n```js\r\n  public getControlled = (childProps: ChildProps = {}) => {\r\n  //è·å–Fieldçš„ä¸€äº›æ–¹æ³•å’Œæ•°æ®\r\n    const {\r\n      name,\r\n      trigger,\r\n      validateTrigger,\r\n      getValueFromEvent,\r\n      normalize,\r\n      valuePropName,\r\n      getValueProps,\r\n      fieldContext,\r\n    } = this.props;\r\n   //æ ¡éªŒæœ‰å…³,å…¶å®å°±æ˜¯ä¸€äº›äº‹ä»¶çš„nameï¼Œå¦‚'onChange'\r\n    const mergedValidateTrigger =\r\n      validateTrigger !== undefined ? validateTrigger : fieldContext.validateTrigger;\r\n    //å½“å‰field name\r\n    const namePath = this.getNamePath();\r\n    const { getInternalHooks, getFieldsValue }: InternalFormInstance = fieldContext;\r\n    //---------- dispatchä¼ å…¥ä¸åŒçš„å‚æ•°å¯ä»¥åˆ†å‘ä¸åŒæ“ä½œå¦‚æ ¡éªŒï¼Œæ›´æ–° ----------------\r\n    const { dispatch } = getInternalHooks(HOOK_MARK);\r\n    const value = this.getValue();\r\n    //ä¸å¤ªé‡è¦ï¼Œç»™å­å…ƒç´ æä¾›ä¸€ä¸ªå¯ä»¥è·å–valueçš„æ–¹æ³•\r\n    const mergedGetValueProps = getValueProps || ((val: StoreValue) => ({ [valuePropName]: val }));\r\n    //åŒä¸Š\r\n    const valueProps = name !== undefined ? mergedGetValueProps(value) : {};\r\n        //triggerçš„é»˜è®¤å€¼æ˜¯onChangeï¼Œå¦‚æœæˆ‘ä»¬åœ¨æŸä¸ªFieldçš„inputé‡Œç»‘å®šäº†onChangeäº‹ä»¶ï¼Œè¿™é‡Œå°±å¯ä»¥æ‹¿åˆ°\r\n    const originTriggerFunc = childProps[trigger];\r\n    // warning when prop value is function\r\n    if (process.env.NODE_ENV !== 'production' && valueProps) {\r\n      Object.keys(valueProps).forEach(key => {\r\n        warning(\r\n          typeof valueProps[key] !== 'function',\r\n          `It's not recommended to generate dynamic function prop by \\`getValueProps\\`. Please pass it to child component directly (prop: ${key})`,\r\n        );\r\n      });\r\n    }\r\n    //è¿™ä¸ªcontrolå°±æ˜¯æˆ‘ä»¬è¦è¿”å›çš„propsï¼Œç°åœ¨è¿˜å‡ ä¹æ²¡æœ‰å•¥çœŸæ­£æœ‰ç”¨çš„å˜åŒ–\r\n    const control = {\r\n      ...childProps,\r\n      ...valueProps,\r\n    };\r\n    //------------------------------- åŠ«æŒäº‹ä»¶äº† ------------------------------------\r\n    control[trigger] = (...args: EventArgs) => {\r\n      //ä¿®æ”¹ä¸€äº›çŠ¶æ€\r\n      this.touched = true;\r\n      this.dirty = true;\r\n\r\n      this.triggerMetaEvent();\r\n\r\n      let newValue: StoreValue;\r\n      //é»˜è®¤ä¸ºç©ºï¼Œç”¨æˆ·å¯ä»¥ä¼ å…¥ï¼Œå°±æ˜¯è·å–äº‹ä»¶è¿”å›å€¼\r\n      if (getValueFromEvent) {\r\n        newValue = getValueFromEvent(...args);\r\n      } else {\r\n      //ç”¨æˆ·ä¸ä¼ å…¥ä½¿ç”¨é»˜è®¤æ–¹æ³•\r\n        newValue = defaultGetValueFromEvent(valuePropName, ...args);\r\n      }\r\n      //å¯¹æ•°æ®è¿›è¡Œä¸€äº›æ ¼å¼åŒ–å¤„ç†\r\n      if (normalize) {\r\n        newValue = normalize(newValue, value, getFieldsValue(true));\r\n      }\r\n       //åˆ†å‘æ›´æ–°äº‹ä»¶\r\n      dispatch({\r\n        type: 'updateValue',\r\n        namePath,\r\n        value: newValue,\r\n      });\r\n       //å¦‚æœç”¨æˆ·è¿˜ç»‘å®šäº†äº‹ä»¶ï¼Œè°ƒç”¨ç”¨æˆ·åŸæ¥ç»‘å®šçš„äº‹ä»¶\r\n      if (originTriggerFunc) {\r\n        originTriggerFunc(...args);\r\n      }\r\n    };\r\n    \r\n    //è§¦å‘æ ¡éªŒçš„æ•°ç»„ï¼Œå¦‚['onChange'],åé¢çš„å…ˆä¸çœ‹å±äºæ ¡éªŒçš„å†…å®¹\r\n     const validateTriggerList: string[] = toArray(mergedValidateTrigger || []);\r\n\r\n    validateTriggerList.forEach((triggerName: string) => {\r\n      // Wrap additional function of component, so that we can get latest value from store\r\n      const originTrigger = control[triggerName];\r\n      control[triggerName] = (...args: EventArgs) => {\r\n        if (originTrigger) {\r\n          originTrigger(...args);\r\n        }\r\n\r\n        // Always use latest rules\r\n        const { rules } = this.props;\r\n        if (rules && rules.length) {\r\n          // We dispatch validate to root,\r\n          // since it will update related data with other field with same name\r\n          dispatch({\r\n            type: 'validateField',\r\n            namePath,\r\n            triggerName,\r\n          });\r\n        }\r\n      };\r\n    });\r\n\r\n    return control;\r\n  };\r\n```\r\nåˆ°äº†è¿™é‡Œå…¶å®æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†rc-field-formåœ¨è¡¨å•è§¦å‘äº‹ä»¶æ—¶ï¼Œè™½ç„¶æˆ‘ä»¬å¹¶æ²¡æœ‰ç»‘å®šäº‹ä»¶ï¼Œä½†æ˜¯å®ƒå·²ç»å°†å…¶åŠ«æŒï¼Œå¹¶ä¸”é€šè¿‡dispatchè¿™ä¸ªå‡½æ•°é€šçŸ¥formStoreè¿›è¡Œæ•°æ®ä¸Šçš„æ›´æ–°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·æ¥æ¢ç´¢dataå’Œuiæ˜¯å¦‚ä½•æ›´æ–°ã€‚\r\n\r\ndispatchè¿™ä¸ªå‡½æ•°çš„ä»£ç å¾ˆå°‘ï¼Œå¦‚ä¸‹\r\n```js\r\n  private dispatch = (action: ReducerAction) => {\r\n    switch (action.type) {\r\n      case 'updateValue': {\r\n        const { namePath, value } = action;\r\n        this.updateValue(namePath, value);\r\n        break;\r\n      }\r\n      case 'validateField': {\r\n        const { namePath, triggerName } = action;\r\n        this.validateFields([namePath], { triggerName });\r\n        break;\r\n      }\r\n      default:\r\n      // Currently we don't have other action. Do nothing.\r\n    }\r\n  };\r\n```\r\nå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è§¦å‘updateVlueè¿›å…¥äº†updateValueè¿™ä¸ªå‡½æ•°\r\n\r\n```js\r\n  private updateValue = (name: NamePath, value: StoreValue) => {\r\n    const namePath = getNamePath(name);\r\n    const prevStore = this.store;\r\n    this.updateStore(setValue(this.store, namePath, value));\r\n\r\n    this.notifyObservers(prevStore, [namePath], {\r\n      type: 'valueUpdate',\r\n      source: 'internal',\r\n    });\r\n    ......\r\n  };\r\n```\r\n ç®€ç•¥åçš„ä»£ç å¦‚ä¸Šï¼ŒupdateStoreæ›´æ–°äº†ä¸€ä¸‹storeï¼Œå…¶å®åˆ°è¿™é‡Œæˆ‘ä»¬å°±å·²ç»å°†formInstanceçš„storeæ›´æ–°äº†ï¼Œæ¥ä¸‹æ¥æ€è€ƒçš„æ˜¯å¦‚ä½•æ›´æ–°uiï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹è¿™ä¸ªnotifyObserverså‡½æ•°\r\n \r\n```js\r\n private notifyObservers = (\r\n    prevStore: Store,\r\n    namePathList: InternalNamePath[] | null,\r\n    info: NotifyInfo,\r\n  ) => {\r\n    if (this.subscribable) {\r\n    //åˆå¹¶infoå’Œstore\r\n      const mergedInfo: ValuedNotifyInfo = {\r\n        ...info,\r\n        store: this.getFieldsValue(true),\r\n      };\r\n      //è·å–æ‰€æœ‰Fieldï¼Œæ‰§è¡Œæ¯ä¸ªFieldçš„onStoreChangeæ–¹æ³•\r\n      this.getFieldEntities().forEach(({ onStoreChange }) => {\r\n        onStoreChange(prevStore, namePathList, mergedInfo);\r\n      });\r\n    } else {\r\n      this.forceRootUpdate();\r\n    }\r\n  };\r\n```\r\nè¿˜è®°å¾—æˆ‘ä»¬æåˆ°è¿‡Fieldé‡Œçš„onStoreChangeä¸æ›´æ–°æœ‰å…³å—ï¼Œæ²¡é”™ç°åœ¨è¿™ä¸€åˆ‡éƒ½è¿äº†èµ·æ¥ã€‚\r\n\r\n```js\r\npublic onStoreChange: FieldEntity['onStoreChange'] = (prevStore, namePathList, info) => {\r\n  const { shouldUpdate, dependencies = [], onReset } = this.props;\r\n  const { store } = info;\r\n  const namePath = this.getNamePath();\r\n  const prevValue = this.getValue(prevStore);\r\n  const curValue = this.getValue(store);\r\n  //åŒ¹é…æ˜¯å¦åŒ…å«å½“å‰name\r\n  const namePathMatch = namePathList && containsNamePath(namePathList, namePath);\r\n\r\n  // ä¸ºsetFieldValueè¿™æ ·çš„apiæœåŠ¡çš„\r\n  if (\r\n    info.type === 'valueUpdate' &&\r\n    info.source === 'external' &&\r\n    !isEqual(prevValue, curValue)\r\n  ) {\r\n    this.touched = true;\r\n    this.dirty = true;\r\n    this.validatePromise = null;\r\n    this.errors = EMPTY_ERRORS;\r\n    this.warnings = EMPTY_ERRORS;\r\n    this.triggerMetaEvent();\r\n  }\r\n  //å…¶ä»–ä»£ç çœç•¥ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯default\r\n  switch (info.type) {\r\n    case 'reset':\r\n    case 'remove':\r\n    case 'setField':\r\n    case 'dependenciesUpdate'\r\n    default:\r\n    //ä¸€äº›æ˜¯å¦éœ€è¦æ›´æ–°çš„åˆ¤æ–­\r\n      if (\r\n        namePathMatch ||\r\n        ((!dependencies.length || namePath.length || shouldUpdate) &&\r\n          requireUpdate(shouldUpdate, prevStore, store, prevValue, curValue, info))\r\n      ) {\r\n      //è°ƒç”¨æ–¹æ³•æ›´æ–°\r\n        this.reRender();\r\n        return;\r\n      }\r\n      break;\r\n  }\r\n\r\n  if (shouldUpdate === true) {\r\n    this.reRender();\r\n  }\r\n  };\r\n```\r\nrerenderæ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ä½¿ç”¨äº†ç±»ç»„ä»¶çš„forceUpdateå¼ºåˆ¶æ›´æ–°\r\n```js\r\n  public reRender() {\r\n    if (!this.mounted) return;\r\n    this.forceUpdate();\r\n  }\r\n```\r\nåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†è¡¨å•å¦‚ä½•è¿›è¡Œæœ€åŸºæœ¬çš„æ›´æ–°ï¼Œè¿™é‡Œæ”¾ä¸€å¼ å­—èŠ‚å¤§ä½¬çš„å›¾\r\n\r\n![64652037b3ee4d1184d79e8e105e2429~tplv-k3u1fbpfcp-jj-mark_3024_0_0_0_q75[1].awebp](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a88f033593474fd58c47fa0bc79d781c~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1588&h=778&s=46900&e=webp&b=fffefe)\r\nå†ç†ä¸€ä¸‹æ€è·¯\r\n1. é¦–å…ˆæˆ‘ä»¬åœ¨Formç»„ä»¶ä¸­åˆ›å»ºäº†formInstance,å°†åˆå§‹å€¼å’Œä¸€äº›callbackç»‘å®šåˆ°äº†formä¸Šï¼Œç„¶åé€šè¿‡FieldContextå°†formInstanceä¸‹æ”¾åˆ°æ¯ä¸ªFieldç»„ä»¶é‡Œå®ç°äº†æ–¹æ³•å’Œæ•°æ®çš„å…±äº«\r\n2. åœ¨Fieldç»„ä»¶ä¸­ï¼Œå®ƒä¼šåœ¨componentDidMounté˜¶æ®µè¢«æ³¨å†Œåˆ°formInstanceä¸­ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡cloneElementè¿™ä¸ªapiå¯¹ä¼ å…¥Fieldçš„å­ç»„ä»¶çš„äº‹ä»¶è¿›è¡Œäº†åŠ«æŒï¼Œå½“è§¦å‘æŸç”Ÿäº‹ä»¶æ—¶Fieldç»„ä»¶è°ƒç”¨formInstanceçš„dispathæ–¹æ³•å¼€å§‹è§¦å‘æ›´æ–°\r\n3. dispathæ ¹æ®ä¸åŒçš„action typeä¼šæ´¾å‘ä¸åŒçš„äº‹ä»¶ï¼Œåœ¨updateVlueçš„æƒ…å†µä¸‹è°ƒç”¨äº†updateValueæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­é¦–å…ˆé€šè¿‡updateStoreæ–¹æ³•å¯¹Storeä¸­çš„æ•°æ®è¿›è¡Œäº†æ›´æ–°ï¼Œç„¶åè°ƒç”¨notifyObserveræ–¹æ³•ï¼ŒnotifyObserverä¼šéå†æ‰€æœ‰Fieldç»„ä»¶ï¼Œè°ƒç”¨ä»–ä»¬çš„onStorechangeæ–¹æ³•ï¼Œæ¯ä¸ªFieldç»„ä»¶ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°å’Œæ›´æ–°çš„ç±»å‹(å¦‚reset,setField),ç„¶åæ®æ­¤è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œæœ€åæ›´æ–°çš„æ–¹æ³•æ˜¯refresh()ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨äº†ç±»ç»„ä»¶çš„forceUpdateæ–¹æ³•  \r\n\r\nä¸Šé¢è¿™ç§æ›´æ–°æ–¹å¼æ˜¯é€šè¿‡ç”¨æˆ·çš„ä¸€äº›è¡Œä¸ºï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡forminstanceæš´éœ²çš„ä¸€äº›æ–¹æ³•å¦‚setFieldsValueå¯¹è¡¨å•è¿›è¡Œæ›´æ–°ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™æ˜¯å¦‚ä½•åšåˆ°çš„\r\n\r\n```js\r\nprivate setFieldsValue = (store: Store) => {\r\n  //é˜²æ­¢ç”¨æˆ·åœ¨formç»„ä»¶å¤–ä½¿ç”¨\r\n  this.warningUnhooked();\r\n\r\n  const prevStore = this.store;\r\n  //æ›´æ–°storeæ•°æ®\r\n  if (store) {\r\n    const nextStore = merge(this.store, store);\r\n    this.updateStore(nextStore);\r\n  }\r\n//è¿˜æ˜¯é€šè¿‡notifyObserversè§¦å‘æ‰€æœ‰Fieldçš„onStorechange\r\n  this.notifyObservers(prevStore, null, {\r\n    type: 'valueUpdate',\r\n    source: 'external',\r\n  });\r\n  ......\r\n};\r\n```\r\næœ€åèµ°åˆ°onStorechangeçš„ä»£ç \r\n\r\n```js\r\ncase 'setField': {\r\n  const { data } = info;\r\n  if (namePathMatch) {\r\n    if ('touched' in data) {\r\n      this.touched = data.touched;\r\n    }\r\n    if ('validating' in data && !('originRCField' in data)) {\r\n      this.validatePromise = data.validating ? Promise.resolve([]) : null;\r\n    }\r\n    if ('errors' in data) {\r\n      this.errors = data.errors || EMPTY_ERRORS;\r\n    }\r\n    if ('warnings' in data) {\r\n      this.warnings = data.warnings || EMPTY_ERRORS;\r\n    }\r\n    this.dirty = true;\r\n\r\n    this.triggerMetaEvent();\r\n\r\n    this.reRender();\r\n    return;\r\n  } else if ('value' in data && containsNamePath(namePathList, namePath, true)) {\r\n          // Contains path with value should also check\r\n    this.reRender();\r\n    return;\r\n  }\r\n```\r\nåªæ˜¯å¤šäº†ä¸€äº›æ•°æ®çš„å¤„ç†ï¼Œå…¶ä»–ä»£ç éƒ½å·®ä¸å¤šï¼Œåˆ°è¿™é‡Œformçš„æ›´æ–°å¤§æ¦‚å°±èŠå®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥è¯´è¯´è¡¨å•æ ¡éªŒæ˜¯å¦‚ä½•å®ç°çš„ã€‚\r\n# äºŒÂ·å¦‚ä½•å®ç°æ ¡éªŒ\r\n### å¦‚ä½•è§¦å‘æ ¡éªŒ\r\næƒ³è¦çŸ¥é“æ ¡éªŒçš„å®ç°ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—å…ˆçœ‹çœ‹æœ‰å“ªäº›æ–¹æ³•å¯ä»¥è§¦å‘formè¡¨å•çš„æ ¡éªŒï¼Œé¦–å…ˆæ˜¯formInstanceçš„submit\r\n\r\n```js\r\nprivate submit = () => {\r\n  this.warningUnhooked();\r\n//è¿™ä¸ªå°±æ˜¯æ ¡éªŒç›¸å…³çš„å‡½æ•°\r\n  this.validateFields()\r\n    .then(values => {\r\n      const { onFinish } = this.callbacks;\r\n      if (onFinish) {\r\n        try {\r\n          onFinish(values);\r\n        } catch (err) {\r\n          // Should print error if user `onFinish` callback failed\r\n          console.error(err);\r\n        }\r\n      }\r\n    })\r\n    .catch(e => {\r\n      const { onFinishFailed } = this.callbacks;\r\n      if (onFinishFailed) {\r\n        onFinishFailed(e);\r\n      }\r\n    });\r\n};\r\n}\r\n```\r\nè¿˜æœ‰å½“ä¸€äº›ç”¨æˆ·è¡Œä¸ºè§¦å‘çš„äº‹ä»¶å¦‚onChangeï¼Œå…¶å®è¿™ä¹Ÿæ˜¯åœ¨getControlledé‡Œå¸®æˆ‘ä»¬åŠ«æŒäº†\r\n\r\n```js\r\n\r\n  ...\r\n  //è§¦å‘æ ¡éªŒçš„event nameæ•°ç»„\r\n const validateTriggerList: string[] = toArray(mergedValidateTrigger || []);\r\n\r\n validateTriggerList.forEach((triggerName: string) => {\r\n   // Wrap additional function of component, so that we can get latest value from store\r\n   const originTrigger = control[triggerName];\r\n   //åŠ«æŒå¹¶æ·»åŠ æ ¡éªŒé€»è¾‘\r\n   control[triggerName] = (...args: EventArgs) => {\r\n     if (originTrigger) {\r\n       originTrigger(...args);\r\n     }\r\n\r\n     // å¦‚æœå­˜åœ¨ruleså°±dispatchæ´¾å‘æ ¡éªŒ\r\n     const { rules } = this.props;\r\n     if (rules && rules.length) {\r\n       // We dispatch validate to root,\r\n       // since it will update related data with other field with same name\r\n       dispatch({\r\n         type: 'validateField',\r\n         namePath,\r\n         triggerName,\r\n       });\r\n     }\r\n```\r\nè¿™é‡Œçš„dispatchä¹Ÿä¼šè§¦å‘formInstanceçš„validateFieldsæ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬å°±æŠŠæ³¨æ„åŠ›æ”¾åˆ°è¿™ä¸ªå‡½æ•°ä¸­\r\n### æ ¡éªŒçš„å®ç°\r\n\r\n```js\r\nprivate validateFields: InternalValidateFields = (arg1?: any, arg2?: any) => {\r\n  this.warningUnhooked();\r\n\r\n  let nameList: NamePath[];\r\n  let options: InternalValidateOptions;\r\n  //å¯¹ä¸åŒå½¢å¼ä¼ å…¥å‚æ•°çš„ä¸€äº›å¤„ç†\r\n  if (Array.isArray(arg1) || typeof arg1 === 'string' || typeof arg2 === 'string') {\r\n    nameList = arg1;\r\n    options = arg2;\r\n  } else {\r\n    options = arg1;\r\n  }\r\n  //è·å–ä¼ å…¥çš„Field name\r\n  const provideNameList = !!nameList;\r\n  const namePathList: InternalNamePath[] | undefined = provideNameList\r\n    ? nameList.map(getNamePath)\r\n    : [];\r\n\r\n  // ç”¨æ¥æ”¶é›†åç»­çš„æ ¡éªŒ\r\n  const promiseList: Promise<FieldError>[] = [];\r\n\r\n  //éå†æ¯ä¸ªFieldåˆ¤æ–­æ˜¯å¦éœ€è¦æ ¡éªŒ\r\n  this.getFieldEntities(true).forEach((field: FieldEntity) => {\r\n    // å¦‚æœæ²¡æœ‰ä¼ å…¥namelistå°±æŠŠæ‰€æœ‰FieldåŠ å…¥namePathListä¸­\r\n    if (!provideNameList) {\r\n      namePathList.push(field.getNamePath());\r\n    }\r\n\r\n    // å¦‚æœæ²¡æœ‰é…ç½®ruleå°±ä¸éœ€è¦åç»­æ“ä½œ\r\n    if (!field.props.rules || !field.props.rules.length) {\r\n      return;\r\n    }\r\n\r\n    const fieldNamePath = field.getNamePath();\r\n \r\n\r\n    //è°ƒç”¨Fieldçš„æ ¡éªŒæ–¹æ³•ï¼Œä¿å­˜è¯¥æ–¹æ³•çš„Promise\r\n    if (!provideNameList || containsNamePath(namePathList, fieldNamePath, recursive)) {\r\n      const promise = field.validateRules({\r\n        validateMessages: {\r\n          ...defaultValidateMessages,\r\n          ...this.validateMessages,\r\n        },\r\n        ...options,\r\n      });\r\n\r\n      // å°†ä¿å­˜çš„Promiseæ¨å…¥ä¹‹å‰åˆ›å»ºçš„promiseListä¸­\r\n      promiseList.push(\r\n        promise\r\n          .then<any, RuleError>(() => ({ name: fieldNamePath, errors: [], warnings: [] }))\r\n          .catch((ruleErrors: RuleError[]) => {\r\n          //ä¿ç•™é”™è¯¯å’Œwarnings\r\n            const mergedErrors: string[] = [];\r\n            const mergedWarnings: string[] = [];\r\n            //æ ¹æ®ä¼ å…¥çš„ä¸åŒé…ç½®å¯¹é”™è¯¯è¿›è¡Œä¸åŒå¤„ç†         \r\n            ruleErrors.forEach?.(({ rule: { warningOnly }, errors }) => {\r\n              if (warningOnly) {\r\n                mergedWarnings.push(...errors);\r\n              } else {\r\n                mergedErrors.push(...errors);\r\n              }\r\n            });\r\n             //æ ¹æ®æ˜¯å¦æœ‰é”™è¯¯è¿”å›ä¸åŒç»“æœ\r\n            if (mergedErrors.length) {\r\n              return Promise.reject({\r\n                name: fieldNamePath,\r\n                errors: mergedErrors,\r\n                warnings: mergedWarnings,\r\n              });\r\n            }\r\n\r\n            return {\r\n              name: fieldNamePath,\r\n              errors: mergedErrors,\r\n              warnings: mergedWarnings,\r\n            };\r\n          }),\r\n      );\r\n      }\r\n  });\r\n   //æ”¶é›†æ‰€æœ‰æ£€éªŒé¡¹çš„ç»“æœ\r\n  const summaryPromise = allPromiseFinish(promiseList);\r\n    //å°†è¿™æ¬¡æ ¡éªŒçš„ç»“æœä¿å­˜åœ¨formInstanceä¸­\r\n  this.lastValidatePromise = summaryPromise;\r\n\r\n  // Notify fields with rule that validate has finished and need update\r\n  summaryPromise\r\n    .catch(results => results)\r\n    .then((results: FieldError[]) => {\r\n      const resultNamePathList: InternalNamePath[] = results.map(({ name }) => name);\r\n      //é€šçŸ¥Fieldè¿›è¡Œæ›´æ–°\r\n      this.notifyObservers(this.store, resultNamePathList, {\r\n        type: 'validateFinish',\r\n      });\r\n      this.triggerOnFieldsChange(resultNamePathList, results);\r\n    });\r\n    //è¿™ä¸ªPromiseå°†ä¼šè¢«ä½œä¸ºè¿”å›å€¼ï¼Œåœ¨submitçš„æ—¶å€™ä¼šèµ·åˆ°ä½œç”¨\r\n  const returnPromise: Promise<Store | ValidateErrorEntity | string[]> = summaryPromise\r\n    .then((): Promise<Store | string[]> => {\r\n    //å¦‚æœæ²¡æœ‰è§„åˆ™é”™è¯¯å°±ç›´æ¥è¿”å›æ‰€æœ‰æ ¡éªŒé¡¹çš„å€¼\r\n      if (this.lastValidatePromise === summaryPromise) {\r\n        return Promise.resolve(this.getFieldsValue(namePathList));\r\n      }\r\n      return Promise.reject<string[]>([]);\r\n    })\r\n    .catch((results: { name: InternalNamePath; errors: string[] }[]) => {\r\n    //å­˜åœ¨é”™è¯¯å°†é”™è¯¯æ•´ç†è¿”å›\r\n      const errorList = results.filter(result => result && result.errors.length);\r\n      return Promise.reject({\r\n        values: this.getFieldsValue(namePathList),\r\n        errorFields: errorList,\r\n        outOfDate: this.lastValidatePromise !== summaryPromise,\r\n      });\r\n    });\r\n\r\n  // Do not throw in console\r\n  returnPromise.catch<ValidateErrorEntity>(e => e);\r\n\r\n  return returnPromise as Promise<Store>;\r\n  };\r\n```\r\nè¿™é‡Œçš„ä»£ç æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬æ¥æ•´ç†ä¸€ä¸‹å…³é”®çš„åœ°æ–¹ï¼šå¦‚æœä¼ å…¥äº†nameListé‚£ä¹ˆä¼šå¯¹nameListå¯¹åº”çš„Fieldè¿›è¡Œæ ¡éªŒï¼Œå¦åˆ™å°±ä¼šå…¨éƒ¨æ ¡éªŒï¼Œå½“ç„¶ä»–ä»¬éœ€è¦ä¼ å…¥äº†rulesï¼Œè€Œè¿™é‡Œçš„æ ¡éªŒæ–¹æ³•å…¶å®æ˜¯è°ƒç”¨çš„Fieldç»„ä»¶çš„validateRulesæ–¹æ³•ï¼Œè¿™ä¸ªå‡½æ•°æˆ‘ä»¬åç»­ä¼šåˆ†æï¼Œç„¶åæˆ‘ä»¬ä¼šæŠŠvalidateRulesè¿”å›çš„promiseæ”¶é›†åˆ°promiseListä¸­ï¼Œé€šè¿‡allPromiseFinishå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°æ ¡éªŒç»“æœçš„æ•°ç»„äº†ï¼Œæ¥ä¸‹æ¥ä¸»è¦å°±æ˜¯2ä»¶äº‹ï¼Œä¸€æ˜¯é€šçŸ¥å¯¹åº”çš„Fieldè¿›è¡Œæ›´æ–°ï¼ŒäºŒæ˜¯æ ¹æ®æ ¡éªŒç»“æœè¿”å›Promiseä½œä¸º onFinishFailedå’ŒonFinishçš„è§¦å‘ä¾æ®ï¼Œè¿™é‡Œçš„é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ã€‚æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹Fieldç»„ä»¶ä¸­çš„validateRulesæ–¹æ³•\r\n\r\n```js\r\npublic validateRules = (options?: InternalValidateOptions): Promise<RuleError[]> => {\r\n\r\n  const namePath = this.getNamePath();\r\n  const currentValue = this.getValue();\r\n\r\n  const { triggerName, validateOnly = false } = options || {};\r\n  \r\n  const rootPromise = Promise.resolve().then(async (): Promise<any[]> => {\r\n    if (!this.mounted) {\r\n      return [];\r\n    }\r\n\r\n    const { validateFirst = false, messageVariables, validateDebounce } = this.props;\r\n\r\n    // å¯¹ruleçš„ä¸€äº›è¿‡æ»¤ï¼Œè¿™é‡Œä¸»è¦æ˜¯æ’é™¤ç©ºæ ¡éªŒå’Œè§¦å‘æ—¶æœºä¸æ»¡è¶³çš„\r\n    let filteredRules = this.getRules();\r\n    if (triggerName) {\r\n      filteredRules = filteredRules\r\n        .filter(rule => rule)\r\n        .filter((rule: RuleObject) => {\r\n          const { validateTrigger } = rule;\r\n          if (!validateTrigger) {\r\n            return true;\r\n          }\r\n          const triggerList = toArray(validateTrigger);\r\n          return triggerList.includes(triggerName);\r\n        });\r\n    }\r\n    \r\n     ......\r\n     \r\n    //å…¶å®è¿™ä¸ªpromiseå°±æ˜¯åŒ…å«äº†å½“å‰æ£€éªŒç»“æœçš„promise\r\n    const promise = validateRules(\r\n      namePath,\r\n      currentValue,\r\n      filteredRules,\r\n      options,\r\n      validateFirst,\r\n      messageVariables,\r\n    );\r\n\r\n    promise\r\n      .catch(e => e)\r\n      .then((ruleErrors: RuleError[] = EMPTY_ERRORS) => {\r\n        if (this.validatePromise === rootPromise) {\r\n          this.validatePromise = null;\r\n\r\n          //æ ¹æ®optionå¤„ç†æ•°æ®è·Ÿå‰é¢ç›¸ä¼¼\r\n          const nextErrors: string[] = [];\r\n          const nextWarnings: string[] = [];\r\n          ruleErrors.forEach?.(({ rule: { warningOnly }, errors = EMPTY_ERRORS }) => {\r\n            if (warningOnly) {\r\n              nextWarnings.push(...errors);\r\n            } else {\r\n              nextErrors.push(...errors);\r\n            }\r\n          });\r\n           æŠŠç»“æœå­˜å‚¨åœ¨å½“å‰Fieldä¸Š\r\n          this.errors = nextErrors;\r\n          this.warnings = nextWarnings;\r\n          this.triggerMetaEvent();\r\n          this.reRender();\r\n        }\r\n      });\r\n\r\n    return promise;\r\n  });\r\n\r\n  if (validateOnly) {\r\n    return rootPromise;\r\n  }\r\n  //ä¸€äº›æ•°æ®çš„æ›´æ–°\r\n  this.validatePromise = rootPromise;\r\n  this.dirty = true;\r\n  this.errors = EMPTY_ERRORS;\r\n  this.warnings = EMPTY_ERRORS;\r\n  this.triggerMetaEvent();\r\n\r\n  // Force trigger re-render since we need sync renderProps with new meta\r\n  this.reRender();\r\n  //å¯ä»¥çœ‹åˆ°æ­£å¸¸æµç¨‹ä¸‹å…¶å®å°±æ˜¯è¿”å›çš„validateRules(...args)çš„promiseç»“æœ\r\n  return rootPromise;\r\n  };\r\n```\r\næ‰€ä»¥è¿™é‡Œçš„å¤§éƒ¨åˆ†ä»£ç è¿˜æ˜¯åœ¨è¿›è¡Œæµç¨‹çš„ä¸²è”å’ŒFieldå†…éƒ¨çŠ¶æ€çš„ä¸€äº›å¤„ç†ï¼Œæ ¡éªŒç›¸å…³çš„è¿˜æ˜¯ä¹Ÿå¹¶éåœ¨è¿™é‡Œå®ç°ï¼Œå…¶å®rc-field-formçš„è¡¨å•æ ¡éªŒä¾èµ–äº†rc-component/async-validatorï¼Œç„¶åå¯¹å…¶è¿›è¡Œäº†ä¸€äº›å°è£…ï¼Œè¿™é‡Œä¹Ÿä¸åšè¿‡å¤šä»‹ç»äº†ã€‚\r\n# ä¸‰ ä¸€äº›å…¶ä»–åŠŸèƒ½\r\nä¸Šé¢èŠå®Œäº†formçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ä¸€çœ‹ä¸€äº›æ¯”è¾ƒå¥½ç”¨çš„ç‰¹æ€§.\r\né¦–å…ˆæ˜¯listç»„ä»¶ï¼Œè¿™é‡Œæˆ‘æ”¾ä¸€ä¸ª[antdçš„ä¾‹å­](https://ant.design/components/form-cn#components-form-demo-dynamic-form-item)ï¼Œä¸ç†Ÿæ‚‰çš„å¯ä»¥å»äº†è§£ä¸€ä¸‹æ•ˆæœã€‚\r\n### List\r\n\r\n```js\r\n <List name='xxx'>\r\n {(fields, { add, remove }, { errors }) => (\r\n          <>\r\n            {fields.map((field, index) => (\r\n                <Field\r\n                  {...field}\r\n                >\r\n                  <Input placeholder=\"passenger name\"/>\r\n                </Field>\r\n            ))}\r\n          </>\r\n        )}\r\n      </List>\r\n```\r\nå¤§æ¦‚çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸Šï¼Œæˆ‘ä»¬éœ€è¦ç»™Listç»„ä»¶ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œç„¶ååœ¨è¿™ä¸ªå‡½æ•°é‡Œé€šè¿‡ç»„ä»¶ç»™æˆ‘ä»¬çš„fieldså‚æ•°è¿›è¡Œéå†æ¸²æŸ“å‡ºæ¯ä¸ªFieldï¼ŒåŒæ—¶ä»–ä¹Ÿç»™æˆ‘ä»¬æä¾›äº†ä¸€äº›æ–¹æ³•å¯¹æ•°æ®è¿›è¡Œæ“æ§ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹å¦‚ä½•å®ç°ã€‚å…ˆè´´å‡ºè¿™ä¸ªç»„ä»¶çš„ä»£ç ï¼Œç„¶åæˆ‘ä»¬æ¥æ…¢æ…¢åˆ†æã€‚\r\n\r\n```js\r\nfunction List<Values = any>({\r\n  name,\r\n  initialValue,\r\n  children,\r\n  rules,\r\n  validateTrigger,\r\n  isListField,\r\n}: ListProps<Values>) {\r\n//å­˜æ”¾äº†formInstanceå’ŒvalidateTrigger\r\n  const context = React.useContext(FieldContext);\r\n  //ç°åœ¨è¿™é‡Œè¿˜æ²¡æœ‰ä¸œè¥¿\r\n  const wrapperListContext = React.useContext(ListContext);\r\n  const keyRef = React.useRef({\r\n    keys: [],\r\n    id: 0,\r\n  });\r\n  const keyManager = keyRef.current;\r\n  //è·å–å½“å‰çš„Fieldname\r\n  const prefixName: InternalNamePath = React.useMemo(() => {\r\n    const parentPrefixName = getNamePath(context.prefixName) || [];\r\n    return [...parentPrefixName, ...getNamePath(name)];\r\n  }, [context.prefixName, name]);\r\n  //åˆ›å»ºcontextä¼ é€’firminstanceå’Œname\r\n  const fieldContext = React.useMemo(() => ({ ...context, prefixName }), [context, prefixName]);\r\n\r\n  // åˆ›å»ºlistçš„context\r\n  const listContext = React.useMemo<ListContextProps>(\r\n    () => ({\r\n      getKey: (namePath: InternalNamePath) => {\r\n        const len = prefixName.length;\r\n        const pathName = namePath[len];\r\n        return [keyManager.keys[pathName], namePath.slice(len + 1)];\r\n      },\r\n    }),\r\n    [prefixName],\r\n  );\r\n  // listç»„ä»¶çš„childrenåªèƒ½ä¼ å…¥å‡½æ•°\r\n  if (typeof children !== 'function') {\r\n    warning(false, 'Form.List only accepts function as children.');\r\n    return null;\r\n  }\r\n //è¾…åŠ©æ›´æ–°\r\n  const shouldUpdate = (prevValue: StoreValue, nextValue: StoreValue, { source }) => {\r\n    if (source === 'internal') {\r\n      return false;\r\n    }\r\n    return prevValue !== nextValue;\r\n  };\r\n \r\n  return (\r\n    <ListContext.Provider value={listContext}>\r\n      <FieldContext.Provider value={fieldContext}>\r\n        <Field\r\n          name={[]}\r\n          shouldUpdate={shouldUpdate}\r\n          rules={rules}\r\n          validateTrigger={validateTrigger}\r\n          initialValue={initialValue}\r\n          isList\r\n          isListField={isListField ?? !!wrapperListContext}\r\n        >\r\n         .........\r\n         \r\n        </Field>\r\n      </FieldContext.Provider>\r\n    </ListContext.Provider>\r\n  );\r\n}\r\n```\r\nçœ‹åˆ°è¿™é‡Œå…¶å®æˆ‘ä»¬èƒ½å¤Ÿå‘ç°ï¼Œlistç»„ä»¶å…¶å®è¿˜æ˜¯æ ¹æ®Fieldç»„ä»¶è¿›è¡Œçš„å°è£…ï¼Œç°åœ¨æˆ‘ä»¬å†æ¥çœ‹çœ‹Fieldç»„ä»¶é‡Œéƒ½æœ‰ä»€ä¹ˆä¸œè¥¿\r\n\r\n```js\r\n{({ value = [], onChange }, meta) => {\r\n  const { getFieldValue } = context;\r\n  //è·å–å½“å‰Filedç»´æŠ¤çš„å€¼\r\n  const getNewValue = () => {\r\n      const values = getFieldValue(prefixName || []) as StoreValue[];\r\n      return values || [];\r\n };\r\n    const operations: ListOperations = {\r\n      add: (defaultValue, index?: number) => {\r\n         // Mapping keys\r\n        const newValue = getNewValue();\r\n        console.log(newValue,defaultValue)\r\n         if (index >= 0 && index <= newValue.length) {\r\n          keyManager.keys = [\r\n             ...keyManager.keys.slice(0, index),\r\n            keyManager.id,\r\n             ...keyManager.keys.slice(index),\r\n          ];\r\n          onChange([...newValue.slice(0, index), defaultValue, ...newValue.slice(index)]);\r\n         } else {\r\n          if (\r\n             process.env.NODE_ENV !== 'production' &&\r\n            (index < 0 || index > newValue.length)\r\n           ) {\r\n             warning(\r\n                false,\r\n               'The second parameter of the add function should be a valid positivenumber.',\r\n             );\r\n           }\r\n           keyManager.keys = [...keyManager.keys, keyManager.id];\r\n           console.log(keyManager)\r\n           onChange([...newValue, defaultValue]);\r\n        }\r\n         keyManager.id += 1;\r\n      }ï¼Œ\r\n\r\n     let listValue = value || [];\r\n     if (!Array.isArray(listValue)) {\r\n      listValue = [];\r\n\r\n       if (process.env.NODE_ENV !== 'production') {\r\n         warning(\r\n           false,\r\n           `Current value of '${prefixName.join(' > ')}' is not an array type.`,\r\n         );\r\n       }\r\n     }\r\n\r\n    return children(\r\n      (listValue as StoreValue[]).map((__, index): ListField => {\r\n        let key = keyManager.keys[index];\r\n        if (key === undefined) {\r\n         keyManager.keys[index] = keyManager.id;\r\n            key = keyManager.keys[index];\r\n            keyManager.id += 1;\r\n          }\r\n\r\n         return {\r\n           name: index,\r\n           key,\r\n           isListField: true,\r\n         };\r\n       }),\r\n       operations,\r\n       meta,\r\n     );\r\n    }}\r\n```\r\n é¦–å…ˆæˆ‘ä»¬æ³¨æ„åˆ°ï¼ŒFieldç»„ä»¶é‡Œæˆ‘ä»¬ä¼ å…¥çš„ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™é‡Œéœ€è¦å…ˆå¸¦å¤§å®¶å¤ä¹ ä¸€ä¸‹ï¼Œåœ¨Fieldç»„ä»¶ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä¼ å…¥çš„childæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆä¼šä¼ å…¥getControlled(), meta,fieldContextè¿™3ä¸ªå‚æ•°(ç›¸å…³å‡½æ•°getOnlyChild )ï¼Œå¹¶å°†å‡½æ•°çš„è¿”å›å€¼ä½œä¸ºæœ€ç»ˆçš„child,metaå…¶å®å°±æ˜¯Fieldçš„ä¸€äº›çŠ¶æ€ï¼Œæ¥ä¸‹æ¥æ¥çœ‹çœ‹operations\r\n\r\n```js\r\n   const operations: ListOperations = {\r\n      add: (defaultValue, index?: number) => {\r\n         // å…¶å®è¿™é‡Œè·å–çš„å°±æ˜¯å½“å‰çš„å€¼\r\n        const newValue = getNewValue();\r\n        å¦‚æœä¼ å…¥äº†indexå¹¶ä¸”indexæ²¡æœ‰è¶…å‡ºå½“å‰indexå°±æ’å…¥\r\n         if (index >= 0 && index <= newValue.length) {\r\n          keyManager.keys = [\r\n             ...keyManager.keys.slice(0, index),\r\n            keyManager.id,\r\n             ...keyManager.keys.slice(index),\r\n          ];\r\n          //ä¸€ä¸ªonChangeæ–¹æ³•ï¼Œä¼ å…¥äº†æ–°å€¼\r\n          onChange([...newValue.slice(0, index), defaultValue, ...newValue.slice(index)]);\r\n         } else {\r\n          if (\r\n             process.env.NODE_ENV !== 'production' &&\r\n            (index < 0 || index > newValue.length)\r\n           ) {\r\n           //ä¸€äº›é”™è¯¯å¤„ç†\r\n             warning(\r\n                false,\r\n               'The second parameter of the add function should be a valid positivenumber.',\r\n             );\r\n           }\r\n           //å¦è€…é»˜è®¤å°†å€¼æ›´æ–°åˆ°æœ€å\r\n           keyManager.keys = [...keyManager.keys, keyManager.id];\r\n           onChange([...newValue, defaultValue]);\r\n        }\r\n         keyManager.id += 1;\r\n      }ï¼Œ\r\n```\r\nå…¶å®è¿™ä¸€éƒ¨åˆ†å°±æ˜¯ç»´æŠ¤äº†ä¸€ä¸ªå¯¹è±¡ï¼Œæä¾›äº†ä¹‹å‰addç­‰ä¸€äº›ä¿®æ”¹æ•°æ®çš„æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•è¿™é‡Œçœç•¥äº†ã€‚\r\n\r\n```js\r\n let listValue = value || [];\r\n if (!Array.isArray(listValue)) {\r\n   listValue = [];\r\n\r\n   if (process.env.NODE_ENV !== 'production') {\r\n      warning(false,`Current value of '${prefixName.join(' > ')}' is not an array type.`);\r\n    }\r\n }\r\n```\r\nè¿™é‡Œä¹Ÿå¾ˆç®€å•ï¼Œå¯¹listvalueè¿›è¡Œäº†ä¸€äº›åˆ¤æ–­ï¼Œæ¥ä¸‹æ¥æ˜¯æœ€åçš„ä¸€éƒ¨åˆ†\r\n\r\n```js\r\n     return children(\r\n       (listValue as StoreValue[]).map((__, index): ListField => {\r\n         let key = keyManager.keys[index];\r\n         if (key === undefined) {\r\n           keyManager.keys[index] = keyManager.id;\r\n           key = keyManager.keys[index];\r\n           keyManager.id += 1;\r\n         }\r\n\r\n         return {\r\n           name: index,\r\n           key,\r\n           isListField: true,\r\n         };\r\n       }),\r\n       operations,\r\n       meta,\r\n     );\r\n```\r\nè¿™é‡Œçš„childrenæ˜¯ä»€ä¹ˆå‘¢ï¼Œå…¶å®è¿™é‡Œçš„childrenå°±æ˜¯æˆ‘ä»¬åœ¨Listç»„ä»¶é‡Œä¼ å…¥çš„å‡½æ•°ï¼Œè¿™æ ·çš„è¯å°±å¾ˆæ˜æ˜¾äº†Listç»„ä»¶å¸®å…¶å®å°±æ˜¯å¸®æˆ‘ä»¬è¿›è¡Œäº†æ•°æ®ç®¡ç†ï¼Œå¹¶å°†æ“ä½œæ•°æ®çš„æ–¹æ³•æš´éœ²ç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹æœ€å¼€å§‹æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨Listç»„ä»¶çš„\r\n\r\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d444717d4fbd4ef093f83dd6caf141e9~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1018&h=362&s=28328&e=png&b=f8f8f8)\r\nè¿™é‡Œä¼ é€’çš„filedå±æ€§å…¶å®å°±æŠŠè¿™æ ·çš„å±æ€§ä¼ é€’ç»™äº†Fieldã€‚\r\n\r\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7a829367ec294c9b95363a2581ac74f6~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=340&h=87&s=18232&e=png&b=202021)  \r\næ¥ç€æˆ‘ä»¬å†æ¥çœ‹çœ‹Listç»„ä»¶ä¸ºä»€ä¹ˆèƒ½å¤Ÿåšåˆ°å¯¹å­æ•°æ®çš„ç»Ÿä¸€ç®¡ç†å‘¢ã€‚  \r\n ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¯”å¦‚æˆ‘ä»¬ç»´æŠ¤äº†ä¸€ä¸ªusersçš„Fieldæ•°ç»„ï¼Œé‚£ä¹ˆä»–çš„æ•°æ®ç»“æ„å¤§æ¦‚æ˜¯ *users:['xiaomin','xiaozhang']*,å½“æˆ‘ä»¬é€šè¿‡listç»„ä»¶æš´éœ²å‡ºæ¥çš„æ–¹æ³•å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶å› ä¸ºlistç»„ä»¶æ˜¯åŸºäºFieldçš„å°è£…ï¼Œæ‰€ä»¥è¿™äº›ä¿®æ”¹ä¼šè§¦å‘onStoreChangeè®©listç»„ä»¶rerenderï¼Œè€Œå…¶ä¸­çš„å­Fieldè‡ªç„¶ä¹Ÿä¼šé‡æ–°æ¸²æŸ“ï¼Œé‚£ä¹ˆå­Fieldæ˜¯å¦‚ä½•è·å–æ­£ç¡®çš„å€¼å‘¢ï¼Œçœ‹ä¸Šé¢é‚£å¼ å›¾ï¼Œæˆ‘ä»¬ç»™å­ç»„ä»¶ä¼ é€’äº†ä¸€ä¸ªkeyï¼Œåœ¨getControlledçš„æ—¶å€™ï¼ŒFieldä¼šè°ƒç”¨getValueæ–¹æ³•è·å–å€¼ï¼Œå…¶å®è¿™ä¸ªgetValueå‡½æ•°å°±ç±»ä¼¼ä¸lodashä¸­çš„getæ–¹æ³•ï¼Œè€Œå¦‚æœä¸€ä¸ªFieldæ˜¯listFieldçš„è¯ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬è·å–namePathæ—¶å…¶å®ä¸€ç§ [parentName,key] çš„å½¢å¼\r\n\r\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/98f7336c717643948c80631320734068~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=143&h=42&s=1501&e=png&b=fffefe)\r\næ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®è¿™ä¸ªè·å–æ–°å€¼è¾¾åˆ°æ›´æ–°çš„æ•ˆæœï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ç‚¹ï¼ŒæŸä¸ªå­Fieldçš„æ›´æ–°å…¶å®æ˜¯ä¸ä¼šå½±å“åˆ°Listç»„ä»¶çš„ã€‚\r\n### dependence\r\næœ€åæˆ‘ä»¬å†æ¥èŠä¸€èŠå¦ä¸€ä¸ªåŠŸèƒ½ï¼Œdependence.è¿™é‡Œè¿˜æ˜¯ç»™å‡ºä¸€ä¸ª[antdçš„ä¾‹å­](https://ant.design/components/form-cn#components-form-demo-form-dependencies)ï¼Œç®€å•çš„è¯´ï¼Œå°±æ˜¯æˆ‘ä»¬å¯ä»¥ç»™æŸä¸ªFliedé…ç½®dependenceå­—æ®µï¼Œå½“dependenceæ•°ç»„ä¸­åŒ…å«çš„Fieldè§¦å‘äº†æ›´æ–°ï¼Œè¿™ä¸ªFieldä¹Ÿä¼šåŒæ­¥è§¦å‘æ›´æ–°ã€‚ ä¸‹é¢æ˜¯rc-field-formå®˜æ–¹demoï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•ä¸€ä¸‹ã€‚å½“nameä¸º1æ—¶å¯ä»¥çœ‹åˆ°passwordæ¸²æŸ“ï¼Œç„¶åpasswordå¦‚æœä¸ä¸ºç©ºåˆ™password2æ¸²æŸ“ ï¼Œ**åæ¥åœ¨å†™æ–‡ç« çš„æ—¶å€™æ„Ÿè§‰è¿™ä¸ªä¾‹å­æ˜¯æœ‰é—®é¢˜çš„ï¼Œæˆ‘ä»¬ä¸€ä¼šå†åˆ†æ**\r\n\r\n```js\r\nimport Form, { Field } from 'rc-field-form';\r\nimport React from 'react';\r\nimport Input from './components/Input';\r\n\r\ntype FormData = {\r\n  name?: string;\r\n  password?: string;\r\n  password2?: string;\r\n};\r\n\r\nexport default () => {\r\n  const [form] = Form.useForm();\r\n\r\n  return (\r\n    <Form\r\n      form={form}\r\n      preserve={false}\r\n      onFieldsChange={fields => {\r\n        console.error('fields:', fields);\r\n      }}\r\n    >\r\n      <Field<FormData> name=\"name\">\r\n        <Input placeholder=\"Username\" />\r\n      </Field>\r\n\r\n      <Field<FormData> dependencies={['name']}>\r\n        {() => {\r\n          return form.getFieldValue('name') === '1' ? (\r\n            <Field name=\"password\">\r\n              <Input placeholder=\"Password\" />\r\n            </Field>\r\n          ) : null;\r\n        }}\r\n      </Field>\r\n\r\n      <Field dependencies={['password']}>\r\n        {() => {\r\n          const password = form.getFieldValue('password');\r\n          console.log('>>>', password);\r\n          return password ? (\r\n            <Field<FormData> name={['password2']}>\r\n              <Input placeholder=\"Password 2\" />\r\n            </Field>\r\n          ) : null;\r\n        }}\r\n      </Field>\r\n\r\n      <button onClick={()=} type=\"submit\">Submit</button>\r\n    </Form>\r\n  );\r\n};\r\n```\r\nè¿™é‡Œæˆ‘ä»¬ç›´æ¥æ¥è®²ä»–æ˜¯å¦‚ä½•å®ç°çš„,æˆ‘çœ‹äº†ä¸€ä¸‹æºç ç„¶åå†™demoæµ‹è¯•åå‘ç°åœ¨rc-field-formé‡Œå¦‚æœæˆ‘ä»¬é€šè¿‡å¦‚setFieldValueè¿™æ ·çš„apiæ˜¯æ— æ³•è§¦å‘dependenceæ›´æ–°çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å°±åªèŠé€šè¿‡onChangeç­‰è¡Œä¸ºè§¦å‘çš„æ›´æ–°ã€‚\r\n\r\n```js\r\n  private updateValue = (name: NamePath, value: StoreValue) => {\r\n  \r\n   ......\r\n\r\n    const childrenFields = this.triggerDependenciesUpdate(prevStore, namePath);\r\n   ......\r\n  };\r\n```\r\nå¯ä»¥çœ‹åˆ°å…·ä½“çš„é€»è¾‘æ˜¯ç”±**updateValue**å¼€å§‹çš„ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹**triggerDependenciesUpdate**å¹²äº†å•¥\r\n\r\n```js\r\n  private triggerDependenciesUpdate = (prevStore: Store, namePath: InternalNamePath) => {\r\n  //è¿™ä¸ªå‡½æ•°ç­‰ä¼šè®²ï¼Œå…¶å®å°±æ˜¯æ‹¿åˆ°ä¾èµ–äºå½“å‰å­—æ®µçš„Field\r\n    const childrenFields = this.getDependencyChildrenFields(namePath);\r\n    //å¯¹ä¾èµ–äºå½“å‰å­—æ®µçš„Fieldè¿›è¡Œæ ¡éªŒ\r\n    if (childrenFields.length) {\r\n      this.validateFields(childrenFields);\r\n    }\r\n    //é€šçŸ¥æ›´æ–°\r\n    this.notifyObservers(prevStore, childrenFields, {\r\n      type: 'dependenciesUpdate',\r\n      relatedFields: [namePath, ...childrenFields],\r\n    });\r\n\r\n    return childrenFields;\r\n  };\r\n\r\n```\r\næ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹**getDependencyChildrenFields**è¿™ä¸ªæ–¹æ³•ï¼Œ\r\n\r\n```js\r\n  private getDependencyChildrenFields = (rootNamePath: InternalNamePath): InternalNamePath[] => {   \r\n    const children: Set<FieldEntity> = new Set();\r\n    //è¿”å›å€¼ï¼Œè¿™ä¸ªæ˜¯è¢«æ‰“å¹³çš„denpendence\r\n    const childrenFields: InternalNamePath[] = [];\r\n    //ç”¨äºå­˜å‚¨ä¾èµ–çš„map\r\n    const dependencies2fields: NameMap<Set<FieldEntity>> = new NameMap();\r\n    \r\n    ........\r\n    \r\n    return childrenFields;\r\n  };\r\n```\r\næ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“çš„å¤„ç†ï¼Œé¦–å…ˆæ˜¯æ„å»ºä¾èµ–map\r\n\r\n```js\r\n    this.getFieldEntities().forEach(field => {\r\n      console.log(field.props.dependencies)\r\n      const { dependencies } = field.props;\r\n      (dependencies || []).forEach(dependency => {\r\n        const dependencyNamePath = getNamePath(dependency);\r\n        dependencies2fields.update(dependencyNamePath, (fields = new Set()) => {\r\n          fields.add(field);\r\n          return fields;\r\n        });\r\n      });\r\n    });\r\n```\r\nä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœCå’ŒDä¾èµ–Bï¼ŒBä¾èµ–Aï¼Œè¿™æ ·å°±ä¼šåˆ›å»ºå‡ºè¿™æ ·çš„mapæ¥ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·çš„æ“ä½œå‘¢ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥æƒ³ä¸€ä¸‹ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè™½ç„¶Cï¼ŒDçš„dependenceæ˜¯Bï¼Œä½†æ˜¯BåŒæ—¶ä¹Ÿä¾èµ–äºAï¼Œé‚£ä¹ˆå¦‚æœAè§¦å‘äº†æ›´æ–°ï¼ŒCå’ŒDä¹Ÿåº”è¯¥æ›´æ–°ï¼Œæ‰€ä»¥**getDependencyChildrenFields**å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§å¾ªç¯ä¾èµ–ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†dependenceMapï¼Œæ¥ä¸‹æ¥å°±éœ€è¦é€šè¿‡è¿™ä¸ªmapè·å–æ‰€æœ‰çš„ä¾èµ–\r\n\r\n```js\r\n{\r\n    A: [FieldB],\r\n    B: [FieldCï¼ŒFieldD]\r\n}\r\n\r\n```\r\n\r\n```js\r\n    const fillChildren = (namePath: InternalNamePath) => {\r\n      //è·å–ç›´æ¥ä¾èµ–äºå®ƒçš„Field\r\n      const fields = dependencies2fields.get(namePath) || new Set();\r\n      //æŸ¥çœ‹æ˜¯å¦æœ‰Fieldé—´æ¥ä¾èµ–\r\n      fields.forEach(field => {\r\n      //åªåˆ¤æ–­æœªåˆ¤æ–­è¿‡çš„\r\n        if (!children.has(field)) {\r\n          children.add(field);\r\n\r\n          const fieldNamePath = field.getNamePath();\r\n          if (fieldNamePath.length) {\r\n            childrenFields.push(fieldNamePath);\r\n            fillChildren(fieldNamePath);\r\n          }\r\n        }\r\n      });\r\n    };\r\n\r\n    fillChildren(rootNamePath);\r\n```\r\nè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°æ‰€æœ‰ä¾èµ–çš„Fieldäº†ï¼Œæˆ‘ä»¬ç»§ç»­å›åˆ°æ›´æ–°çš„æµç¨‹ã€‚\r\n\r\n```js\r\n    this.notifyObservers(prevStore, childrenFields, {\r\n      type: 'dependenciesUpdate',\r\n      relatedFields: [namePath, ...childrenFields],\r\n    });\r\n```\r\nè¿™é‡Œå·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œé€šè¿‡notifyObserverè°ƒç”¨æ‰€æœ‰Fieldçš„onStoreChangeï¼Œæˆ‘ä»¬ç›´æ¥çœ‹åœ¨onStoreChangeé‡Œè¿›è¡Œäº†å“ªäº›æ“ä½œ\r\n\r\n```js\r\n\r\n      case 'dependenciesUpdate': {\r\n        //è·å–å½“å‰Fieldçš„dependence\r\n        const dependencyList = dependencies.map(getNamePath);\r\n        //å¦‚æœæŸä¸ªä¾èµ–è¢«åŒ…å«åœ¨relatedFieldsä¸­å°±è§¦å‘æ›´æ–°\r\n        if (dependencyList.some(dependency => containsNamePath(info.relatedFields, dependency))) {\r\n          this.reRender();\r\n          return;\r\n        }\r\n        break;\r\n      }\r\n```\r\nå…¶å®è¿™é‡Œä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥dependenceçš„æµç¨‹æˆ‘ä»¬ä¹Ÿåˆ†æå®Œäº†ã€‚  \r\næœ€åå°±æ˜¯è¯´è¯´åˆšæ‰æˆ‘æåˆ°äº†å®˜æ–¹çš„demoæœ‰é—®é¢˜ï¼Œä¸‹é¢å°±æ¥è°ˆè°ˆä¸ºä»€ä¹ˆæœ‰é—®é¢˜ã€‚è¿˜æ˜¯å…ˆæ”¾ä¸€ä¸‹ä»£ç \r\n\r\n```js\r\n```js\r\nimport Form, { Field } from 'rc-field-form';\r\nimport React from 'react';\r\nimport Input from './components/Input';\r\n\r\ntype FormData = {\r\n  name?: string;\r\n  password?: string;\r\n  password2?: string;\r\n};\r\n\r\nexport default () => {\r\n  const [form] = Form.useForm();\r\n\r\n  return (\r\n    <Form\r\n      form={form}\r\n      preserve={false}\r\n      onFieldsChange={fields => {\r\n        console.error('fields:', fields);\r\n      }}\r\n    >\r\n      <Field<FormData> name=\"name\">\r\n        <Input placeholder=\"Username\" />\r\n      </Field>\r\n\r\n      <Field<FormData> dependencies={['name']}>\r\n        {() => {\r\n          return form.getFieldValue('name') === '1' ? (\r\n            <Field name=\"password\">\r\n              <Input placeholder=\"Password\" />\r\n            </Field>\r\n          ) : null;\r\n        }}\r\n      </Field>\r\n\r\n      <Field dependencies={['password']}>\r\n        {() => {\r\n          const password = form.getFieldValue('password');\r\n          console.log('>>>', password);\r\n          return password ? (\r\n            <Field<FormData> name={['password2']}>\r\n              <Input placeholder=\"Password 2\" />\r\n            </Field>\r\n          ) : null;\r\n        }}\r\n      </Field>\r\n\r\n      <button onClick={()=} type=\"submit\">Submit</button>\r\n    </Form>\r\n  );\r\n};\r\n```\r\né¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨å®˜æ–¹demoä¸­æ¯ä¸ªé…ç½®äº†dependenceçš„Filedå­—æ®µå…¶å®æ˜¯æ²¡æœ‰é…ç½®nameçš„ï¼Œä½†æ˜¯å½“æˆ‘ä»¬æ„å»ºchildrenFieldsæ—¶æ˜¯éœ€è¦è·å–Fieldçš„nameçš„ï¼Œè¿™å°±å¯¼è‡´äº†è·å–childrenFieldså…¶å®æ˜¯è·å–äº†ä¸€ä¸ªç©ºæ•°ç»„ï¼Œè¿™æ ·çœ‹æ¥ï¼Œå¦‚æœå½“å‰name=1,passwordå­˜åœ¨valueï¼Œç„¶åæˆ‘ä»¬æ”¹å˜nameçš„å€¼ï¼Œpasswordå’Œpassword1éƒ½ä¸ä¼šéšè—ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å‘ç°è¿™ä¸ªdemoè¿è¡Œèµ·æ¥å…¶å®æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ã€‚  \r\nå…³é”®åœ¨è¿™é‡Œï¼š\r\n\r\n```js\r\n    this.notifyObservers(prevStore, childrenFields, {\r\n      type: 'dependenciesUpdate',\r\n      relatedFields: [namePath, ...childrenFields],\r\n    });\r\n```\r\næˆ‘ä»¬åœ¨è§¦å‘dependenceæ›´æ–°çš„æ—¶å€™åœ¨relatedFieldsä¸­è¿˜æŠŠè§¦å‘æ›´æ–°çš„Field nameä¼ é€’äº†è¿‡å»ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯'name',æ‰€ä»¥å½“æˆ‘ä»¬è§¦å‘æ‰€æœ‰ç»„ä»¶çš„onStoreChangeï¼Œpasswordæ˜¯èƒ½å¤Ÿæ›´æ–°çš„ï¼Œé‚£password1åˆæ˜¯å¦‚ä½•æ­£ç¡®æ›´æ–°çš„å‘¢ï¼Ÿ\r\n\r\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/81e16c73048f4503b22dc41a989bde02~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=828&h=262&s=141570&e=png&b=222023)\r\nè¿˜è®°å¾—è¿™ä¸ªæ–¹æ³•å—ï¼Œpasswordè¿™ä¸ªFieldåœ¨å¸è½½çš„æ—¶å€™ä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯registerFieldçš„è¿”å›å‡½æ•°ï¼Œè€Œè¿™ä¸ªè¿”å›å‡½æ•°é‡Œåˆè°ƒç”¨äº†`this.triggerDependenciesUpdate(prevStore, namePath);`ï¼Œåé¢çš„æµç¨‹å°±è·Ÿä¸Šé¢ç›¸ä¼¼äº†ã€‚  \r\n# å®Œç»“æ’’èŠ±\r\nå†™äº†è¿™ä¹ˆå¤šç»ˆäºæŠŠrc-field-formçš„ä¸€äº›ä¸»è¦æµç¨‹è®²å®Œäº†ğŸ§ï¼Œç¬¬ä¸€æ¬¡å†™æ–‡ç« å†™çš„çœŸæŒºçƒ‚çš„ï¼Œæœ€åè¿˜æ˜¯å¤§å®¶æ¨èä¸€äº›å…³äºrc-field-formçš„æ–‡ç« ï¼š \r\n- [ä¸€æ¬¡æ‰‹å†™Antd Formçš„ç»å†ï¼Œè®©æˆ‘å—ç›ŠåŒªæµ… - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7038099720400535582)\r\n- [æ‰‹å†™ä¸€ä¸ª Antd4 Form å§ï¼ˆä¸Šç¯‡ï¼‰ï¼šæºç åˆ†æ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7116390485710602254)\r\n- [ğŸ“ä¸­å°è¡¨å•æŠ€æœ¯é€‰å‹å®è·µ(è¡¨å•å®è·µ) - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7316723621292638246)",
      "count": "34k",
      "readingTime": "2:51",
      "imageUrls": [],
      "createdAt": null,
      "updatedAt": null,
      "modified": false
    }
  ]
}